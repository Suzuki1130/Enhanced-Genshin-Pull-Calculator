<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Harry's Genshin Hub</title>
  <link rel="icon" href="Enhanced_Genshin_Pull_Calculator.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // Initialize Chart.js
    document.addEventListener('DOMContentLoaded', function() {
      // Chart will be initialized when needed in the createChart function
      console.log('Chart.js loaded and ready');
    });
  </script>
  <style>
    :root {
      --bg-gradient: #0a0e1a;
      --container-bg: #151923;
      --section-bg: #1a1f2e;
      --text-color: #ffffff;
      --label-color: #b8bcc8;
      --border-color: #2a3142;
      --progress-bg: #2a3142;
      --chart-bg: #1a1f2e;
      --credits-color: #b8bcc8;
      --accent-color: #5b8def;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
      background: var(--bg-gradient);
      min-height: 100vh;
    }

    .container {
      background: var(--container-bg);
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border-color);
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 30px;
      font-size: 2.5em;
      font-weight: 600;
    }

    input, select {
      padding: 10px 12px;
      margin: 8px 0;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.2s, background-color 0.2s;
      background-color: #0f1419;
      color: var(--text-color);
    }

    input:focus, select:focus {
      border-color: var(--accent-color);
      outline: none;
      background-color: #1a1f2e;
    }

    input:hover, select:hover {
      border-color: #3a4152;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: var(--section-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .section h3 {
      margin-top: 0;
      color: var(--text-color);
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 18px;
    }

    label {
      font-weight: 500;
      display: block;
      margin-top: 12px;
      margin-bottom: 6px;
      color: var(--label-color);
      font-size: 14px;
    }

    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    button {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      width: 100%;
      margin-top: 20px;
    }

    button:hover {
      background: #4a7de8;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .results {
      background: var(--section-bg);
      color: var(--text-color);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
      background: var(--chart-bg);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border-color);
    }

    .progress-bar {
      background: var(--progress-bg);
      border-radius: 6px;
      height: 18px;
      margin: 10px 0;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-color);
      border-radius: 6px;
      transition: width 0.3s ease;
    }

    /* Resource breakdown styles for better visibility */
    .cost-breakdown, .primogem-breakdown {
      color: #ffffff;
      font-size: 15px;
      line-height: 1.8;
    }
    
    .cost-breakdown h4 {
      color: #ffffff;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .primogem-breakdown div {
      color: #e8e8e8;
      font-size: 15px;
      margin: 6px 0;
      font-weight: 500;
    }
    
    .primogem-breakdown span,
    .cost-breakdown span {
      color: #ffffff;
      font-weight: 700;
    }
    
    /* Results text visibility */
    .results {
      color: #ffffff;
      font-size: 15px;
    }
    
    .results h3 {
      color: #ffffff;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
    }
    
    .results p {
      color: #e8e8e8;
      font-size: 16px;
      line-height: 1.6;
      margin: 10px 0;
    }
    
    .results ul {
      color: #e8e8e8;
    }
    
    .results li {
      color: #e8e8e8;
      font-size: 15px;
      margin: 8px 0;
      line-height: 1.5;
    }
    
    /* Checkbox wrapper text */
    .checkbox-wrapper label {
      color: #ffffff;
      font-weight: 600;
    }
    
    /* Input and select text */
    input, select {
      color: #ffffff !important;
      font-weight: 500;
    }
    
    input::placeholder {
      color: #999 !important;
    }

    
    /* Calculation spinner styles */
    .calc-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(91, 141, 239, 0.2);
      border-radius: 50%;
      border-top-color: var(--accent-color);
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Improved checkbox styling */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-color);
      margin-right: 8px;
    }
    
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      margin: 12px 0;
    }
    
    .checkbox-wrapper label {
      cursor: pointer;
      user-select: none;
      margin: 0;
    }
    
    .checkbox-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    /* Input hover effects */
    input[type="number"]:hover,
    select:hover {
      border-color: #3a4152;
    }
    
    input[type="number"]:focus,
    select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.1);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .input-group {
        grid-template-columns: 1fr;
      }
      
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.8em;
      }
      
      .main-content {
        margin-left: 0;
        padding-top: 80px;
      }
      
      input, select {
        padding: 14px 12px;
        font-size: 16px;
        min-height: 48px;
      }
      
      button {
        padding: 16px 24px;
        font-size: 16px;
        min-height: 52px;
      }
      
      .section {
        padding: 15px;
      }
      
      .section h3 {
        font-size: 1.2em;
      }
      
      label {
        font-size: 15px;
        margin-top: 14px;
      }
      
      .chart-container {
        height: 300px;
        padding: 10px;
      }
      
      input[type="checkbox"] {
        width: 22px;
        height: 22px;
        min-width: 22px;
        min-height: 22px;
      }
    }
    
    /* Accessibility improvements */
    button:focus, input:focus, select:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Tooltip styles */
    .tooltip-wrapper {
      position: relative;
      display: inline-flex;
      align-items: flex-start;
      gap: 8px;
    }
    
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--border-color);
      color: var(--text-color);
      font-size: 11px;
      font-weight: bold;
      cursor: help;
      transition: all 0.3s ease;
      user-select: none;
    }
    
    .tooltip-icon:hover {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }
    
    .tooltip {
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--section-bg);
      color: var(--text-color);
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      width: 280px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--border-color);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
      pointer-events: none;
    }
    
    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--section-bg);
    }
    
    .tooltip-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    
    /* FatePoints guaranteed styling */
    .fate-points-guaranteed {
      color: #2ecc71 !important;
      font-weight: bold !important;
    }
    
    .fate-points-guaranteed:focus {
      border-color: #2ecc71 !important;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3) !important;
    }
    
    /* Character guaranteed styling */
    .character-guaranteed {
      color: #2ecc71 !important;
      font-weight: bold !important;
    }
    
    .character-guaranteed:focus {
      border-color: #2ecc71 !important;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3) !important;
    }
    
    /* Radiance Pity guaranteed styling */
    .radiance-pity-guaranteed {
      color: #2ecc71 !important;
      font-weight: bold !important;
    }
    
    .radiance-pity-guaranteed:focus {
      border-color: #2ecc71 !important;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3) !important;
    }
    
    /* Version and changelog styles */
    .version-info {
      text-align: center;
      margin-top: 30px;
      padding: 15px;
      color: var(--credits-color);
      font-size: 14px;
    }
    
    .version-link {
      color: var(--text-color);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }
    
    .version-link:hover {
      color: #667eea;
      text-decoration: underline;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-content {
      background: var(--container-bg);
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .close {
      color: var(--text-color);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .close:hover {
      color: #667eea;
    }
    
    .changelog-item {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--section-bg);
      border-radius: 8px;
      border-left: 3px solid #667eea;
    }
    
    .changelog-version {
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 5px;
    }
    
    .changelog-date {
      font-size: 12px;
      color: var(--label-color);
      margin-bottom: 8px;
    }
    
    .changelog-changes {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-color);
    }
    
    .changelog-changes li {
      margin-bottom: 3px;
      color: var(--text-color);
    }
    
    .changelog-changes ul {
      color: var(--text-color);
    }
    
    @media (max-width: 768px) {
      .tooltip {
        width: 250px;
        font-size: 12px;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 20px;
      }
    }
    
    /* Sidebar and Navigation Styles */
    .sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100vh;
      background: #0f1419;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
      border-right: 1px solid var(--border-color);
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      color: white;
    }
    
    .sidebar-header img {
      width: 40px;
      height: 40px;
      margin-right: 15px;
      border-radius: 6px;
    }
    
    .sidebar-header h2 {
      margin: 0;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    .nav-menu {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }
    
    .nav-item {
      margin: 0;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--label-color);
      text-decoration: none;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      font-size: 14px;
    }
    
    .nav-link:hover {
      color: white;
      background: rgba(91, 141, 239, 0.1);
      border-left-color: var(--accent-color);
    }
    
    .nav-link.active {
      color: white;
      background: rgba(91, 141, 239, 0.15);
      border-left-color: var(--accent-color);
    }
    
    .nav-link i {
      width: 20px;
      margin-right: 10px;
      font-size: 16px;
    }
    
    .language-selector {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
    }
    
    .language-selector select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #1a1f2e;
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .language-selector select:hover {
      border-color: var(--accent-color);
    }
    
    .language-selector select:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.1);
    }
    
    .language-selector select option {
      background: #1a1f2e;
      color: #ffffff;
      padding: 8px;
    }
    
    
    .main-content {
      margin-left: 0;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }
    
    /* Desktop styles */
    @media (min-width: 769px) {
      .sidebar {
        left: 0 !important; /* Force sidebar visible on desktop */
        transform: translateX(0) !important; /* Override any transforms */
      }
      
      .sidebar.active {
        left: 0 !important; /* Ensure active class doesn't interfere */
      }
      
      .main-content {
        margin-left: 250px;
      }
      
    }
    
    /* Page content containers */
    .page-content {
      display: none;
      padding: 20px;
      min-height: calc(100vh - 40px);
      background: transparent;
      margin: 0;
    }

    /* Sidebar toggle controls */
    .sidebar-toggle {
      margin-left: auto;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 10px;
      border-radius: 4px;
      cursor: pointer;
      width: auto !important;
      margin-top: 0 !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 36px;
      line-height: 1;
      font-size: 18px;
    }

    .floating-toggle {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: #667eea;
      color: white;
      border: none;
      border-radius: 0 6px 6px 0;
      padding: 10px 12px;
      z-index: 1100;
      display: none;
      width: auto !important;
      margin-top: 0 !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      line-height: 1;
      font-size: 20px;
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
    }

    @media (min-width: 769px) {
      .floating-toggle { display: none !important; }
    }

    @media (max-width: 768px) {
      .floating-toggle { display: block; }
    }
    
    .page-content.active {
      display: block !important;
    }

    /* Starglitter checkbox layout */
    .checkbox-stack {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      margin-top: 10px;
    }
    .checkbox-stack label {
      margin-top: 0;
    }
    
    /* Home page specific styles */
    .hero-section {
      text-align: center;
      padding: 40px 0;
      background: var(--section-bg);
      color: var(--text-color);
      border-radius: 8px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
    }
    
    .hero-section h1 {
      font-size: 2.5em;
      margin-bottom: 15px;
      color: var(--text-color);
      font-weight: 600;
    }
    
    .hero-section p {
      font-size: 1.1em;
      color: var(--label-color);
      max-width: 600px;
      margin: 0 auto;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .feature-card {
      background: var(--section-bg);
      padding: 25px;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.2s ease, border-color 0.2s ease;
      border: 1px solid var(--border-color);
    }
    
    .feature-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-color);
    }
    
    .feature-icon {
      font-size: 2.5em;
      margin-bottom: 15px;
    }
    
    .feature-card h3 {
      color: var(--text-color);
      margin-bottom: 15px;
      font-size: 1.3em;
      font-weight: 600;
    }
    
    .feature-card p {
      color: var(--label-color);
      font-size: 0.95em;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .feature-card button {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: auto;
      margin-top: 0;
    }
    
    .feature-card button:hover {
      background: #4a7de8;
    }
    
  /* Blog page styles */
  .blog-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .blog-header h1 {
    color: var(--text-color);
    font-size: 2.5em;
    margin-bottom: 15px;
    font-weight: 600;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .blog-divider {
    width: 80px;
    height: 4px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    margin: 0 auto;
    border-radius: 2px;
  }
  
  .operator-profile,
  .creator-profile {
    background: linear-gradient(135deg, var(--section-bg) 0%, rgba(168, 85, 247, 0.05) 100%);
    border-radius: 12px;
    margin-bottom: 40px;
    border-left: 4px solid #a855f7;
    box-shadow: 0 8px 25px rgba(168, 85, 247, 0.15);
    position: relative;
    overflow: hidden;
  }
  
  .creator-profile::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(45deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1));
    border-radius: 50%;
    transform: translate(30px, -30px);
  }
  
  .profile-header {
    padding: 20px 30px 15px 30px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
  }
  
  .profile-header h3 {
    color: #a855f7;
    margin: 0;
    font-size: 1.3em;
    font-weight: 600;
  }
  
  .profile-header i {
    color: #a855f7;
    font-size: 1.2em;
  }
  
  .profile-content {
    padding: 25px 30px;
  }
  
  .profile-item {
    display: flex;
    margin-bottom: 15px;
    align-items: flex-start;
    gap: 15px;
  }
  
  .profile-item:last-child {
    margin-bottom: 0;
  }
  
  .profile-label {
    font-weight: 600;
    color: var(--label-color);
    min-width: 140px;
    flex-shrink: 0;
  }
  
  .profile-value {
    color: var(--text-color);
    line-height: 1.4;
    flex-grow: 1;
  }
  
  .profile-note {
    margin-top: 5px;
    padding: 8px 12px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 6px;
    font-size: 0.9em;
    color: var(--label-color);
    border-left: 3px solid #667eea;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .profile-note i {
    color: #667eea;
    font-size: 0.9em;
  }
  
  .blog-posts {
    display: flex;
    flex-direction: column;
    gap: 25px;
  }
  
  .blog-article {
    background: var(--section-bg);
    border-radius: 12px;
    padding: 25px;
    border-left: 4px solid #667eea;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .blog-article:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
  
  .blog-article h4 {
    color: var(--text-color);
    font-size: 1.3em;
    font-weight: 600;
    margin: 0 0 12px 0;
    line-height: 1.4;
  }
  
  .article-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  
  .article-date,
  .article-author {
    font-size: 0.9em;
    color: var(--label-color);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .article-summary {
    color: var(--text-color);
    line-height: 1.6;
    margin-bottom: 15px;
    font-size: 0.95em;
  }
  
  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
  }
  
  .tag {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    font-size: 0.8em;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }
  
  .read-more {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95em;
    transition: color 0.3s ease;
    display: inline-flex;
    align-items: center;
  }
  
  .read-more:hover {
    color: #5a67d8;
    text-decoration: underline;
  }
  
  .author-intro {
    background: var(--section-bg);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 20px;
  }
  
  .author-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .author-info h2 {
    color: var(--text-color);
    margin-bottom: 10px;
  }
  
  .author-info p {
    color: var(--label-color);
    line-height: 1.6;
  }
    
    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
        padding-top: 80px;
      }
      
      .sidebar {
        left: -250px;
      }
      
      .sidebar.active {
        left: 0;
      }
      
      .author-intro {
        flex-direction: column;
        text-align: center;
      }
      
      .hero-section h1 {
        font-size: 2em;
      }
      
      .profile-item {
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
      }
      
      .profile-label {
        min-width: auto;
      }
      
      .article-meta {
        flex-direction: column;
        gap: 8px;
      }
      
      .blog-header h1 {
        font-size: 2em;
      }
      
      .blog-article {
        padding: 20px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Logo">
      <h2>Harry's Hub</h2>
      <button id="sidebarToggleBtn" class="sidebar-toggle" aria-label="Toggle sidebar"><span id="sidebarToggleIcon">&lt;</span></button>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="#home" class="nav-link active" data-page="home"><i class="fas fa-home"></i> <span class="i18n" data-key="home">Home</span></a></li>
      <li class="nav-item"><a href="#calculator" class="nav-link" data-page="calculator"><i class="fas fa-calculator"></i> <span class="i18n" data-key="calculator">Calculator</span></a></li>
    </ul>
    <div class="language-selector">
        <select id="languageSelector" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="es">Espa√±ol</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="pt">Portugu√™s</option>
        </select>
    </div>
  </div>

  <button id="floatingSidebarToggle" class="floating-toggle" aria-label="Open sidebar">&gt;</button>

  <div class="main-content">
    <!-- Home Page -->
    <div id="homePage" class="page-content active">
      <div class="container">
        <div class="hero-section">
          <h1 class="i18n" data-key="welcomeTitle">Welcome to Harry's Genshin Hub</h1>
          <p class="i18n" data-key="welcomeSubtitle">Your ultimate destination for Genshin Impact calculations, insights, and resources</p>
        </div>
        
        <!-- Creator's Profile -->
        <div class="creator-profile">
          <div class="profile-header">
            <i class="fas fa-user-circle" style="margin-right: 10px;"></i>
            <h3>Creator's Profile</h3>
          </div>
          <div class="profile-content">
            <div class="profile-item">
              <span class="profile-label">Name:</span>
              <span class="profile-value">Harry</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Playing Since:</span>
              <span class="profile-value">Version 1.6</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Favorite Character:</span>
              <span class="profile-value">Columbina (Damselette)</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Current Goal:</span>
              <span class="profile-value">Saving Pulls For Columbina</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Location:</span>
              <span class="profile-value">I'm a Student Living In Japan</span>
            </div>
          </div>
        </div>
        
        <div class="feature-grid">
          <div class="feature-card">
            <div class="feature-icon">üìä</div>
            <h3 class="i18n" data-key="calculatorTitle">Pull Calculator</h3>
            <p class="i18n" data-key="calculatorDesc">Advanced probability calculations with Radiance Pity support and Monte Carlo simulations</p>
            <button onclick="showPage('calculator')" class="i18n" data-key="tryCalculator">Try Calculator</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculator Page -->
    <div id="calculatorPage" class="page-content">
      <div id="mainContainer" class="container">
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Enhanced Genshin Pull Calculator Logo" style="height: 80px; margin-right: 15px;">
      <h1 style="margin: 0;">Enhanced Genshin Pull Calculator</h1>
    </div>
      <div class="credits" style="text-align: center; font-size: 0.9em; margin-bottom: 10px; color: var(--credits-color);">
        Made by Harry
      </div>
      <div class="version-info" style="text-align: center; font-size: 0.8em; margin-bottom: 20px; color: var(--credits-color);">
        <a href="javascript:void(0);" class="version-link" onclick="openChangelogModal(); return false;"><i class="fas fa-history" style="margin-right: 5px;"></i>Version 6.1</a>
      </div>

    <div class="section">
      <h3>Resources</h3>
      <div class="input-group">
        <div>
          <label for="primos">Primogems:</label>
          <input type="number" id="primos" value="0" min="0" max="999999" step="1" oninput="validateAndUpdateResources(this)">
        </div>
        <div>
          <label for="fates">Intertwined Fates:</label>
          <input type="number" id="fates" value="0" min="0" max="9999" step="1" oninput="validateAndUpdateResources(this)">
        </div>
        <div>
          <label for="genesis">Genesis Crystals:</label>
          <input type="number" id="genesis" value="0" min="0" max="999999" step="1" oninput="validateAndUpdateResources(this)">
        </div>
      </div>
      <div class="checkbox-wrapper checkbox-stack">
        <label for="useStarglitter">Use starglitter for pulls</label>
        <input type="checkbox" id="useStarglitter" onchange="updateResourceSummary()">
      </div>
      
      <div style="margin-top: 15px;">
        <label style="margin-bottom: 8px; display: block; font-size: 13px; color: var(--label-color);">Quick Presets:</label>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="setQuickPreset(90)" style="width: auto; margin: 0; padding: 8px 14px; font-size: 13px;">90 pulls (1 pity)</button>
          <button onclick="setQuickPreset(180)" style="width: auto; margin: 0; padding: 8px 14px; font-size: 13px;">180 pulls (guaranteed)</button>
          <button onclick="setQuickPreset(360)" style="width: auto; margin: 0; padding: 8px 14px; font-size: 13px;">360 pulls (C1)</button>
          <button onclick="setQuickPreset(0)" style="width: auto; margin: 0; padding: 8px 14px; font-size: 13px; background: #dc3545;">Clear</button>
        </div>
      </div>
      
      <div id="resourceSummary" class="cost-breakdown">
        <h4>Total Available Pulls: <span id="totalPulls">0</span></h4>
        <div class="primogem-breakdown">
          <div>Primos: <span id="primoPulls">0</span> pulls</div>
          <div>Fates: <span id="fatePulls">0</span> pulls</div>
          <div>Genesis: <span id="genesisPulls">0</span> pulls</div>
        </div>
        <div>Starglitter Pulls: <span id="starglitterPulls">0</span></div>
      </div>
    </div>


    <div class="section">
      <h3>Character Banner Goals</h3>
      <div class="checkbox-wrapper">
        <input type="checkbox" id="wantCharacter" onchange="toggleCharacterInputs()" checked>
        <label for="wantCharacter">I want to pull for a character</label>
      </div>
      <div id="characterInputs">
        <div class="input-group">
          <div>
            <label for="constellations">Constellation Goal:</label>
            <select id="constellations" onchange="autoCalculate()">
              <option value="0">C0 (Base Character)</option>
              <option value="1">C1</option>
              <option value="2">C2</option>
              <option value="3">C3</option>
              <option value="4">C4</option>
              <option value="5">C5</option>
              <option value="6">C6</option>
            </select>
          </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="charPity">Character Pity:</label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Soft Pity:</strong> 5‚òÖ pull rates increase significantly after pull 73. The base 0.6% rate increases gradually up to 100% at pull 90 (hard pity). Most 5‚òÖ characters are obtained between pulls 76-82.
              </div>
            </span>
          </div>
          <input type="number" id="charPity" min="0" max="89" value="0" oninput="updatePityProgress()">
          <div class="progress-bar">
            <div id="charPityProgress" class="progress-fill" style="width: 0%"></div>
          </div>
          <div id="charPityWarning" style="display: none; margin-top: 8px; padding: 8px 12px; background: rgba(255, 193, 7, 0.15); border-left: 3px solid #ffc107; border-radius: 4px; font-size: 13px; color: #ffc107;"></div>
        </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="charGuaranteed">Next Character Guaranteed?</label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Guaranteed:</strong> When you get a 5‚òÖ character, there's a 50% chance it's the featured character (winning the 50/50). If you lose and get a standard 5‚òÖ, your next 5‚òÖ character is guaranteed to be the featured one.
              </div>
            </span>
          </div>
          <select id="charGuaranteed" onchange="updateCharGuaranteedDisplay()">
            <option value="false">No (50/50)</option>
            <option value="true">Yes (Guaranteed)</option>
          </select>
        </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="radiancePity">Radiance Pity: <span id="radiancePityDisplay">0 / 3</span></label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Radiance Pity:</strong> Modifies the 50/50 chance on Character Event banners. Base chance is 50%, increased to ~55% after 1 loss, ~75% after 2 losses, and guaranteed at 3 losses. Counter resets after a win or guarantee. Not applicable to Weapon or Standard banners.
              </div>
            </span>
          </div>
          <select id="radiancePity" onchange="updateRadiancePityDisplay()">
            <option value="0">0 consecutive losses (50% chance)</option>
            <option value="1">1 consecutive loss (~55% chance)</option>
            <option value="2">2 consecutive losses (~75% chance)</option>
            <option value="3">3 consecutive losses (100% guaranteed)</option>
          </select>
        </div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>Weapon Banner Goals</h3>
      <div class="checkbox-wrapper">
        <input type="checkbox" id="wantWeapon" onchange="toggleWeaponInputs()">
        <label for="wantWeapon">I want to pull for a weapon</label>
      </div>
      <div id="weaponInputs" style="display: none;">
        <div class="input-group">
          <div>
            <label for="refinements">Refinement Goal:</label>
            <select id="refinements" onchange="autoCalculate()">
              <option value="0">R1 (Base Weapon)</option>
              <option value="1">R2</option>
              <option value="2">R3</option>
              <option value="3">R4</option>
              <option value="4">R5</option>
            </select>
          </div>
          <div>
            <label for="weapPity">Weapon Pity:</label>
            <input type="number" id="weapPity" min="0" max="79" value="0" oninput="updatePityProgress()">
            <div class="progress-bar">
              <div id="weapPityProgress" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="weapPityWarning" style="display: none; margin-top: 8px; padding: 8px 12px; background: rgba(255, 193, 7, 0.15); border-left: 3px solid #ffc107; border-radius: 4px; font-size: 13px; color: #ffc107;"></div>
          </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="fatepoints">Fate Points:</label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Fate Points:</strong> Part of the Epitomized Path system. Each time you get a 5‚òÖ weapon that isn't your selected target, you gain 1 Fate Point. At 1 Fate Point, your next 5‚òÖ weapon is guaranteed to be your selected target. Points reset when you get the target weapon or change banners.
              </div>
            </span>
          </div>
          <select id="fatepoints" onchange="updateFatePointsDisplay()" aria-label="Fate points selector">
            <option value="0">Fate Points 0/1</option>
            <option value="1">Fate Points 1/1 (Guaranteed)</option>
          </select>
        </div>
        </div>
      </div>
    </div>


    <div id="calculationStatus" style="display: none; text-align: center; padding: 15px; margin: 20px 0; background: var(--section-bg); border-radius: 8px; border: 1px solid var(--border-color);">
      <div style="display: inline-flex; align-items: center; gap: 10px; color: var(--accent-color);">
        <div class="calc-spinner"></div>
        <span>Calculating probabilities...</span>
      </div>
    </div>

    <div id="results"></div>

    <div class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
        <h3 style="margin: 0;">Probability Chart</h3>
        <div class="chart-toggle-container" style="display: flex; align-items: center; gap: 15px;">
          <span style="color: var(--label-color); font-weight: 600;">Chart Type:</span>
          <div class="chart-toggle-switch">
            <input type="radio" id="chartCharacter" name="chartType" value="character" checked onchange="updateChart()">
            <label for="chartCharacter" style="margin: 0 8px 0 4px; font-weight: 500;">Character</label>
            <input type="radio" id="chartWeapon" name="chartType" value="weapon" onchange="updateChart()">
            <label for="chartWeapon" style="margin: 0 0 0 4px; font-weight: 500;">Weapon</label>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="resultsChart"></canvas>
      </div>
    </div>
    
    <!-- Save/Load/Export Configuration section removed in v6.1 -->
    
    
    <!-- Changelog Modal -->
    <div id="changelogModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeChangelogModal()">&times;</span>
        <h2 style="color: var(--text-color); margin-top: 0;">Changelog</h2>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 6.1</div>
          <div class="changelog-date">November 22, 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>üì± Added mobile sidebar toggle with floating button</li>
              <li>üîß Replaced Stardust/Starglitter inputs with a Starglitter-to-pulls button</li>
              <li>üßπ Removed Save/Load/Export configuration and CSV export</li>
              <li>üéØ Simplified Analysis Mode to Monte Carlo only</li>
              <li>üß™ Restricted Simulation Count to 100,000 (default)</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.8</div>
          <div class="changelog-date">August 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>‚ú® Added rich tooltips with detailed explanations for key mechanics</li>
              <li>üé® Enhanced dark mode with better theme persistence</li>
              <li>üì± Improved mobile responsiveness and layout</li>
              <li>üíæ Added automatic input persistence using localStorage</li>
              <li>üìä Enhanced probability charts with better visualization</li>
              <li>üîÑ Added version tracking and changelog modal</li>
              <li>üîß Fixed duplicate mechanics: removed outdated Capturing Radiance, kept unified Radiance Pity system</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.7</div>
          <div class="changelog-date">July 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>üéØ Added Radiance Pity system for v5.0+ mechanics</li>
              <li>‚ö° Improved Monte Carlo simulation performance</li>
              <li>üìä Enhanced chart rendering with better error handling</li>
              <li>üîß Bug fixes for edge cases in probability calculations</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.6</div>
          <div class="changelog-date">June 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>üé≤ Added comprehensive Monte Carlo simulation system</li>
              <li>üìä Implemented Chart.js for probability distribution graphs</li>
              <li>üí∞ Enhanced resource calculation with multiple currency types</li>
              <li>‚öôÔ∏è Added save/load configuration functionality</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.5</div>
          <div class="changelog-date">May 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>üèπ Initial weapon banner support with Epitomized Path</li>
              <li>üéØ Added soft pity calculations for character and weapon banners</li>
              <li>üì± Basic responsive design implementation</li>
              <li>üé® Modern UI with gradient backgrounds and animations</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Changelog Page -->
    <div id="changelogPage" class="page-content">
      <div class="container">
        <div class="blog-header">
          <h1>üìù Changelog & Updates</h1>
          <div class="blog-divider"></div>
        </div>
        
        <!-- Changelog Entries -->
        <div class="changelog-list">
          <div class="changelog-item">
            <div class="changelog-version">Version 6.1</div>
            <div class="changelog-date">November 22, 2025</div>
            <div class="changelog-changes">
              <ul>
                <li>üì± Added mobile sidebar toggle with floating button</li>
                <li>üîß Replaced Stardust/Starglitter inputs with a Starglitter-to-pulls button</li>
                <li>üßπ Removed Save/Load/Export configuration and CSV export</li>
                <li>üéØ Simplified Analysis Mode to Monte Carlo only</li>
                <li>üß™ Restricted Simulation Count to 100,000 (default)</li>
              </ul>
            </div>
          </div>
          <div class="changelog-item">
            <div class="changelog-version">Version 5.8</div>
            <div class="changelog-date">January 15, 2025</div>
            <div class="changelog-changes">
              <ul>
                <li>‚ú® Added rich tooltips with detailed explanations for key mechanics</li>
                <li>üé® Enhanced dark mode with better theme persistence</li>
                <li>üì± Improved mobile responsiveness and layout</li>
                <li>üíæ Added automatic input persistence using localStorage</li>
                <li>üìä Enhanced probability charts with better visualization</li>
                <li>üîÑ Added version tracking and changelog modal</li>
                <li>üîß Fixed duplicate mechanics: removed outdated Capturing Radiance, kept unified Radiance Pity system</li>
              </ul>
            </div>
          </div>
          
          <div class="changelog-item">
            <div class="changelog-version">Version 5.7</div>
            <div class="changelog-date">December 28, 2024</div>
            <div class="changelog-changes">
              <ul>
                <li>üéØ Added Radiance Pity system for v5.0+ mechanics</li>
                <li>‚ö° Improved Monte Carlo simulation performance</li>
                <li>üìä Enhanced chart rendering with better error handling</li>
                <li>üîß Bug fixes for edge cases in probability calculations</li>
              </ul>
            </div>
          </div>
          
          <div class="changelog-item">
            <div class="changelog-version">Version 5.6</div>
            <div class="changelog-date">November 20, 2024</div>
            <div class="changelog-changes">
              <ul>
                <li>üé≤ Added comprehensive Monte Carlo simulation system</li>
                <li>üìä Implemented Chart.js for probability distribution graphs</li>
                <li>üí∞ Enhanced resource calculation with multiple currency types</li>
                <li>‚öôÔ∏è Added save/load configuration functionality</li>
              </ul>
            </div>
          </div>
        </div>
        
      </div>
    </div>

  </div>
</div>
<script>

function showPage(pageName) {
  console.log("Switching to page:", pageName);
  
  // Hide all pages
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
    console.log("Hiding page:", page.id);
  });
  
  // Show selected page
  const targetPage = document.getElementById(pageName + 'Page');
  if (targetPage) {
    targetPage.classList.add('active');
    console.log("Showing page:", targetPage.id, "Classes:", targetPage.className);
    
    // Changelog page is now simplified, no initialization needed
  } else {
    console.error("Page not found:", pageName + 'Page');
  }
  
  // Update navigation
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  const activeLink = document.querySelector(`[data-page="${pageName}"]`);
  if (activeLink) {
    activeLink.classList.add('active');
  }
  
  // Close sidebar on mobile after navigation and update toggle
  if (window.innerWidth <= 768) {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.remove('active');
    if (typeof updateSidebarToggleState === 'function') {
      updateSidebarToggleState();
    }
  }
}

// Sidebar toggle handlers
function updateSidebarToggleState() {
  const sidebar = document.querySelector('.sidebar');
  const isActive = sidebar.classList.contains('active') || window.innerWidth >= 769;
  const icon = document.getElementById('sidebarToggleIcon');
  const floatBtn = document.getElementById('floatingSidebarToggle');
  if (icon) icon.textContent = isActive ? '<' : '>';
  if (floatBtn) {
    if (window.innerWidth <= 768) {
      floatBtn.style.display = isActive ? 'none' : 'block';
    } else {
      floatBtn.style.display = 'none';
    }
  }
}

function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('active');
  }
  updateSidebarToggleState();
}

document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('sidebarToggleBtn');
  const floatBtn = document.getElementById('floatingSidebarToggle');
  if (toggleBtn) toggleBtn.addEventListener('click', toggleSidebar);
  if (floatBtn) floatBtn.addEventListener('click', toggleSidebar);
  updateSidebarToggleState();
});

window.addEventListener('resize', updateSidebarToggleState);

function changeLanguage(lang) {
  window.currentLanguage = lang;
  localStorage.setItem('selectedLanguage', lang);
  
  // Update all translation elements
  document.querySelectorAll('.i18n').forEach(element => {
    const key = element.getAttribute('data-key');
    if (window.translations && window.translations[lang] && window.translations[lang][key]) {
      if (element.tagName === 'INPUT' && element.type === 'button') {
        element.value = window.translations[lang][key];
      } else {
        element.textContent = window.translations[lang][key];
      }
    }
  });
  
  // Update language selector
  const languageSelector = document.getElementById('languageSelector');
  if (languageSelector) {
    languageSelector.value = lang;
  }
  // Only update settings language selector if it exists
  const settingsLanguage = document.getElementById('settingsLanguage');
  if (settingsLanguage) {
    settingsLanguage.value = lang;
  }
}

// Multi-language support
const translations = {
  en: {
    home: 'Home',
    calculator: 'Calculator',
    blog: 'Blog',
    changelog: 'Changelog',
    settings: 'Settings',
    welcomeTitle: 'Welcome to Harry\'s Genshin Hub',
    welcomeSubtitle: 'Your ultimate destination for Genshin Impact calculations, insights, and resources',
    calculatorTitle: 'Pull Calculator',
    calculatorDesc: 'Advanced probability calculations with Radiance Pity support and Monte Carlo simulations',
    tryCalculator: 'Try Calculator',
    blogTitle: 'Blog & Insights',
    blogDesc: 'Tips, guides, and analysis of Genshin Impact mechanics and meta',
    readBlog: 'Read Blog',
    readChangelog: 'View Changelog',
    settingsTitle: 'Settings',
    settingsDesc: 'Customize your experience with theme and language preferences',
    openSettings: 'Open Settings',
    aboutHarry: 'About Harry',
    harryBio: 'Passionate Genshin Impact player and developer with a love for mathematics and probability theory. I created this calculator to help fellow Travelers make informed decisions about their wish strategies. When I\'m not coding, you can find me exploring Teyvat and theorycrafting optimal team compositions.',
    recentPosts: 'Recent Posts',
    appearance: 'Appearance',
    themeLabel: 'Theme:',
    language: 'Language',
    selectLanguage: 'Select Language:',
    dataManagement: 'Data Management',
    clearAllData: 'Clear All Data',
    clearDataDesc: 'Remove all saved configurations and preferences',
    exportData: 'Export All Data',
    exportDataDesc: 'Download all your data as a backup file',
    about: 'About',
    appDescription: 'Harry\'s Genshin Hub is an advanced probability calculator for Genshin Impact wish mechanics, featuring Radiance Pity support, Monte Carlo simulations, and comprehensive analysis tools.',
    version: 'Version:',
    developer: 'Developer:'
  },
  ja: {
    home: '„Éõ„Éº„É†',
    calculator: 'Ë®àÁÆóÊ©ü',
    blog: '„Éñ„É≠„Ç∞',
    changelog: 'Â§âÊõ¥Â±•Ê≠¥',
    settings: 'Ë®≠ÂÆö',
    welcomeTitle: '„Éè„É™„Éº„ÅÆÂéüÁ•û„Éè„Éñ„Å∏„Çà„ÅÜ„Åì„Åù',
    welcomeSubtitle: 'ÂéüÁ•û„ÅÆË®àÁÆó„ÄÅÊ¥ûÂØü„ÄÅ„É™„ÇΩ„Éº„Çπ„ÅÆÁ©∂Ê•µ„ÅÆÁõÆÁöÑÂú∞',
    calculatorTitle: 'Á•àÈ°òË®àÁÆóÊ©ü',
    calculatorDesc: '„É©„Éá„Ç£„Ç¢„É≥„ÇπÂ§©‰∫ï„Çµ„Éù„Éº„Éà„Å®„É¢„É≥„ÉÜ„Ç´„É´„É≠„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Å´„Çà„ÇãÈ´òÂ∫¶„Å™Á¢∫ÁéáË®àÁÆó',
    tryCalculator: 'Ë®àÁÆóÊ©ü„ÇíË©¶„Åô',
    blogTitle: '„Éñ„É≠„Ç∞„ÉªÊ¥ûÂØü',
    blogDesc: 'ÂéüÁ•û„ÅÆ„É°„Ç´„Éã„ÇØ„Çπ„Å®„É°„Çø„ÅÆ„Éí„É≥„Éà„ÄÅ„Ç¨„Ç§„Éâ„ÄÅÂàÜÊûê',
    readBlog: '„Éñ„É≠„Ç∞„ÇíË™≠„ÇÄ',
    readChangelog: 'Â§âÊõ¥Â±•Ê≠¥„ÇíË¶ã„Çã',
    settingsTitle: 'Ë®≠ÂÆö',
    settingsDesc: '„ÉÜ„Éº„Éû„Å®Ë®ÄË™ûË®≠ÂÆö„Åß„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫',
    openSettings: 'Ë®≠ÂÆö„ÇíÈñã„Åè',
    aboutHarry: '„Éè„É™„Éº„Å´„Å§„ÅÑ„Å¶',
    harryBio: 'Êï∞Â≠¶„Å®Á¢∫ÁéáË´ñ„ÇíÊÑõ„Åô„ÇãÊÉÖÁÜ±ÁöÑ„Å™ÂéüÁ•û„Éó„É¨„Ç§„É§„ÉºÂÖºÈñãÁô∫ËÄÖ„Åß„Åô„ÄÇ‰ª≤Èñì„ÅÆÊóÖ‰∫∫„ÅåÁ•àÈ°òÊà¶Áï•„Å´„Å§„ÅÑ„Å¶ÂçÅÂàÜ„Å™ÊÉÖÂ†±„Å´Âü∫„Å•„ÅÑ„ÅüÊ±∫ÂÆö„Çí‰∏ã„Åõ„Çã„Çà„ÅÜ„ÄÅ„Åì„ÅÆË®àÁÆóÊ©ü„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Çí„Åó„Å¶„ÅÑ„Å™„ÅÑÊôÇ„ÅØ„ÄÅ„ÉÜ„Ç§„ÉØ„ÉÉ„Éà„ÇíÊé¢Á¥¢„Åó„ÄÅÊúÄÈÅ©„Å™„ÉÅ„Éº„É†ÊßãÊàê„ÇíÁêÜË´ñÊßãÁØâ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
    recentPosts: 'ÊúÄÊñ∞„ÅÆÊäïÁ®ø',
    appearance: 'Â§ñË¶≥',
    themeLabel: '„ÉÜ„Éº„Éû:',
    language: 'Ë®ÄË™û',
    selectLanguage: 'Ë®ÄË™û„ÇíÈÅ∏Êäû:',
    dataManagement: '„Éá„Éº„ÇøÁÆ°ÁêÜ',
    clearAllData: '„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§',
    clearDataDesc: '‰øùÂ≠ò„Åï„Çå„Åü„Åô„Åπ„Å¶„ÅÆÊßãÊàê„Å®Ë®≠ÂÆö„ÇíÂâäÈô§',
    exportData: '„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
    exportDataDesc: '„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',
    about: '„Å´„Å§„ÅÑ„Å¶',
    appDescription: '„Éè„É™„Éº„ÅÆÂéüÁ•û„Éè„Éñ„ÅØ„ÄÅ„É©„Éá„Ç£„Ç¢„É≥„ÇπÂ§©‰∫ï„Çµ„Éù„Éº„Éà„ÄÅ„É¢„É≥„ÉÜ„Ç´„É´„É≠„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÄÅÂåÖÊã¨ÁöÑ„Å™ÂàÜÊûê„ÉÑ„Éº„É´„ÇíÁâπÂæ¥„Å®„Åô„ÇãÂéüÁ•ûÁ•àÈ°ò„É°„Ç´„Éã„ÇØ„ÇπÁî®„ÅÆÈ´òÂ∫¶„Å™Á¢∫ÁéáË®àÁÆóÊ©ü„Åß„Åô„ÄÇ',
    version: '„Éê„Éº„Ç∏„Éß„É≥:',
    developer: 'ÈñãÁô∫ËÄÖ:'
  },
  es: {
    home: 'Inicio',
    calculator: 'Calculadora',
    blog: 'Blog',
    changelog: 'Registro de cambios',
    settings: 'Configuraci√≥n',
    welcomeTitle: 'Bienvenido al Hub Genshin de Harry',
    welcomeSubtitle: 'Tu destino definitivo para c√°lculos, perspectivas y recursos de Genshin Impact',
    calculatorTitle: 'Calculadora de Deseos',
    calculatorDesc: 'C√°lculos de probabilidad avanzados con soporte de Radiance Pity y simulaciones Monte Carlo',
    tryCalculator: 'Probar Calculadora',
    blogTitle: 'Blog y Perspectivas',
    blogDesc: 'Consejos, gu√≠as y an√°lisis de mec√°nicas y meta de Genshin Impact',
    readBlog: 'Leer Blog',
    readChangelog: 'Ver Registro de cambios',
    settingsTitle: 'Configuraci√≥n',
    settingsDesc: 'Personaliza tu experiencia con preferencias de tema e idioma',
    openSettings: 'Abrir Configuraci√≥n',
    aboutHarry: 'Acerca de Harry',
    harryBio: 'Jugador apasionado de Genshin Impact y desarrollador con amor por las matem√°ticas y la teor√≠a de probabilidades. Cre√© esta calculadora para ayudar a mis compa√±eros Viajeros a tomar decisiones informadas sobre sus estrategias de deseos. Cuando no estoy programando, puedes encontrarme explorando Teyvat y teorizando composiciones √≥ptimas de equipos.',
    recentPosts: 'Publicaciones Recientes',
    appearance: 'Apariencia',
    themeLabel: 'Tema:',
    language: 'Idioma',
    selectLanguage: 'Seleccionar Idioma:',
    dataManagement: 'Gesti√≥n de Datos',
    clearAllData: 'Borrar Todos los Datos',
    clearDataDesc: 'Eliminar todas las configuraciones y preferencias guardadas',
    exportData: 'Exportar Todos los Datos',
    exportDataDesc: 'Descargar todos tus datos como archivo de respaldo',
    about: 'Acerca de',
    appDescription: 'El Hub Genshin de Harry es una calculadora de probabilidad avanzada para las mec√°nicas de deseos de Genshin Impact, con soporte de Radiance Pity, simulaciones Monte Carlo y herramientas de an√°lisis integral.',
    version: 'Versi√≥n:',
    developer: 'Desarrollador:'
  },
  zh: {
    home: 'È¶ñÈ°µ',
    calculator: 'ËÆ°ÁÆóÂô®',
    blog: 'ÂçöÂÆ¢',
    changelog: 'Êõ¥Êñ∞Êó•Âøó',
    settings: 'ËÆæÁΩÆ',
    welcomeTitle: 'Ê¨¢ËøéÊù•Âà∞HarryÁöÑÂéüÁ•û‰∏≠ÂøÉ',
    welcomeSubtitle: 'ÊÇ®ËøõË°åÂéüÁ•ûËÆ°ÁÆó„ÄÅÊ¥ûÂØüÂíåËµÑÊ∫êÁöÑÁªàÊûÅÁõÆÁöÑÂú∞',
    calculatorTitle: 'ÊäΩÂç°ËÆ°ÁÆóÂô®',
    calculatorDesc: 'ÂÖ∑ÊúâËæâÂÖâÂêåË∞ÉÊîØÊåÅÂíåËíôÁâπÂç°Ê¥õÊ®°ÊãüÁöÑÈ´òÁ∫ßÊ¶ÇÁéáËÆ°ÁÆó',
    tryCalculator: 'ËØïÁî®ËÆ°ÁÆóÂô®',
    blogTitle: 'ÂçöÂÆ¢‰∏éÊ¥ûÂØü',
    blogDesc: 'ÂéüÁ•ûÊú∫Âà∂ÂíåÂÖÉÊ∏∏ÊàèÁöÑÊäÄÂ∑ß„ÄÅÊåáÂçóÂíåÂàÜÊûê',
    readBlog: 'ÈòÖËØªÂçöÂÆ¢',
    readChangelog: 'Êü•ÁúãÊõ¥Êñ∞Êó•Âøó',
    settingsTitle: 'ËÆæÁΩÆ',
    settingsDesc: 'ÈÄöËøá‰∏ªÈ¢òÂíåËØ≠Ë®ÄÂÅèÂ•ΩËá™ÂÆö‰πâÊÇ®ÁöÑ‰ΩìÈ™å',
    openSettings: 'ÊâìÂºÄËÆæÁΩÆ',
    aboutHarry: 'ÂÖ≥‰∫éHarry',
    harryBio: 'ÁÉ≠ÊÉÖÁöÑÂéüÁ•ûÁé©ÂÆ∂ÂíåÂºÄÂèëËÄÖÔºåÁÉ≠Áà±Êï∞Â≠¶ÂíåÊ¶ÇÁéáËÆ∫„ÄÇÊàëÂàõÂª∫‰∫ÜËøô‰∏™ËÆ°ÁÆóÂô®Êù•Â∏ÆÂä©Âêå‰∏∫ÊóÖË°åËÄÖÁöÑ‰ºô‰º¥‰ª¨Âú®Á•àÊÑøÁ≠ñÁï•‰∏äÂÅöÂá∫ÊòéÊô∫ÁöÑÂÜ≥ÂÆö„ÄÇÂΩìÊàë‰∏çÂú®ÁºñÁ®ãÊó∂Ôºå‰Ω†ÂèØ‰ª•ÂèëÁé∞ÊàëÂú®Êé¢Á¥¢ÊèêÁì¶ÁâπÂ§ßÈôÜÂπ∂ÁêÜËÆ∫ÊûÑÂª∫ÊúÄ‰Ω≥Èòü‰ºçÁªÑÂêà„ÄÇ',
    recentPosts: 'ÊúÄÊñ∞Â∏ñÂ≠ê',
    appearance: 'Â§ñËßÇ',
    themeLabel: '‰∏ªÈ¢ò:',
    language: 'ËØ≠Ë®Ä',
    selectLanguage: 'ÈÄâÊã©ËØ≠Ë®Ä:',
    dataManagement: 'Êï∞ÊçÆÁÆ°ÁêÜ',
    clearAllData: 'Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ',
    clearDataDesc: 'Âà†Èô§ÊâÄÊúâÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆÂíåÂÅèÂ•Ω',
    exportData: 'ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ',
    exportDataDesc: 'Â∞ÜÊâÄÊúâÊï∞ÊçÆ‰∏ãËΩΩ‰∏∫Â§á‰ªΩÊñá‰ª∂',
    about: 'ÂÖ≥‰∫é',
    appDescription: 'HarryÁöÑÂéüÁ•û‰∏≠ÂøÉÊòØ‰∏Ä‰∏™ÈíàÂØπÂéüÁ•ûÁ•àÊÑøÊú∫Âà∂ÁöÑÈ´òÁ∫ßÊ¶ÇÁéáËÆ°ÁÆóÂô®ÔºåÂÖ∑ÊúâËæâÂÖâÂêåË∞ÉÊîØÊåÅ„ÄÅËíôÁâπÂç°Ê¥õÊ®°ÊãüÂíåÁªºÂêàÂàÜÊûêÂ∑•ÂÖ∑„ÄÇ',
    version: 'ÁâàÊú¨:',
    developer: 'ÂºÄÂèëËÄÖ:'
  },
  pt: {
    home: 'In√≠cio',
    calculator: 'Calculadora',
    blog: 'Blog',
    changelog: 'Registo de altera√ß√µes',
    settings: 'Defini√ß√µes',
    welcomeTitle: 'Bem-vindo ao Hub Genshin de Harry',
    welcomeSubtitle: 'O seu destino final para c√°lculos, insights e recursos do Genshin Impact',
    calculatorTitle: 'Calculadora de Puxadas',
    calculatorDesc: 'C√°lculos de probabilidade avan√ßados com suporte de Radiance Pity e simula√ß√µes de Monte Carlo',
    tryCalculator: 'Experimente a Calculadora',
    blogTitle: 'Blog e Insights',
    blogDesc: 'Dicas, guias e an√°lises das mec√¢nicas e meta do Genshin Impact',
    readBlog: 'Ler o Blog',
    readChangelog: 'Ver Registo de Altera√ß√µes',
    settingsTitle: 'Defini√ß√µes',
    settingsDesc: 'Personalize a sua experi√™ncia com prefer√™ncias de tema e idioma',
    openSettings: 'Abrir Defini√ß√µes',
    aboutHarry: 'Sobre o Harry',
    harryBio: 'Jogador apaixonado de Genshin Impact e desenvolvedor com amor pela matem√°tica e teoria da probabilidade. Criei esta calculadora para ajudar outros Viajantes a tomar decis√µes informadas sobre as suas estrat√©gias de puxadas. Quando n√£o estou a programar, podem encontrar-me a explorar Teyvat e a teorizar sobre composi√ß√µes de equipa ideais.',
    recentPosts: 'Publica√ß√µes Recentes',
    appearance: 'Apar√™ncia',
    themeLabel: 'Tema:',
    language: 'Idioma',
    selectLanguage: 'Selecionar Idioma:',
    dataManagement: 'Gest√£o de Dados',
    clearAllData: 'Limpar Todos os Dados',
    clearDataDesc: 'Remover todas as configura√ß√µes e prefer√™ncias guardadas',
    exportData: 'Exportar Todos os Dados',
    exportDataDesc: 'Descarregar todos os seus dados como um ficheiro de backup',
    about: 'Sobre',
    appDescription: 'O Hub Genshin de Harry √© uma calculadora de probabilidade avan√ßada para as mec√¢nicas de puxadas do Genshin Impact, com suporte de Radiance Pity, simula√ß√µes de Monte Carlo e ferramentas de an√°lise abrangentes.',
    version: 'Vers√£o:',
    developer: 'Desenvolvedor:'
  }
};

// Store translation data globally
window.translations = translations;
window.currentLanguage = 'en';

// Navigation click listeners will be set up in the main DOMContentLoaded listener

// Settings page functions
function clearAllData() {
  if (confirm('Are you sure you want to clear all saved data? This action cannot be undone.')) {
    localStorage.clear();
    alert('All data has been cleared. The page will now reload.');
    location.reload();
  }
}

function exportAllData() {
  const allData = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    allData[key] = localStorage.getItem(key);
  }
  
  const dataStr = JSON.stringify(allData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `genshin-hub-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Additional CSS for blog and settings
const additionalStyles = `
  .setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 15px 0;
    padding: 15px 0;
    border-bottom: 1px solid var(--border-color);
  }
  
  .setting-description {
    font-size: 0.9em;
    color: var(--label-color);
    margin: 5px 0 0 0;
  }
  
  .danger-btn {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
  }
  
  .danger-btn:hover {
    background: linear-gradient(45deg, #ff5252, #d63031) !important;
  }
  
`;

// Inject additional styles
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);

class GenshinCalculator {
  constructor() {
    this.baseRates = {
      character: { fiveStar: 0.006, fourStar: 0.051 },
      weapon: { fiveStar: 0.007, fourStar: 0.06 }
    };
    this.hardPity = { character: 90, weapon: 80 };
    this.softPityStart = { character: 74, weapon: 63 };
  }

  getPullProbability(pity, banner) {
    const hardLimit = this.hardPity[banner];
    if (pity >= hardLimit - 1) return 1.0;
    
    // Use actual soft pity data from community research
    if (banner === 'character') {
      // Character banner soft pity (based on actual pull data)
      if (pity < 73) return 0.006; // 0.6% base rate
      
      // Soft pity rates (pulls 74-89)
      const softPityRates = [
        0.0594, 0.1134, 0.1674, 0.2214, 0.2754, // pulls 74-78
        0.3294, 0.3834, 0.4374, 0.4914, 0.5454, // pulls 79-83
        0.5994, 0.6534, 0.7074, 0.7614, 0.8154, // pulls 84-88
        0.8694 // pull 89
      ];
      
      const softIndex = pity - 73;
      return softIndex < softPityRates.length ? softPityRates[softIndex] : 1.0;
    } else {
      // Weapon banner soft pity (based on actual pull data)
      if (pity < 62) return 0.007; // 0.7% base rate
      
      // Weapon soft pity rates (pulls 63-79)
      const weaponSoftRates = [
        0.070, 0.133, 0.196, 0.259, 0.322, // pulls 63-67
        0.385, 0.448, 0.511, 0.574, 0.637, // pulls 68-72
        0.700, 0.763, 0.826, 0.889, 0.952, // pulls 73-77
        0.980, 0.995 // pulls 78-79
      ];
      
      const softIndex = pity - 62;
      return softIndex < weaponSoftRates.length ? weaponSoftRates[softIndex] : 1.0;
    }
  }

  // Get the effective win rate based on Radiance Pity
  getRadianceWinRate(radiancePityCount) {
    switch (radiancePityCount) {
      case 0: return 0.50; // 50% base chance
      case 1: return 0.55; // ~55% after 1 loss
      case 2: return 0.75; // ~75% after 2 losses
      case 3: return 1.00; // 100% guaranteed after 3 losses
      default: return 0.50;
    }
  }

  simulateSession(banner, goal, currentPity, isGuaranteed, fatePoints, availablePulls, radiancePity = 0) {
    let pity = currentPity, guaranteed = isGuaranteed, weaponPoints = fatePoints;
    let currentRadiancePity = radiancePity;
    let pullsUsed = 0, fiveStarsObtained = 0, targetObtained = 0;
    
    while (targetObtained < goal && pullsUsed < availablePulls) {
      pullsUsed++;
      pity++;
      const pullProb = this.getPullProbability(pity - 1, banner);
      const gotFiveStar = Math.random() < pullProb;
      
      if (gotFiveStar) {
        fiveStarsObtained++;
        pity = 0;
        
        if (banner === 'character') {
          if (guaranteed) {
            // Already guaranteed, definitely get featured character
            targetObtained++; 
            guaranteed = false;
            currentRadiancePity = 0; // Reset on guarantee
          } else {
            // Apply Radiance Pity modified chances
            const effectiveWinRate = this.getRadianceWinRate(currentRadiancePity);
            const wonFiftyFifty = Math.random() < effectiveWinRate;
            
            if (wonFiftyFifty) {
              // Won the modified 50/50, got featured character
              targetObtained++; 
              guaranteed = false;
              currentRadiancePity = 0; // Reset on win
            } else {
              // Lost the modified 50/50, got standard character
              // Standard loss, next is guaranteed and increment Radiance Pity
              guaranteed = true;
              currentRadiancePity = Math.min(3, currentRadiancePity + 1);
            }
          }
        } else {
          // Weapon banner logic - use FatePoints as single source of truth
          if (weaponPoints >= 1) {
            // Already guaranteed by Epitomized Path
            targetObtained++;
            weaponPoints = 0; // Reset after getting guaranteed weapon
          } else {
            // Roll for weapon (66.7% chance for target weapon)
            if (Math.random() < 2/3) {
              // Got target weapon
              targetObtained++;
              weaponPoints = 0; // Reset on success
            } else {
              // Got non-target weapon, increment FatePoints
              weaponPoints = 1; // Set to 1 (next pull guaranteed)
            }
          }
        }
      }
    }
    
    return {
      success: targetObtained >= goal,
      pullsUsed,
      fiveStarsObtained,
      finalPity: pity,
      finalGuaranteed: guaranteed,
      finalWeaponPoints: weaponPoints,
      finalRadiancePity: currentRadiancePity
    };
  }

  simulateCombinedSession(charGoal, charPity, charGuaranteed, weapGoal, weapPity, fatePoints, availablePulls, radiancePity = 0) {
    let totalPullsUsed = 0, charObtained = 0, weapObtained = 0;
    let charSuccess = false, weapSuccess = false;
    
    if (charGoal > 0) {
      const charResult = this.simulateSession('character', charGoal, charPity, charGuaranteed, 0, availablePulls, radiancePity);
      charObtained = charResult.fiveStarsObtained;
      totalPullsUsed += charResult.pullsUsed;
      charSuccess = charResult.success;
    } else {
      charSuccess = true; // No character goal means automatic success
    }
    
    if (weapGoal > 0 && totalPullsUsed < availablePulls) {
      const weapResult = this.simulateSession('weapon', weapGoal, weapPity, false, fatePoints, availablePulls - totalPullsUsed, 0);
      weapObtained = weapResult.fiveStarsObtained;
      totalPullsUsed += weapResult.pullsUsed;
      weapSuccess = weapResult.success;
    } else if (weapGoal === 0) {
      weapSuccess = true; // No weapon goal means automatic success
    }
    
    return {
      success: charSuccess && weapSuccess,
      totalPullsUsed,
      charObtained,
      weapObtained,
      charSuccess,
      weapSuccess
    };
  }

  runCombinedSimulation(charGoal, charPity, charGuaranteed, weapGoal, weapPity, fatePoints, availablePulls, numSims, radiancePity = 0) {
    const results = [];
    let fullSuccess = 0, charSuccess = 0, weapSuccess = 0;
    for (let i = 0; i < numSims; i++) {
      const res = this.simulateCombinedSession(charGoal, charPity, charGuaranteed, weapGoal, weapPity, fatePoints, availablePulls, radiancePity);
      results.push(res);
      if (res.success) fullSuccess++;
      if (res.charSuccess || charGoal === 0) charSuccess++;
      if (res.weapSuccess || weapGoal === 0) weapSuccess++;
    }
    const successful = results.filter(r => r.success).map(r => r.totalPullsUsed);
    return {
      fullSuccessRate: fullSuccess / numSims,
      charSuccessRate: charSuccess / numSims,
      weapSuccessRate: weapSuccess / numSims,
      averagePulls: successful.length ? successful.reduce((a,b)=>a+b)/successful.length : 0,
      medianPulls: successful.length ? this.median(successful) : 0,
      percentile90: successful.length ? this.percentile(successful, 0.9) : 0,
      percentile10: successful.length ? this.percentile(successful, 0.1) : 0,
      results
    };
  }

  calculateExpectedPulls(banner, goal, pity, guaranteed, points) {
    const expected = banner === 'character'
      ? (guaranteed ? 75 : 112.5)
      : points >= 1 ? 65 : 105;
    return Math.ceil((expected * goal) - pity);
  }

  calculateScenario(banner, goal, pity, guaranteed, points, mode) {
    let total = 0, current = pity, guaranteedFlag = guaranteed, fate = points, obtained = 0;
    while (obtained < goal) {
      if (mode === 'win_all') {
        total += this.getExpectedPullsToNext(banner, current);
        current = 0; guaranteedFlag = false; fate = 0; obtained++;
      } else if (mode === 'lose_all') {
        if (!guaranteedFlag && banner === 'character') {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; guaranteedFlag = true;
        } else if (banner === 'weapon' && fate < 1) {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; fate++;
        } else {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; guaranteedFlag = false; fate = 0; obtained++;
        }
      }
    }
    return Math.ceil(total);
  }

  calculateCombinedScenarios(charGoal, charPity, charGuaranteed, weapGoal, weapPity, fatePoints) {
    const s = {};
    s.charBest = charGoal ? this.calculateScenario('character', charGoal, charPity, true, 0, 'win_all') : 0;
    s.charWorst = charGoal ? this.calculateScenario('character', charGoal, charPity, charGuaranteed, 0, 'lose_all') : 0;
    s.charExpected = charGoal ? this.calculateExpectedPulls('character', charGoal, charPity, charGuaranteed, 0) : 0;
    s.weapBest = weapGoal ? this.calculateScenario('weapon', weapGoal, weapPity, false, fatePoints, 'win_all') : 0;
    s.weapWorst = weapGoal ? this.calculateScenario('weapon', weapGoal, weapPity, false, fatePoints, 'lose_all') : 0;
    s.weapExpected = weapGoal ? this.calculateExpectedPulls('weapon', weapGoal, weapPity, false, fatePoints) : 0;
    s.combinedBest = s.charBest + s.weapBest;
    s.combinedWorst = s.charWorst + s.weapWorst;
    s.combinedExpected = s.charExpected + s.weapExpected;
    return s;
  }

  getExpectedPullsToNext(banner, pity) {
    return pity >= this.softPityStart[banner]
      ? Math.min(5, this.hardPity[banner] - pity)
      : banner === 'character' ? 75 : 65;
  }

  median(arr) {
    const s = arr.slice().sort((a, b) => a - b);
    const m = Math.floor(s.length / 2);
    return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
  }

  percentile(arr, p) {
    const s = arr.slice().sort((a, b) => a - b);
    const i = p * (s.length - 1), l = Math.floor(i), u = Math.ceil(i);
    return s[l] * (u - i) + s[u] * (i - l);
  }
}

const calculator = new GenshinCalculator();


function updateResourceSummary() {
  const p = +document.getElementById('primos').value || 0;
  const f = +document.getElementById('fates').value || 0;
  const g = +document.getElementById('genesis').value || 0;
  const pp = Math.floor(p / 160), fp = f, gp = Math.floor(g / 160);
  const basePulls = pp + fp + gp;
  
  // Calculate starglitter pulls if checkbox is enabled
  let glitterPulls = 0;
  const useStarglitter = document.getElementById('useStarglitter').checked;
  if (useStarglitter) {
    const avgGlitterPerPull = 0.2;
    const estimatedGlitter = Math.floor(basePulls * avgGlitterPerPull);
    glitterPulls = Math.floor(estimatedGlitter / 5);
  }
  
  const total = basePulls + glitterPulls;
  
  document.getElementById('primoPulls').textContent = pp;
  document.getElementById('fatePulls').textContent = fp;
  document.getElementById('genesisPulls').textContent = gp;
  document.getElementById('starglitterPulls').textContent = glitterPulls;
  document.getElementById('totalPulls').textContent = total;
  updatePityProgress();
  autoCalculate();
}

// Quick preset function for common pull amounts
function setQuickPreset(pulls) {
  if (pulls === 0) {
    document.getElementById('primos').value = 0;
    document.getElementById('fates').value = 0;
    document.getElementById('genesis').value = 0;
  } else {
    // Set as fates for simplicity
    document.getElementById('primos').value = 0;
    document.getElementById('fates').value = pulls;
    document.getElementById('genesis').value = 0;
  }
  updateResourceSummary();
}

/* applyStarglitterPulls removed in v6.1 ‚Äî replaced by starglitter amount input and checkbox toggle */

function updatePityProgress() {
  const char = Math.max(0, Math.min(89, +document.getElementById('charPity').value || 0));
  const weap = Math.max(0, Math.min(79, +document.getElementById('weapPity').value || 0));
  
  document.getElementById('charPity').value = char;
  document.getElementById('weapPity').value = weap;
  
  document.getElementById('charPityProgress').style.width = (char / 90 * 100) + '%';
  document.getElementById('weapPityProgress').style.width = (weap / 80 * 100) + '%';
  
  const charWarning = document.getElementById('charPityWarning');
  const weapWarning = document.getElementById('weapPityWarning');
  const charGuaranteed = document.getElementById('charGuaranteed').value === 'true';
  const radiancePity = +document.getElementById('radiancePity').value;
  
  if (char >= 73) {
    charWarning.style.display = 'block';
    if (char >= 80) {
      charWarning.innerHTML = '<strong>‚ö†Ô∏è High Pity!</strong> You\'re very close to hard pity (90). You\'ll likely get a 5‚òÖ within the next few pulls!';
    } else {
      charWarning.innerHTML = '<strong>üí´ Soft Pity!</strong> You\'re in soft pity range. Your chances of getting a 5‚òÖ are significantly increased!';
    }
  } else if (char >= 60) {
    charWarning.style.display = 'block';
    charWarning.innerHTML = '<strong>üìä Building Pity:</strong> Getting close to soft pity (starts at 74). About ' + (74 - char) + ' pulls away.';
  } else if (char > 0 && !charGuaranteed && radiancePity === 0) {
    charWarning.style.display = 'block';
    charWarning.innerHTML = '<strong>üí° Tip:</strong> If you recently lost 50/50, make sure to set "Next Character Guaranteed" to Yes and update Radiance Pity.';
  } else {
    charWarning.style.display = 'none';
  }
  
  if (weap >= 63) {
    weapWarning.style.display = 'block';
    if (weap >= 70) {
      weapWarning.innerHTML = '<strong>‚ö†Ô∏è High Pity!</strong> You\'re very close to hard pity (80). You\'ll likely get a 5‚òÖ weapon soon!';
    } else {
      weapWarning.innerHTML = '<strong>üí´ Soft Pity!</strong> You\'re in soft pity range for weapons. Increased 5‚òÖ rates!';
    }
  } else if (weap >= 50) {
    weapWarning.style.display = 'block';
    weapWarning.innerHTML = '<strong>üìä Building Pity:</strong> Getting close to soft pity (starts at 63). About ' + (63 - weap) + ' pulls away.';
  } else {
    weapWarning.style.display = 'none';
  }
  
  autoCalculate();
}

function toggleCharacterInputs() {
  const checked = document.getElementById('wantCharacter').checked;
  document.getElementById('characterInputs').style.display = checked ? 'block' : 'none';
  autoCalculate();
}

function toggleWeaponInputs() {
  const checked = document.getElementById('wantWeapon').checked;
  document.getElementById('weaponInputs').style.display = checked ? 'block' : 'none';
  autoCalculate();
}

// Debounce timer for auto-calculation
let autoCalculateTimer = null;
let isCalculating = false;

async function calculate() {
  const totalPulls = +document.getElementById('totalPulls').textContent;
  const wantChar = document.getElementById('wantCharacter').checked;
  const wantWeap = document.getElementById('wantWeapon').checked;
  
  const statusDiv = document.getElementById('calculationStatus');
  const resultsDiv = document.getElementById('results');
  
  // Silent validation - just don't calculate if invalid
  if (!wantChar && !wantWeap) {
    statusDiv.style.display = 'none';
    resultsDiv.innerHTML = '<div class="results"><p style="color: var(--label-color);">Select a goal (character or weapon) to see probabilities.</p></div>';
    return;
  }
  
  if (totalPulls === 0) {
    statusDiv.style.display = 'none';
    resultsDiv.innerHTML = '<div class="results"><p style="color: var(--label-color);">Enter your resources to see probabilities.</p></div>';
    return;
  }
  
  // Show calculating status
  statusDiv.style.display = 'block';
  isCalculating = true;
  
  // Small delay to let UI update
  await new Promise(resolve => setTimeout(resolve, 10));
  
  const charGoal = wantChar ? +document.getElementById('constellations').value + 1 : 0;
  const weapGoal = wantWeap ? +document.getElementById('refinements').value + 1 : 0;
  const charPity = Math.max(0, Math.min(89, +document.getElementById('charPity').value || 0));
  const weapPity = Math.max(0, Math.min(79, +document.getElementById('weapPity').value || 0));
  const charGuaranteed = document.getElementById('charGuaranteed').value === 'true';
  const fatePoints = +document.getElementById('fatepoints').value;
  const radiancePity = wantChar ? +document.getElementById('radiancePity').value : 0;
  
  const isMobile = window.innerWidth <= 768;
  const isLowEndDevice = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
  let numSims = 100000;
  let performanceMode = 'Standard';
  
  if (isMobile || isLowEndDevice) {
    numSims = 50000;
    performanceMode = 'Fast (Mobile)';
  }
  if (totalPulls > 500) {
    numSims = Math.max(30000, Math.floor(numSims * 0.7));
    performanceMode = 'Fast (Large calculation)';
  }

  let output = '<div class="results">';
  
  {
    const simResults = calculator.runCombinedSimulation(
      charGoal, charPity, charGuaranteed,
      weapGoal, weapPity, fatePoints, totalPulls, numSims, radiancePity
    );

    output += '<h3>Monte Carlo Simulation Results</h3>';
    output += `<p style="font-size: 12px; color: var(--label-color); margin-bottom: 15px;">${numSims.toLocaleString()} simulations ‚Ä¢ ${performanceMode} mode</p>`;
    if (wantChar) {
      output += `<p>Character Success Rate: ${(simResults.charSuccessRate * 100).toFixed(1)}%</p>`;
    }
    if (wantWeap) {
      output += `<p>Weapon Success Rate: ${(simResults.weapSuccessRate * 100).toFixed(1)}%</p>`;
    }
    if (wantChar && wantWeap) {
      output += `<p>Overall Success Rate: ${(simResults.fullSuccessRate * 100).toFixed(1)}%</p>`;
    }
    
    if (simResults.averagePulls > 0) {
      output += `<p>For successful attempts:</p>`;
      output += `<ul>`;
      output += `<li>Average pulls needed: ${Math.round(simResults.averagePulls)}</li>`;
      output += `<li>Median pulls needed: ${Math.round(simResults.medianPulls)}</li>`;
      output += `<li>10th percentile (Lucky): ${Math.round(simResults.percentile10)}</li>`;
      output += `<li>90th percentile (Unlucky): ${Math.round(simResults.percentile90)}</li>`;
      output += `</ul>`;
    }
    
    // Create chart for simulation results
    createChart(simResults);
  }

  output += '</div>';
  resultsDiv.innerHTML = output;
  
  // Hide calculating status
  statusDiv.style.display = 'none';
  isCalculating = false;
}

// Auto-calculate with debouncing (waits 700ms after last input for better performance)
function autoCalculate() {
  // Show status immediately when user starts typing
  const statusDiv = document.getElementById('calculationStatus');
  if (!isCalculating) {
    statusDiv.style.display = 'block';
  }
  
  clearTimeout(autoCalculateTimer);
  autoCalculateTimer = setTimeout(() => {
    calculate();
  }, 700);
}
// This function is replaced by the enhanced version above

/* saveConfiguration removed in v6.1 */

/* loadConfiguration removed in v6.1 */



function updateChartTheme(isDarkMode) {
  if (!window.resultsChartInstance) return;
  
  const textColor = isDarkMode ? '#e1e1e1' : '#333';
  
  window.resultsChartInstance.options.scales.x.ticks.color = textColor;
  window.resultsChartInstance.options.scales.y.ticks.color = textColor;
  window.resultsChartInstance.options.scales.x.title.color = textColor;
  window.resultsChartInstance.options.scales.y.title.color = textColor;
  window.resultsChartInstance.options.plugins.title.color = textColor;
  
  window.resultsChartInstance.update();
}


// Enhanced input validation and utilities
function validateAndUpdateResources(input) {
  let value = parseFloat(input.value) || 0;
  const min = parseFloat(input.min) || 0;
  const max = parseFloat(input.max) || Infinity;
  
  // Clamp value to min/max
  value = Math.max(min, Math.min(max, Math.floor(value)));
  input.value = value;
  
  updateResourceSummary();
}

function handleEnterKey(event, callback) {
  if (event.key === 'Enter') {
    event.preventDefault();
    callback();
  }
}

function formatNumber(num) {
  return num.toLocaleString();
}

// Export/Import functionality
/* exportConfiguration removed in v6.1 */

/* importConfiguration removed in v6.1 */

let lastSimulationResults = null;

/* exportResults removed in v6.1 */

/* generateCSV removed in v6.1 */

// Enhanced cumulative probability chart creation with Character/Weapon toggle support
function createChart(simResults) {
  // Store simulation results globally for chart updates
  window.lastChartSimResults = simResults;
  updateChart();
}

// New function to update chart based on toggle selection
function updateChart() {
  try {
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not loaded');
      return;
    }
    
    const canvas = document.getElementById('resultsChart');
    if (!canvas) {
      console.error('Chart canvas not found');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error('Canvas context not available');
      return;
    }
    
    // Destroy existing chart if it exists
    if (window.resultsChartInstance) {
      window.resultsChartInstance.destroy();
    }
    
    // Get selected chart type
    const chartType = document.querySelector('input[name="chartType"]:checked')?.value || 'character';
    const wantChar = document.getElementById('wantCharacter').checked;
    const wantWeap = document.getElementById('wantWeapon').checked;
    
    // Check if the selected chart type has goals
    if (chartType === 'character' && !wantChar) {
      displayNoDataMessage('No character goals selected. Please select character goals to view this chart.');
      return;
    }
    if (chartType === 'weapon' && !wantWeap) {
      displayNoDataMessage('No weapon goals selected. Please select weapon goals to view this chart.');
      return;
    }
    
    // Get total pulls and calculate dynamic X-axis max with padding
    const totalPulls = +document.getElementById('totalPulls').textContent || 0;
    const maxPulls = Math.max(200, totalPulls + 50); // Dynamic max with padding
    const datasets = [];
    
    // Colors for constellations/refinements - matching reference site style
    const colors = [
      '#FF6384', // C0/R1 - Pink/Red
      '#36A2EB', // C1/R2 - Blue  
      '#FFCE56', // C2/R3 - Yellow
      '#4BC0C0', // C3/R4 - Teal
      '#9966FF', // C4/R5 - Purple
      '#FF9F40', // C5 - Orange
      '#C7C7C7'  // C6 - Gray
    ];
    
    let maxLevel, banner, pity, guaranteed, fatePoints, radiancePity, numSims;
    
    if (chartType === 'character') {
      maxLevel = Math.min(6, +document.getElementById('constellations').value);
      banner = 'character';
      pity = Math.max(0, Math.min(89, +document.getElementById('charPity').value || 0));
      guaranteed = document.getElementById('charGuaranteed').value === 'true';
      fatePoints = 0;
      radiancePity = +document.getElementById('radiancePity').value || 0;
      numSims = 8000; // Reduced for performance
    } else {
      maxLevel = Math.min(4, +document.getElementById('refinements').value);
      banner = 'weapon';
      pity = Math.max(0, Math.min(79, +document.getElementById('weapPity').value || 0));
      guaranteed = false;
      fatePoints = +document.getElementById('fatepoints').value || 0;
      radiancePity = 0;
      numSims = 8000;
    }
    
    // Calculate cumulative probabilities for each level
    for (let level = 0; level <= maxLevel; level++) {
      const goal = level + 1; // C0/R1 = 1 copy, C1/R2 = 2 copies, etc.
      
      let simResults;
      if (chartType === 'character') {
        simResults = calculator.runCombinedSimulation(
          goal, pity, guaranteed, 0, 0, 0, maxPulls + 100, numSims, radiancePity
        );
      } else {
        simResults = calculator.runCombinedSimulation(
          0, 0, false, goal, pity, fatePoints, maxPulls + 100, numSims, 0
        );
      }
      
      // Extract successful pulls data
      const pullsData = simResults.results
        .filter(r => chartType === 'character' ? r.charSuccess : r.weapSuccess)
        .map(r => r.totalPullsUsed)
        .sort((a, b) => a - b);
      
      if (pullsData.length === 0) continue;
      
      // Create cumulative probability data points with natural line endings
      const cumulativeData = [];
      let dataIndex = 0;
      const stepSize = 5; // Smaller steps for smoother lines
      
      for (let pulls = 0; pulls <= maxPulls; pulls += stepSize) {
        // Count successful runs using <= this many pulls
        while (dataIndex < pullsData.length && pullsData[dataIndex] <= pulls) {
          dataIndex++;
        }
        
        // Calculate cumulative probability
        const cumulativeProbability = (dataIndex / pullsData.length) * 100;
        cumulativeData.push({ x: pulls, y: cumulativeProbability });
        
        // Stop adding points if we've reached near 100% to allow natural line ending
        if (cumulativeProbability >= 99.8 && pulls > totalPulls) {
          break;
        }
      }
      
      const label = chartType === 'character' ? `C${level}` : `R${level + 1}`;
      const description = chartType === 'character' && level === 0 ? ' (Base Character)' : 
                         chartType === 'weapon' && level === 0 ? ' (Base Weapon)' : '';
      
      datasets.push({
        label: label + description,
        data: cumulativeData,
        borderColor: colors[level],
        backgroundColor: colors[level] + '20',
        borderWidth: 3,
        fill: false,
        stepped: true,
        tension: 0,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: colors[level],
        pointHoverBorderColor: '#ffffff',
        pointHoverBorderWidth: 2
      });
    }
    
    if (datasets.length === 0) {
      displayNoDataMessage('No data available for chart creation.');
      return;
    }
    
    // Always use bright colors for dark mode
    const textColor = '#ffffff';
    const labelColor = '#e8e8e8';
    const gridColor = 'rgba(255, 255, 255, 0.2)';
    
    // Create the chart
    window.resultsChartInstance = new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          title: {
            display: true,
            text: `Cumulative Probability - ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Banner`,
            color: '#ffffff',
            font: { size: 20, weight: 'bold' },
            padding: { top: 10, bottom: 20 }
          },
          legend: {
            display: true,
            position: 'top',
            align: 'center',
            labels: {
              color: '#ffffff',
              usePointStyle: true,
              padding: 15,
              font: { size: 14, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: colors[0],
            borderWidth: 2,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              title: function(context) {
                return `${context[0].parsed.x} pulls`;
              },
              label: function(context) {
                return `${context.dataset.label.replace(' (Base Character)', '').replace(' (Base Weapon)', '')}: ${context.parsed.y.toFixed(1)}%`;
              },
              afterBody: function(context) {
                if (context.length > 0) {
                  const pulls = context[0].parsed.x;
                  if (Math.abs(pulls - totalPulls) <= 10) {
                    return [``, `‚âà Your current resources: ${totalPulls} pulls`];
                  }
                }
                return [];
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            min: 0,
            max: maxPulls,
            title: {
              display: true,
              text: 'Total Number of Pulls',
              color: '#ffffff',
              font: { size: 15, weight: 'bold' }
            },
            ticks: {
              color: '#e8e8e8',
              stepSize: Math.max(25, Math.floor(maxPulls / 12)),
              font: { size: 12 },
              callback: function(value) {
                return value.toString();
              }
            },
            grid: {
              color: gridColor,
              lineWidth: 1,
              drawBorder: true
            }
          },
          y: {
            min: 0,
            max: 100,
            title: {
              display: true,
              text: 'Cumulative Probability (%)',
              color: '#ffffff',
              font: { size: 15, weight: 'bold' }
            },
            ticks: {
              color: '#e8e8e8',
              stepSize: 10,
              font: { size: 12 },
              callback: function(value) {
                return value + '%';
              }
            },
            grid: {
              color: gridColor,
              lineWidth: 1,
              drawBorder: true
            }
          }
        },
        elements: {
          point: { radius: 0, hoverRadius: 6 },
          line: { borderWidth: 3 }
        },
        animation: {
          duration: 1200,
          easing: 'easeOutQuart'
        }
      }
    });
    
    // Add vertical line for current resources if within chart range
    if (totalPulls > 0 && totalPulls <= maxPulls) {
      setTimeout(() => addResourceLine(totalPulls, isDarkMode), 100);
    }
    
  } catch (error) {
    console.error('Error creating chart:', error);
    displayNoDataMessage('Chart failed to load due to an error.');
  }
}

// Helper function to display messages when no chart data is available
function displayNoDataMessage(message) {
  const canvas = document.getElementById('resultsChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const isDarkMode = document.body.classList.contains('dark-mode');
  
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Display message
  ctx.fillStyle = isDarkMode ? '#bbb' : '#666';
  ctx.font = '16px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(message, canvas.width / 2, canvas.height / 2);
}

// Helper function to add resource line annotation
function addResourceLine(totalPulls, isDarkMode) {
  const chart = window.resultsChartInstance;
  if (!chart) return;
  
  const originalDraw = chart.draw;
  chart.draw = function() {
    originalDraw.call(this);
    
    const ctx = this.ctx;
    const chartArea = this.chartArea;
    const xScale = this.scales.x;
    
    if (totalPulls > xScale.min && totalPulls < xScale.max) {
      ctx.save();
      
      // Draw vertical line
      ctx.strokeStyle = '#ff9500';
      ctx.lineWidth = 3;
      ctx.setLineDash([8, 4]);
      
      const xPos = xScale.getPixelForValue(totalPulls);
      ctx.beginPath();
      ctx.moveTo(xPos, chartArea.top);
      ctx.lineTo(xPos, chartArea.bottom);
      ctx.stroke();
      
      // Add label with background
      ctx.setLineDash([]);
      ctx.fillStyle = '#ff9500';
      ctx.font = 'bold 13px Arial';
      ctx.textAlign = 'center';
      
      const labelText = `Your pulls: ${totalPulls}`;
      const textWidth = ctx.measureText(labelText).width;
      const padding = 6;
      
      // Draw background rectangle
      ctx.fillRect(xPos - textWidth/2 - padding, chartArea.top - 24, textWidth + padding*2, 18);
      
      // Draw text
      ctx.fillStyle = '#0a0e1a';
      ctx.fillText(labelText, xPos, chartArea.top - 11);
      
      ctx.restore();
    }
  };
}

// Modal functions
function openChangelogModal() {
  const modal = document.getElementById('changelogModal');
  if (modal) {
    modal.style.display = 'block';
    // Force repaint to ensure modal is visible
    setTimeout(function() {
      modal.style.opacity = '1';
    }, 10);
  } else {
    console.error('Changelog modal not found');
  }
}

function closeChangelogModal() {
  const modal = document.getElementById('changelogModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(function() {
      modal.style.display = 'none';
    }, 300); // Match the transition duration
  }
}

// Close modal when clicking outside of it
window.addEventListener('click', function(event) {
  const modal = document.getElementById('changelogModal');
  if (event.target === modal) {
    closeChangelogModal();
  }
});

// Ensure the modal can be opened and closed properly
document.addEventListener('DOMContentLoaded', function() {
  const versionLink = document.querySelector('.version-link');
  if (versionLink) {
    versionLink.addEventListener('click', function(e) {
      e.preventDefault();
      openChangelogModal();
    });
  }
});

// Update Radiance Pity display with visual indicators
function updateRadiancePityDisplay() {
  const radiancePitySelect = document.getElementById('radiancePity');
  const radiancePity = +radiancePitySelect.value;
  document.getElementById('radiancePityDisplay').textContent = `${radiancePity} / 3`;
  
  // Add visual emphasis when at guaranteed state (3 consecutive losses)
  if (radiancePity === 3) {
    radiancePitySelect.classList.add('radiance-pity-guaranteed');
    radiancePitySelect.setAttribute('aria-label', 'Radiance Pity: 3/3, guaranteed next featured character');
    console.log('Radiance Pity UI updated: Guaranteed state (3/3)');
  } else {
    radiancePitySelect.classList.remove('radiance-pity-guaranteed');
    radiancePitySelect.setAttribute('aria-label', `Radiance Pity: ${radiancePity}/3`);
    console.log(`Radiance Pity UI updated: Normal state (${radiancePity}/3)`);
  }
  autoCalculate();
}

// Update FatePoints display with visual emphasis for guaranteed state
function updateFatePointsDisplay() {
  const fatePointsSelect = document.getElementById('fatepoints');
  const fatePoints = +fatePointsSelect.value;
  
  if (fatePoints === 1) {
    // Add visual emphasis for guaranteed state
    fatePointsSelect.classList.add('fate-points-guaranteed');
    fatePointsSelect.setAttribute('aria-label', 'Fate points: 1 of 1, guaranteed');
    console.log('FatePoints UI updated: Guaranteed state (1/1)');
  } else {
    // Remove visual emphasis for non-guaranteed state
    fatePointsSelect.classList.remove('fate-points-guaranteed');
    fatePointsSelect.setAttribute('aria-label', 'Fate points: 0 of 1');
    console.log('FatePoints UI updated: Normal state (0/1)');
  }
  autoCalculate();
}

// Update Character Guaranteed display with visual emphasis for guaranteed state
function updateCharGuaranteedDisplay() {
  const charGuaranteedSelect = document.getElementById('charGuaranteed');
  const isGuaranteed = charGuaranteedSelect.value === 'true';
  
  if (isGuaranteed) {
    // Add visual emphasis for guaranteed state
    charGuaranteedSelect.classList.add('character-guaranteed');
    charGuaranteedSelect.setAttribute('aria-label', 'Next character guaranteed: Yes');
    console.log('Character Guaranteed UI updated: Guaranteed state (Yes)');
  } else {
    // Remove visual emphasis for non-guaranteed state
    charGuaranteedSelect.classList.remove('character-guaranteed');
    charGuaranteedSelect.setAttribute('aria-label', 'Next character guaranteed: No (50/50)');
    console.log('Character Guaranteed UI updated: Normal state (No/50-50)');
  }
  autoCalculate();
}

// Toggle cost calculator visibility
function toggleCostCalculator() {
  const enabled = document.getElementById('enableCostCalculator').checked;
  const content = document.getElementById('costCalculatorContent');
  content.style.display = enabled ? 'block' : 'none';
  
  if (enabled) {
    updateCostCalculation();
  }
}

// Update cost calculation display
function updateCostCalculation() {
  const currency = document.getElementById('currency').value;
  const method = document.getElementById('spendingMethod').value;
  const totalPulls = +document.getElementById('totalPulls').textContent;
  const costSummaryDiv = document.getElementById('costSummary');
  
  if (totalPulls === 0) {
    costSummaryDiv.innerHTML = '<p style="color: var(--label-color);">Enter your resource values to see cost analysis</p>';
    return;
  }
  
  // Store currency preference
  localStorage.setItem('selectedCurrency', currency);
  
  // Calculate needed additional pulls based on current calculation
  // For now, we'll estimate based on expected pulls for goals
  const wantChar = document.getElementById('wantCharacter').checked;
  const wantWeap = document.getElementById('wantWeapon').checked;
  
  if (!wantChar && !wantWeap) {
    costSummaryDiv.innerHTML = '<p style="color: var(--label-color);">Select character or weapon goals to see cost estimates</p>';
    return;
  }
  
  let estimatedNeededPulls = 0;
  
  if (wantChar) {
    const charGoal = +document.getElementById('constellations').value + 1;
    const charPity = +document.getElementById('charPity').value;
    const charGuaranteed = document.getElementById('charGuaranteed').value === 'true';
    const expected = charGuaranteed ? 75 : 112.5;
    estimatedNeededPulls += Math.ceil((expected * charGoal) - charPity);
  }
  
  if (wantWeap) {
    const weapGoal = +document.getElementById('refinements').value + 1;
    const weapPity = +document.getElementById('weapPity').value;
    const fatePoints = +document.getElementById('fatepoints').value;
    const expected = fatePoints >= 1 ? 65 : 105;
    estimatedNeededPulls += Math.ceil((expected * weapGoal) - weapPity);
  }
  
  const neededPulls = Math.max(0, estimatedNeededPulls - totalPulls);
  
  if (neededPulls === 0) {
    costSummaryDiv.innerHTML = '<div style="color: #2ecc71; font-weight: bold; padding: 15px; background: rgba(46, 204, 113, 0.1); border-radius: 8px;">üéâ Great news! You have enough pulls for your goals!</div>';
    return;
  }
  
  const costAnalysis = costCalculator.analyzeCosts(neededPulls, currency, method);
  
  let html = `<h4>üí∞ Cost Analysis for ${neededPulls} Additional Pulls</h4>`;
  html += `<div style="margin: 15px 0; padding: 15px; background: var(--section-bg); border-radius: 8px; border-left: 3px solid #667eea;"><strong>Method:</strong> ${costAnalysis.method}</div>`;
  
  html += `<div style="font-size: 1.2em; font-weight: bold; color: var(--text-color); margin: 15px 0;">Total Cost: ${costCalculator.formatCurrency(costAnalysis.totalCost, currency)}</div>`;
  
  if (currency !== 'USD') {
    html += `<div style="font-size: 0.9em; color: var(--label-color); margin-bottom: 15px;">‚âà ${costCalculator.formatCurrency(costAnalysis.totalCostUSD, 'USD')} USD</div>`;
  }
  
  // Add method-specific breakdown
  if (method === 'crystals' && costAnalysis.packs) {
    html += '<h5>üì¶ Recommended Packs:</h5><ul>';
    const packCounts = {};
    costAnalysis.packs.forEach(pack => {
      packCounts[pack.base] = (packCounts[pack.base] || 0) + 1;
    });
    
    Object.entries(packCounts).forEach(([base, count]) => {
      const pack = costAnalysis.packs.find(p => p.base === parseInt(base));
      const localPrice = costCalculator.formatCurrency(
        costCalculator.convertCurrency(pack.price, currency), currency
      );
      html += `<li>${count}x ${pack.actual} crystals pack - ${localPrice} each</li>`;
    });
    html += '</ul>';
    
    if (costAnalysis.wastedCrystals > 0) {
      html += `<div style="color: var(--label-color); font-size: 0.9em; margin-top: 10px;">üíé Extra crystals: ${costAnalysis.wastedCrystals}</div>`;
    }
  }
  
  if (method === 'welkin') {
    html += `<div style="margin-top: 15px;"><strong>Welkin Moons needed:</strong> ${costAnalysis.welkinsNeeded}</div>`;
    html += `<div><strong>Time required:</strong> ${costAnalysis.monthsNeeded} months</div>`;
    if (costAnalysis.wastedPrimogems > 0) {
      html += `<div style="color: var(--label-color); font-size: 0.9em; margin-top: 10px;">üíé Extra primogems: ${costAnalysis.wastedPrimogems}</div>`;
    }
  }
  
  if (method === 'mixed') {
    html += '<h5>üîÑ Mixed Approach:</h5>';
    html += `<div>‚Ä¢ ${costAnalysis.welkinMonths} Welkin Moons: ${costCalculator.formatCurrency(costAnalysis.welkinCost, currency)}</div>`;
    if (costAnalysis.crystalsCost > 0) {
      html += `<div>‚Ä¢ Genesis Crystals: ${costCalculator.formatCurrency(costAnalysis.crystalsCost, currency)}</div>`;
      if (costAnalysis.packs && costAnalysis.packs.length > 0) {
        html += '<div style="margin-left: 20px; font-size: 0.9em; color: var(--label-color);">';
        const packCounts = {};
        costAnalysis.packs.forEach(pack => {
          packCounts[pack.base] = (packCounts[pack.base] || 0) + 1;
        });
        Object.entries(packCounts).forEach(([base, count]) => {
          const pack = costAnalysis.packs.find(p => p.base === parseInt(base));
          html += `${count}x ${pack.actual} crystals pack, `;
        });
        html = html.slice(0, -2); // Remove trailing comma
        html += '</div>';
      }
    }
  }
  
  costSummaryDiv.innerHTML = html;
}

// Auto-save inputs to localStorage
function autoSaveInputs() {
  const inputs = [
    'primos', 'fates', 'genesis',
    'constellations', 'charPity', 'charGuaranteed', 'radiancePity',
    'refinements', 'weapPity', 'fatepoints'
  ];
  
  const checkboxes = ['wantCharacter', 'wantWeapon', 'useStarglitter'];
  
  const config = {};
  
  inputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      config[id] = element.value;
    }
  });
  
  checkboxes.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      config[id] = element.checked;
    }
  });
  
  localStorage.setItem('genshinAutoSave', JSON.stringify(config));
}

// Auto-load inputs from localStorage
function autoLoadInputs() {
  const savedData = localStorage.getItem('genshinAutoSave');
  
  if (!savedData) return;
  
  try {
    const config = JSON.parse(savedData);
    
    // Migration: convert legacy weapGuaranteed to FatePoints
    if (config.weapGuaranteed === 'true' || config.weapGuaranteed === true) {
      config.fatepoints = 1;
      delete config.weapGuaranteed;
      console.log('Auto-load: Migrated legacy weapGuaranteed=true to fatepoints=1');
    } else if (config.weapGuaranteed === 'false' || config.weapGuaranteed === false) {
      config.fatepoints = config.fatepoints || 0;
      delete config.weapGuaranteed;
      console.log('Auto-load: Migrated legacy weapGuaranteed=false, kept existing fatepoints');
    }
    
    // Load regular inputs
    Object.keys(config).forEach(id => {
      const element = document.getElementById(id);
      if (element && typeof config[id] !== 'boolean') {
        element.value = config[id] || (element.type === 'number' ? '0' : '');
      }
    });
    
    // Load checkboxes
    if (typeof config.wantCharacter === 'boolean') {
      document.getElementById('wantCharacter').checked = config.wantCharacter;
    }
    if (typeof config.wantWeapon === 'boolean') {
      document.getElementById('wantWeapon').checked = config.wantWeapon;
    }
    
    // Update UI based on loaded values
    toggleCharacterInputs();
    toggleWeaponInputs();
    updateResourceSummary();
    updateRadiancePityDisplay();
    updateFatePointsDisplay();
    updateCharGuaranteedDisplay();
  } catch (error) {
    console.log('Could not load auto-saved inputs:', error);
  }
}

// Add auto-save listeners to all inputs
function addAutoSaveListeners() {
  const inputs = document.querySelectorAll('input, select');
  inputs.forEach(input => {
    input.addEventListener('input', autoSaveInputs);
    input.addEventListener('change', autoSaveInputs);
  });
}

// Simplified changelog functions
function showChangelog() {
  // Simple function to show the changelog page
  showPage('changelog');
}


function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Duplicate function definitions removed - using the original definitions above

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM fully loaded, initializing app...');
  
  try {
    // Load saved language preference
    const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
    changeLanguage(savedLanguage);
    
    // Auto-load saved inputs first
    autoLoadInputs();
    
    // Then update resource summary and displays
    updateResourceSummary();
    updateRadiancePityDisplay();
    updateFatePointsDisplay();
    updateCharGuaranteedDisplay();
    

    
    // Add auto-save listeners
    addAutoSaveListeners();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
      // Ctrl+Enter to calculate
      if (event.ctrlKey && event.key === 'Enter') {
        event.preventDefault();
        calculate();
      }
      
      // Escape to close modal
      if (event.key === 'Escape') {
        closeChangelogModal();
      }
    });
    
    // Set up navigation click listeners at the end to ensure showPage() is defined
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = this.getAttribute('data-page');
        console.log('Navigation clicked:', page);
        showPage(page);
      });
    });
    
    
    console.log('App initialized successfully!');
  } catch (error) {
    console.error('Error initializing app:', error);
  }
});
</script>
</body>
</html>