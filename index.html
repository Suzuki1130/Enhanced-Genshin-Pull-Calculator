<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Harry's Genshin Hub</title>
  <link rel="icon" href="Enhanced_Genshin_Pull_Calculator.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // Initialize Chart.js
    document.addEventListener('DOMContentLoaded', function() {
      // Chart will be initialized when needed in the createChart function
      console.log('Chart.js loaded and ready');
    });
  </script>
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --container-bg: rgba(255, 255, 255, 0.95);
      --section-bg: rgba(255, 255, 255, 0.8);
      --text-color: #333;
      --label-color: #555;
      --border-color: #e1e5e9;
      --progress-bg: #e1e5e9;
      --results-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --results-text: white;
      --chart-bg: white;
      --credits-color: #666;
    }
    
    body.dark-mode {
      --bg-gradient: linear-gradient(135deg, #1a1c2c 0%, #4a2c5d 100%);
      --container-bg: rgba(30, 32, 44, 0.95);
      --section-bg: rgba(40, 42, 54, 0.8);
      --text-color: #e1e1e1;
      --label-color: #bbb;
      --border-color: #444;
      --progress-bg: #444;
      --results-gradient: linear-gradient(135deg, #8052ec 0%, #d161ff 100%);
      --results-text: #e1e1e1;
      --chart-bg: #2a2c3a;
      --credits-color: #aaa;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
      background: var(--bg-gradient);
      min-height: 100vh;
      transition: all 0.3s ease;
    }

    .container {
      background: var(--container-bg);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 30px;
      font-size: 2.5em;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    input, select {
      padding: 12px;
      margin: 8px 0;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s;
      background-color: var(--container-bg);
      color: var(--text-color);
    }

    input:focus, select:focus {
      border-color: #667eea;
      outline: none;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: var(--section-bg);
      border-radius: 12px;
      border-left: 4px solid #667eea;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: background 0.3s ease;
    }

    .section h3 {
      margin-top: 0;
      color: var(--text-color);
      font-size: 1.4em;
      transition: color 0.3s ease;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
      color: var(--label-color);
      transition: color 0.3s ease;
    }

    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      width: 100%;
      margin-top: 20px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .results {
      background: var(--results-gradient);
      color: var(--results-text);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
      background: var(--chart-bg);
      border-radius: 12px;
      padding: 15px;
      transition: background 0.3s ease;
    }

    .progress-bar {
      background: var(--progress-bg);
      border-radius: 10px;
      height: 20px;
      margin: 10px 0;
      overflow: hidden;
      transition: background 0.3s ease;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    /* Theme switcher styles */
    .theme-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-switch-toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .theme-switch-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #667eea;
    }
    
    input:checked + .slider:before {
      transform: translateX(30px);
    }
    
    .theme-icon {
      margin: 0 8px;
      font-size: 18px;
    }
    
    /* Loading spinner styles */
    .loading-spinner {
      display: none;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top: 3px solid #667eea;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .calculating {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .calculating .loading-spinner {
      display: inline-block;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .theme-switch {
        position: relative;
        top: auto;
        right: auto;
        margin: 10px 0;
      }
      
      .input-group {
        grid-template-columns: 1fr;
      }
      
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 2em;
      }
    }
    
    /* Accessibility improvements */
    button:focus, input:focus, select:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    
    /* Tooltip styles */
    .tooltip-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--border-color);
      color: var(--text-color);
      font-size: 11px;
      font-weight: bold;
      cursor: help;
      transition: all 0.3s ease;
      user-select: none;
    }
    
    .tooltip-icon:hover {
      background: #667eea;
      color: white;
      transform: scale(1.1);
    }
    
    .tooltip {
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--section-bg);
      color: var(--text-color);
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
      width: 280px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--border-color);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
      pointer-events: none;
    }
    
    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--section-bg);
    }
    
    .tooltip-icon:hover .tooltip {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    
    /* Version and changelog styles */
    .version-info {
      text-align: center;
      margin-top: 30px;
      padding: 15px;
      color: var(--credits-color);
      font-size: 14px;
    }
    
    .version-link {
      color: var(--text-color);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }
    
    .version-link:hover {
      color: #667eea;
      text-decoration: underline;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-content {
      background: var(--container-bg);
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .close {
      color: var(--text-color);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .close:hover {
      color: #667eea;
    }
    
    .changelog-item {
      margin-bottom: 15px;
      padding: 12px;
      background: var(--section-bg);
      border-radius: 8px;
      border-left: 3px solid #667eea;
    }
    
    .changelog-version {
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 5px;
    }
    
    .changelog-date {
      font-size: 12px;
      color: var(--label-color);
      margin-bottom: 8px;
    }
    
    .changelog-changes {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-color);
    }
    
    .changelog-changes li {
      margin-bottom: 3px;
      color: var(--text-color);
    }
    
    .changelog-changes ul {
      color: var(--text-color);
    }
    
    @media (max-width: 768px) {
      .tooltip {
        width: 250px;
        font-size: 12px;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 20px;
      }
    }
    
    /* Sidebar and Navigation Styles */
    .sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100vh;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: left 0.3s ease;
      z-index: 1000;
      overflow-y: auto;
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .sidebar-header img {
      width: 40px;
      height: 40px;
      margin-right: 15px;
      border-radius: 8px;
    }
    
    .sidebar-header h2 {
      margin: 0;
      font-size: 1.2em;
    }
    
    .nav-menu {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }
    
    .nav-item {
      margin: 0;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    
    .nav-link:hover, .nav-link.active {
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border-left-color: white;
    }
    
    .nav-link i {
      width: 20px;
      margin-right: 10px;
      font-size: 16px;
    }
    
    .language-selector {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
    }
    
    .language-selector select {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 12px;
    }
    
    .mobile-menu-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 45px;
      height: 45px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: block;
    }
    
    .mobile-menu-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .main-content {
      margin-left: 0;
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }
    
    /* Desktop styles */
    @media (min-width: 769px) {
      .sidebar {
        left: 0;
      }
      
      .main-content {
        margin-left: 250px;
      }
      
      .mobile-menu-btn {
        display: none;
      }
    }
    
    /* Page content containers */
    .page-content {
      display: none;
      padding: 20px;
      min-height: calc(100vh - 40px);
      background: transparent;
      margin: 0;
    }
    
    .page-content.active {
      display: block !important;
    }
    
    
    /* Home page specific styles */
    .hero-section {
      text-align: center;
      padding: 40px 0;
      background: linear-gradient(135deg, var(--container-bg) 0%, rgba(102, 126, 234, 0.08) 50%, rgba(118, 75, 162, 0.08) 100%);
      color: var(--text-color);
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.12);
      position: relative;
      overflow: hidden;
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.05) 0%, transparent 70%);
      animation: gentle-pulse 8s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes gentle-pulse {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    
    .hero-section h1 {
      font-size: 2.5em;
      margin-bottom: 15px;
      color: var(--text-color);
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .hero-section p {
      font-size: 1.1em;
      color: var(--label-color);
      max-width: 600px;
      margin: 0 auto;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .feature-card {
      background: linear-gradient(135deg, var(--container-bg) 0%, rgba(102, 126, 234, 0.05) 100%);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.08);
      border: 1px solid rgba(102, 126, 234, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .feature-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.06) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
      background: linear-gradient(135deg, var(--container-bg) 0%, rgba(102, 126, 234, 0.08) 100%);
    }
    
    .feature-card:hover::before {
      opacity: 1;
    }
    
    .feature-icon {
      font-size: 2.5em;
      margin-bottom: 15px;
      filter: grayscale(0.3);
    }
    
    .feature-card h3 {
      color: var(--text-color);
      margin-bottom: 15px;
      font-size: 1.3em;
    }
    
    .feature-card p {
      color: var(--label-color);
      font-size: 0.95em;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    
    .feature-card button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: auto;
      margin-top: 0;
    }
    
    .feature-card button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
  /* Blog page styles */
  .blog-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .blog-header h1 {
    color: var(--text-color);
    font-size: 2.5em;
    margin-bottom: 15px;
    font-weight: 600;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .blog-divider {
    width: 80px;
    height: 4px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    margin: 0 auto;
    border-radius: 2px;
  }
  
  .operator-profile,
  .creator-profile {
    background: linear-gradient(135deg, var(--section-bg) 0%, rgba(168, 85, 247, 0.05) 100%);
    border-radius: 12px;
    margin-bottom: 40px;
    border-left: 4px solid #a855f7;
    box-shadow: 0 8px 25px rgba(168, 85, 247, 0.15);
    position: relative;
    overflow: hidden;
  }
  
  .creator-profile::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(45deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1));
    border-radius: 50%;
    transform: translate(30px, -30px);
  }
  
  .profile-header {
    padding: 20px 30px 15px 30px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
  }
  
  .profile-header h3 {
    color: #a855f7;
    margin: 0;
    font-size: 1.3em;
    font-weight: 600;
  }
  
  .profile-header i {
    color: #a855f7;
    font-size: 1.2em;
  }
  
  .profile-content {
    padding: 25px 30px;
  }
  
  .profile-item {
    display: flex;
    margin-bottom: 15px;
    align-items: flex-start;
    gap: 15px;
  }
  
  .profile-item:last-child {
    margin-bottom: 0;
  }
  
  .profile-label {
    font-weight: 600;
    color: var(--label-color);
    min-width: 140px;
    flex-shrink: 0;
  }
  
  .profile-value {
    color: var(--text-color);
    line-height: 1.4;
    flex-grow: 1;
  }
  
  .profile-note {
    margin-top: 5px;
    padding: 8px 12px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 6px;
    font-size: 0.9em;
    color: var(--label-color);
    border-left: 3px solid #667eea;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .profile-note i {
    color: #667eea;
    font-size: 0.9em;
  }
  
  .blog-posts {
    display: flex;
    flex-direction: column;
    gap: 25px;
  }
  
  .blog-article {
    background: var(--section-bg);
    border-radius: 12px;
    padding: 25px;
    border-left: 4px solid #667eea;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .blog-article:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
  
  .blog-article h4 {
    color: var(--text-color);
    font-size: 1.3em;
    font-weight: 600;
    margin: 0 0 12px 0;
    line-height: 1.4;
  }
  
  .article-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  
  .article-date,
  .article-author {
    font-size: 0.9em;
    color: var(--label-color);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .article-summary {
    color: var(--text-color);
    line-height: 1.6;
    margin-bottom: 15px;
    font-size: 0.95em;
  }
  
  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
  }
  
  .tag {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    font-size: 0.8em;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }
  
  .read-more {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95em;
    transition: color 0.3s ease;
    display: inline-flex;
    align-items: center;
  }
  
  .read-more:hover {
    color: #5a67d8;
    text-decoration: underline;
  }
  
  .author-intro {
    background: var(--section-bg);
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 20px;
  }
  
  .author-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .author-info h2 {
    color: var(--text-color);
    margin-bottom: 10px;
  }
  
  .author-info p {
    color: var(--label-color);
    line-height: 1.6;
  }
    
    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
        padding-top: 80px;
      }
      
      .sidebar {
        left: -250px;
      }
      
      .sidebar.active {
        left: 0;
      }
      
      .author-intro {
        flex-direction: column;
        text-align: center;
      }
      
      .hero-section h1 {
        font-size: 2em;
      }
      
      .profile-item {
        flex-direction: column;
        gap: 5px;
        align-items: flex-start;
      }
      
      .profile-label {
        min-width: auto;
      }
      
      .article-meta {
        flex-direction: column;
        gap: 8px;
      }
      
      .blog-header h1 {
        font-size: 2em;
      }
      
      .blog-article {
        padding: 20px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Logo">
      <h2>Harry's Hub</h2>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a href="#home" class="nav-link active" data-page="home"><i class="fas fa-home"></i> <span class="i18n" data-key="home">Home</span></a></li>
      <li class="nav-item"><a href="#calculator" class="nav-link" data-page="calculator"><i class="fas fa-calculator"></i> <span class="i18n" data-key="calculator">Calculator</span></a></li>
    </ul>
    <div class="language-selector">
        <select id="languageSelector" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="es">Español</option>
            <option value="zh">中文</option>
            <option value="pt">Português</option>
        </select>
    </div>
  </div>

  <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>


  <div class="main-content">
    <!-- Home Page -->
    <div id="homePage" class="page-content active">
      <div class="container">
        <div class="hero-section">
          <h1 class="i18n" data-key="welcomeTitle">Welcome to Harry's Genshin Hub</h1>
          <p class="i18n" data-key="welcomeSubtitle">Your ultimate destination for Genshin Impact calculations, insights, and resources</p>
        </div>
        
        <!-- Creator's Profile -->
        <div class="creator-profile">
          <div class="profile-header">
            <i class="fas fa-user-circle" style="margin-right: 10px;"></i>
            <h3>Creator's Profile</h3>
          </div>
          <div class="profile-content">
            <div class="profile-item">
              <span class="profile-label">Name:</span>
              <span class="profile-value">Harry</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Playing Since:</span>
              <span class="profile-value">Version 1.6</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Favorite Character:</span>
              <span class="profile-value">Columbina (Damselette)</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Current Goal:</span>
              <span class="profile-value">Saving Pulls For Columbina</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Location:</span>
              <span class="profile-value">I'm a Student Living In Japan</span>
            </div>
          </div>
        </div>
        
        <div class="feature-grid">
          <div class="feature-card">
            <div class="feature-icon">📊</div>
            <h3 class="i18n" data-key="calculatorTitle">Pull Calculator</h3>
            <p class="i18n" data-key="calculatorDesc">Advanced probability calculations with Radiance Pity support and Monte Carlo simulations</p>
            <button onclick="showPage('calculator')" class="i18n" data-key="tryCalculator">Try Calculator</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculator Page -->
    <div id="calculatorPage" class="page-content">
      <div id="mainContainer" class="container">
    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
      <div class="theme-switch">
        <span class="theme-icon">☀️</span>
        <label class="theme-switch-toggle">
          <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
          <span class="slider"></span>
        </label>
        <span class="theme-icon">🌙</span>
      </div>
    </div>
    

    
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Enhanced Genshin Pull Calculator Logo" style="height: 80px; margin-right: 15px;">
      <h1 style="margin: 0;">Enhanced Genshin Pull Calculator</h1>
    </div>
      <div class="credits" style="text-align: center; font-size: 0.9em; margin-bottom: 10px; color: var(--credits-color);">
        Made by Harry
      </div>
      <div class="version-info" style="text-align: center; font-size: 0.8em; margin-bottom: 20px; color: var(--credits-color);">
        <a href="javascript:void(0);" class="version-link" onclick="openChangelogModal(); return false;">Version 5.8</a>
      </div>

    <div class="section">
      <h3>Resources</h3>
      <div class="input-group">
        <div>
          <label for="primos">Primogems:</label>
          <input type="number" id="primos" value="0" min="0" max="999999" step="1" oninput="validateAndUpdateResources(this)">
        </div>
        <div>
          <label for="fates">Intertwined Fates:</label>
          <input type="number" id="fates" value="0" min="0" max="9999" step="1" oninput="validateAndUpdateResources(this)">
        </div>
        <div>
          <label for="genesis">Genesis Crystals:</label>
          <input type="number" id="genesis" value="0" min="0" max="999999" step="1" oninput="validateAndUpdateResources(this)">
        </div>
        <div>
          <label for="stardust">Masterless Stardust:</label>
          <input type="number" id="stardust" value="0" min="0" max="999999" step="75" oninput="validateAndUpdateResources(this)">
        </div>
        <div>
          <label for="starglitter">Masterless Starglitter:</label>
          <input type="number" id="starglitter" value="0" min="0" max="999999" step="5" oninput="validateAndUpdateResources(this)">
        </div>
      </div>
      <div id="resourceSummary" class="cost-breakdown">
        <h4>Total Available Pulls: <span id="totalPulls">0</span></h4>
        <div class="primogem-breakdown">
          <div>Primos: <span id="primoPulls">0</span> pulls</div>
          <div>Fates: <span id="fatePulls">0</span> pulls</div>
          <div>Genesis: <span id="genesisPulls">0</span> pulls</div>
          <div>Stardust: <span id="stardustPulls">0</span> pulls</div>
          <div>Starglitter: <span id="starglitterPulls">0</span> pulls</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Character Banner Goals</h3>
      <div class="checkbox-wrapper">
        <input type="checkbox" id="wantCharacter" onchange="toggleCharacterInputs()" checked>
        <label for="wantCharacter">I want to pull for a character</label>
      </div>
      <div id="characterInputs">
        <div class="input-group">
          <div>
            <label for="constellations">Constellation Goal:</label>
            <select id="constellations">
              <option value="0">C0 (Base Character)</option>
              <option value="1">C1</option>
              <option value="2">C2</option>
              <option value="3">C3</option>
              <option value="4">C4</option>
              <option value="5">C5</option>
              <option value="6">C6</option>
            </select>
          </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="charPity">Character Pity:</label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Soft Pity:</strong> 5★ pull rates increase significantly after pull 73. The base 0.6% rate increases gradually up to 100% at pull 90 (hard pity). Most 5★ characters are obtained between pulls 76-82.
              </div>
            </span>
          </div>
          <input type="number" id="charPity" min="0" max="89" value="0" oninput="updatePityProgress()">
          <div class="progress-bar">
            <div id="charPityProgress" class="progress-fill" style="width: 0%"></div>
          </div>
        </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="charGuaranteed">Next Character Guaranteed?</label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Guaranteed:</strong> When you get a 5★ character, there's a 50% chance it's the featured character (winning the 50/50). If you lose and get a standard 5★, your next 5★ character is guaranteed to be the featured one.
              </div>
            </span>
          </div>
          <select id="charGuaranteed">
            <option value="false">No (50/50)</option>
            <option value="true">Yes (Guaranteed)</option>
          </select>
        </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="radiancePity">Radiance Pity: <span id="radiancePityDisplay">0 / 3</span></label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Radiance Pity:</strong> Modifies the 50/50 chance on Character Event banners. Base chance is 50%, increased to ~55% after 1 loss, ~75% after 2 losses, and guaranteed at 3 losses. Counter resets after a win or guarantee. Not applicable to Weapon or Standard banners.
              </div>
            </span>
          </div>
          <select id="radiancePity" onchange="updateRadiancePityDisplay()">
            <option value="0">0 consecutive losses (50% chance)</option>
            <option value="1">1 consecutive loss (~55% chance)</option>
            <option value="2">2 consecutive losses (~75% chance)</option>
            <option value="3">3 consecutive losses (100% guaranteed)</option>
          </select>
        </div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>Weapon Banner Goals</h3>
      <div class="checkbox-wrapper">
        <input type="checkbox" id="wantWeapon" onchange="toggleWeaponInputs()">
        <label for="wantWeapon">I want to pull for a weapon</label>
      </div>
      <div id="weaponInputs" style="display: none;">
        <div class="input-group">
          <div>
            <label for="refinements">Refinement Goal:</label>
            <select id="refinements">
              <option value="0">R1 (Base Weapon)</option>
              <option value="1">R2</option>
              <option value="2">R3</option>
              <option value="3">R4</option>
              <option value="4">R5</option>
            </select>
          </div>
          <div>
            <label for="weapPity">Weapon Pity:</label>
            <input type="number" id="weapPity" min="0" max="79" value="0" oninput="updatePityProgress()">
            <div class="progress-bar">
              <div id="weapPityProgress" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <label for="weapGuaranteed">Next Weapon Guaranteed?</label>
            <select id="weapGuaranteed">
              <option value="false">No (66.7% chance)</option>
              <option value="true">Yes (Guaranteed)</option>
            </select>
          </div>
        <div>
          <div class="tooltip-wrapper">
            <label for="fatepoints">Fate Points:</label>
            <span class="tooltip-icon">
              ?
              <div class="tooltip">
                <strong>Fate Points:</strong> Part of the Epitomized Path system. Each time you get a 5★ weapon that isn't your selected target, you gain 1 Fate Point. At 2 Fate Points, your next 5★ weapon is guaranteed to be your selected target. Points reset when you get the target weapon or change banners.
              </div>
            </span>
          </div>
          <select id="fatepoints">
            <option value="0">0 Points</option>
            <option value="1">1 Point (Next Guaranteed)</option>
          </select>
        </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Simulation Settings</h3>
      <div class="input-group">
        <div>
          <label for="simulations">Number of Simulations:</label>
          <select id="simulations">
            <option value="1000">1,000 (Fast)</option>
            <option value="10000" selected>10,000 (Recommended)</option>
            <option value="100000">100,000 (Precise)</option>
          </select>
        </div>
        <div>
          <label for="luckMode">Analysis Mode:</label>
          <select id="luckMode">
            <option value="simulation">Monte Carlo Simulation</option>
            <option value="scenarios">Luck Scenarios</option>
            <option value="both" selected>Both</option>
          </select>
        </div>
      </div>

      <div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 14px; line-height: 1.5;">
        <h4 style="margin: 0 0 10px 0; color: #333;">Analysis Mode Explanations:</h4>
        <p><strong>Monte Carlo Simulation:</strong> Runs thousands of random pull sessions to calculate realistic probability distributions. This method accounts for the randomness of gacha mechanics and provides statistical confidence intervals.</p>
        <p><strong>Luck Scenarios:</strong> Shows deterministic calculations for best-case (win all 50/50s), worst-case (lose all 50/50s), and expected outcomes. Useful for planning and budgeting.</p>
        <p><strong>Both:</strong> Combines simulation results with scenario analysis for comprehensive insights into your pulling strategy.</p>
      </div>
    </div>

    <button id="calculateBtn" onclick="calculate()">
      Calculate Probabilities
      <div class="loading-spinner"></div>
    </button>

    <div id="results"></div>

    <div class="section">
      <div class="chart-container">
        <canvas id="resultsChart"></canvas>
      </div>
    </div>
    
    <div class="section">
      <h3>Save/Load Configuration</h3>
      <div class="input-group">
        <div>
          <button onclick="saveConfiguration()" style="margin-top: 0;">Save Current Configuration</button>
        </div>
        <div>
          <button onclick="loadConfiguration()" style="margin-top: 0;">Load Saved Configuration</button>
        </div>
        <div>
          <button onclick="exportConfiguration()" style="margin-top: 0;">Export Configuration</button>
        </div>
        <div>
          <button onclick="document.getElementById('importFile').click()" style="margin-top: 0;">Import Configuration</button>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfiguration(event)">
        </div>
        <div>
          <button onclick="exportResults()" style="margin-top: 0;" id="exportResultsBtn" disabled>Export Results (CSV)</button>
        </div>
      </div>
    </div>
    
    
    <!-- Changelog Modal -->
    <div id="changelogModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeChangelogModal()">&times;</span>
        <h2 style="color: var(--text-color); margin-top: 0;">Changelog</h2>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.8</div>
          <div class="changelog-date">August 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>✨ Added rich tooltips with detailed explanations for key mechanics</li>
              <li>🎨 Enhanced dark mode with better theme persistence</li>
              <li>📱 Improved mobile responsiveness and layout</li>
              <li>💾 Added automatic input persistence using localStorage</li>
              <li>📊 Enhanced probability charts with better visualization</li>
              <li>🔄 Added version tracking and changelog modal</li>
              <li>🔧 Fixed duplicate mechanics: removed outdated Capturing Radiance, kept unified Radiance Pity system</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.7</div>
          <div class="changelog-date">July 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>🎯 Added Radiance Pity system for v5.0+ mechanics</li>
              <li>⚡ Improved Monte Carlo simulation performance</li>
              <li>📊 Enhanced chart rendering with better error handling</li>
              <li>🔧 Bug fixes for edge cases in probability calculations</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.6</div>
          <div class="changelog-date">June 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>🎲 Added comprehensive Monte Carlo simulation system</li>
              <li>📊 Implemented Chart.js for probability distribution graphs</li>
              <li>💰 Enhanced resource calculation with multiple currency types</li>
              <li>⚙️ Added save/load configuration functionality</li>
            </ul>
          </div>
        </div>
        
        <div class="changelog-item">
          <div class="changelog-version">Version 5.5</div>
          <div class="changelog-date">May 2025</div>
          <div class="changelog-changes">
            <ul>
              <li>🏹 Initial weapon banner support with Epitomized Path</li>
              <li>🎯 Added soft pity calculations for character and weapon banners</li>
              <li>📱 Basic responsive design implementation</li>
              <li>🎨 Modern UI with gradient backgrounds and animations</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Blog/Changelog Page -->
    <div id="changelogPage" class="page-content">
      <div class="container">
        <div class="blog-header">
          <h1>📝 Changelog & Updates</h1>
          <div class="blog-divider"></div>
        </div>
        
        <!-- Author Profile -->
        <div class="operator-profile">
          <div class="profile-header">
            <i class="fas fa-user-circle" style="margin-right: 10px;"></i>
            <h3>About Harry</h3>
          </div>
          <div class="profile-content">
            <div class="profile-item">
              <span class="profile-label">Role:</span>
              <span class="profile-value">Developer & Genshin Impact Enthusiast</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Specialties:</span>
              <span class="profile-value">Probability Theory, Game Mechanics Analysis, Web Development</span>
            </div>
            <div class="profile-item">
              <span class="profile-label">Bio:</span>
              <span class="profile-value">
                Passionate Genshin Impact player and developer with a love for mathematics and probability theory. 
                I created this calculator to help fellow Travelers make informed decisions about their wish strategies.
                <div class="profile-note">
                  <i class="fas fa-lightbulb"></i>
                  When I'm not coding, you can find me exploring Teyvat and theorycrafting optimal team compositions.
                </div>
              </span>
            </div>
          </div>
        </div>
        
        <!-- Changelog Entries -->
        <div class="blog-posts">
          <div class="blog-article">
            <div class="featured-badge">Latest</div>
            <h4>Version 5.8 - Enhanced Features & UI</h4>
            <div class="article-meta">
              <div class="article-date">
                <i class="fas fa-calendar"></i>
                January 15, 2025
              </div>
              <div class="article-author">
                <i class="fas fa-user"></i>
                Harry
              </div>
            </div>
            <div class="article-summary">
              A comprehensive breakdown of the latest features added to our pull calculator, including enhanced Radiance Pity mechanics and improved Monte Carlo simulations.
            </div>
            <div class="article-tags">
              <span class="tag">Updates</span>
              <span class="tag">Calculator</span>
              <span class="tag">Features</span>
              <span class="tag">Radiance Pity</span>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
              <ul style="margin: 0; color: var(--text-color);">
                <li>✨ Added rich tooltips with detailed explanations for key mechanics</li>
                <li>🎨 Enhanced dark mode with better theme persistence</li>
                <li>📱 Improved mobile responsiveness and layout</li>
                <li>💾 Added automatic input persistence using localStorage</li>
                <li>📊 Enhanced probability charts with better visualization</li>
                <li>🔄 Added version tracking and changelog modal</li>
                <li>🔧 Fixed duplicate mechanics: removed outdated Capturing Radiance, kept unified Radiance Pity system</li>
              </ul>
            </div>
          </div>
          
          <div class="blog-article">
            <h4>Version 5.7 - Radiance Pity System</h4>
            <div class="article-meta">
              <div class="article-date">
                <i class="fas fa-calendar"></i>
                December 28, 2024
              </div>
              <div class="article-author">
                <i class="fas fa-user"></i>
                Harry
              </div>
            </div>
            <div class="article-summary">
              Added comprehensive support for the Radiance Pity system introduced in Genshin Impact 5.0, with improved simulation accuracy.
            </div>
            <div class="article-tags">
              <span class="tag">Updates</span>
              <span class="tag">Radiance Pity</span>
              <span class="tag">Monte Carlo</span>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
              <ul style="margin: 0; color: var(--text-color);">
                <li>🎯 Added Radiance Pity system for v5.0+ mechanics</li>
                <li>⚡ Improved Monte Carlo simulation performance</li>
                <li>📊 Enhanced chart rendering with better error handling</li>
                <li>🔧 Bug fixes for edge cases in probability calculations</li>
              </ul>
            </div>
          </div>
          
          <div class="blog-article">
            <h4>Strategic Wishing Guide</h4>
            <div class="article-meta">
              <div class="article-date">
                <i class="fas fa-calendar"></i>
                December 15, 2024
              </div>
              <div class="article-author">
                <i class="fas fa-user"></i>
                Harry
              </div>
            </div>
            <div class="article-summary">
              Learn how to approach wish planning from a mathematical perspective, optimizing your pulls for maximum value whether you're F2P or spending.
            </div>
            <div class="article-tags">
              <span class="tag">Guide</span>
              <span class="tag">Strategy</span>
              <span class="tag">Mathematics</span>
              <span class="tag">F2P</span>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
              <p style="margin: 0 0 10px 0;"><strong>Key Topics:</strong></p>
              <ul style="margin: 0; color: var(--text-color);">
                <li>📊 Understanding probability distributions and soft pity</li>
                <li>⏰ Building optimal wish timelines</li>
                <li>💰 Risk management strategies for different spending levels</li>
                <li>🎯 Maximizing value from limited resources</li>
              </ul>
            </div>
          </div>
          
          <div class="blog-article">
            <h4>Version 5.6 - Major Simulation Overhaul</h4>
            <div class="article-meta">
              <div class="article-date">
                <i class="fas fa-calendar"></i>
                November 20, 2024
              </div>
              <div class="article-author">
                <i class="fas fa-user"></i>
                Harry
              </div>
            </div>
            <div class="article-summary">
              Complete rewrite of the simulation engine with Chart.js integration and advanced resource management features.
            </div>
            <div class="article-tags">
              <span class="tag">Updates</span>
              <span class="tag">Monte Carlo</span>
              <span class="tag">Charts</span>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
              <ul style="margin: 0; color: var(--text-color);">
                <li>🎲 Added comprehensive Monte Carlo simulation system</li>
                <li>📊 Implemented Chart.js for probability distribution graphs</li>
                <li>💰 Enhanced resource calculation with multiple currency types</li>
                <li>⚙️ Added save/load configuration functionality</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Featured Badge Styles -->
        <style>
          .featured-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 0.7em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
          }
          
          .blog-article {
            position: relative;
          }
          
          .blog-controls select, .blog-controls input {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            background: var(--container-bg);
            color: var(--text-color);
            font-size: 14px;
          }
          
          .blog-controls select:focus, .blog-controls input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
          }
        </style>
      </div>
    </div>

  </div>
</div>
<script>
// Multi-language support
const translations = {
  en: {
    home: 'Home',
    calculator: 'Calculator',
    blog: 'Blog',
    changelog: 'Changelog',
    settings: 'Settings',
    welcomeTitle: 'Welcome to Harry\'s Genshin Hub',
    welcomeSubtitle: 'Your ultimate destination for Genshin Impact calculations, insights, and resources',
    calculatorTitle: 'Pull Calculator',
    calculatorDesc: 'Advanced probability calculations with Radiance Pity support and Monte Carlo simulations',
    tryCalculator: 'Try Calculator',
    blogTitle: 'Blog & Insights',
    blogDesc: 'Tips, guides, and analysis of Genshin Impact mechanics and meta',
    readBlog: 'Read Blog',
    readChangelog: 'View Changelog',
    settingsTitle: 'Settings',
    settingsDesc: 'Customize your experience with theme and language preferences',
    openSettings: 'Open Settings',
    aboutHarry: 'About Harry',
    harryBio: 'Passionate Genshin Impact player and developer with a love for mathematics and probability theory. I created this calculator to help fellow Travelers make informed decisions about their wish strategies. When I\'m not coding, you can find me exploring Teyvat and theorycrafting optimal team compositions.',
    recentPosts: 'Recent Posts',
    appearance: 'Appearance',
    themeLabel: 'Theme:',
    language: 'Language',
    selectLanguage: 'Select Language:',
    dataManagement: 'Data Management',
    clearAllData: 'Clear All Data',
    clearDataDesc: 'Remove all saved configurations and preferences',
    exportData: 'Export All Data',
    exportDataDesc: 'Download all your data as a backup file',
    about: 'About',
    appDescription: 'Harry\'s Genshin Hub is an advanced probability calculator for Genshin Impact wish mechanics, featuring Radiance Pity support, Monte Carlo simulations, and comprehensive analysis tools.',
    version: 'Version:',
    developer: 'Developer:'
  },
  ja: {
    home: 'ホーム',
    calculator: '計算機',
    blog: 'ブログ',
    changelog: '変更履歴',
    settings: '設定',
    welcomeTitle: 'ハリーの原神ハブへようこそ',
    welcomeSubtitle: '原神の計算、洞察、リソースの究極の目的地',
    calculatorTitle: '祈願計算機',
    calculatorDesc: 'ラディアンス天井サポートとモンテカルロシミュレーションによる高度な確率計算',
    tryCalculator: '計算機を試す',
    blogTitle: 'ブログ・洞察',
    blogDesc: '原神のメカニクスとメタのヒント、ガイド、分析',
    readBlog: 'ブログを読む',
    readChangelog: '変更履歴を見る',
    settingsTitle: '設定',
    settingsDesc: 'テーマと言語設定でエクスペリエンスをカスタマイズ',
    openSettings: '設定を開く',
    aboutHarry: 'ハリーについて',
    harryBio: '数学と確率論を愛する情熱的な原神プレイヤー兼開発者です。仲間の旅人が祈願戦略について十分な情報に基づいた決定を下せるよう、この計算機を作成しました。コーディングをしていない時は、テイワットを探索し、最適なチーム構成を理論構築しています。',
    recentPosts: '最新の投稿',
    appearance: '外観',
    themeLabel: 'テーマ:',
    language: '言語',
    selectLanguage: '言語を選択:',
    dataManagement: 'データ管理',
    clearAllData: 'すべてのデータを削除',
    clearDataDesc: '保存されたすべての構成と設定を削除',
    exportData: 'すべてのデータをエクスポート',
    exportDataDesc: 'バックアップファイルとしてすべてのデータをダウンロード',
    about: 'について',
    appDescription: 'ハリーの原神ハブは、ラディアンス天井サポート、モンテカルロシミュレーション、包括的な分析ツールを特徴とする原神祈願メカニクス用の高度な確率計算機です。',
    version: 'バージョン:',
    developer: '開発者:'
  },
  es: {
    home: 'Inicio',
    calculator: 'Calculadora',
    blog: 'Blog',
    changelog: 'Registro de cambios',
    settings: 'Configuración',
    welcomeTitle: 'Bienvenido al Hub Genshin de Harry',
    welcomeSubtitle: 'Tu destino definitivo para cálculos, perspectivas y recursos de Genshin Impact',
    calculatorTitle: 'Calculadora de Deseos',
    calculatorDesc: 'Cálculos de probabilidad avanzados con soporte de Radiance Pity y simulaciones Monte Carlo',
    tryCalculator: 'Probar Calculadora',
    blogTitle: 'Blog y Perspectivas',
    blogDesc: 'Consejos, guías y análisis de mecánicas y meta de Genshin Impact',
    readBlog: 'Leer Blog',
    readChangelog: 'Ver Registro de cambios',
    settingsTitle: 'Configuración',
    settingsDesc: 'Personaliza tu experiencia con preferencias de tema e idioma',
    openSettings: 'Abrir Configuración',
    aboutHarry: 'Acerca de Harry',
    harryBio: 'Jugador apasionado de Genshin Impact y desarrollador con amor por las matemáticas y la teoría de probabilidades. Creé esta calculadora para ayudar a mis compañeros Viajeros a tomar decisiones informadas sobre sus estrategias de deseos. Cuando no estoy programando, puedes encontrarme explorando Teyvat y teorizando composiciones óptimas de equipos.',
    recentPosts: 'Publicaciones Recientes',
    appearance: 'Apariencia',
    themeLabel: 'Tema:',
    language: 'Idioma',
    selectLanguage: 'Seleccionar Idioma:',
    dataManagement: 'Gestión de Datos',
    clearAllData: 'Borrar Todos los Datos',
    clearDataDesc: 'Eliminar todas las configuraciones y preferencias guardadas',
    exportData: 'Exportar Todos los Datos',
    exportDataDesc: 'Descargar todos tus datos como archivo de respaldo',
    about: 'Acerca de',
    appDescription: 'El Hub Genshin de Harry es una calculadora de probabilidad avanzada para las mecánicas de deseos de Genshin Impact, con soporte de Radiance Pity, simulaciones Monte Carlo y herramientas de análisis integral.',
    version: 'Versión:',
    developer: 'Desarrollador:'
  },
  zh: {
    home: '首页',
    calculator: '计算器',
    blog: '博客',
    changelog: '更新日志',
    settings: '设置',
    welcomeTitle: '欢迎来到Harry的原神中心',
    welcomeSubtitle: '您进行原神计算、洞察和资源的终极目的地',
    calculatorTitle: '抽卡计算器',
    calculatorDesc: '具有辉光同调支持和蒙特卡洛模拟的高级概率计算',
    tryCalculator: '试用计算器',
    blogTitle: '博客与洞察',
    blogDesc: '原神机制和元游戏的技巧、指南和分析',
    readBlog: '阅读博客',
    readChangelog: '查看更新日志',
    settingsTitle: '设置',
    settingsDesc: '通过主题和语言偏好自定义您的体验',
    openSettings: '打开设置',
    aboutHarry: '关于Harry',
    harryBio: '热情的原神玩家和开发者，热爱数学和概率论。我创建了这个计算器来帮助同为旅行者的伙伴们在祈愿策略上做出明智的决定。当我不在编程时，你可以发现我在探索提瓦特大陆并理论构建最佳队伍组合。',
    recentPosts: '最新帖子',
    appearance: '外观',
    themeLabel: '主题:',
    language: '语言',
    selectLanguage: '选择语言:',
    dataManagement: '数据管理',
    clearAllData: '清除所有数据',
    clearDataDesc: '删除所有已保存的配置和偏好',
    exportData: '导出所有数据',
    exportDataDesc: '将所有数据下载为备份文件',
    about: '关于',
    appDescription: 'Harry的原神中心是一个针对原神祈愿机制的高级概率计算器，具有辉光同调支持、蒙特卡洛模拟和综合分析工具。',
    version: '版本:',
    developer: '开发者:'
  },
  pt: {
    home: 'Início',
    calculator: 'Calculadora',
    blog: 'Blog',
    changelog: 'Registo de alterações',
    settings: 'Definições',
    welcomeTitle: 'Bem-vindo ao Hub Genshin de Harry',
    welcomeSubtitle: 'O seu destino final para cálculos, insights e recursos do Genshin Impact',
    calculatorTitle: 'Calculadora de Puxadas',
    calculatorDesc: 'Cálculos de probabilidade avançados com suporte de Radiance Pity e simulações de Monte Carlo',
    tryCalculator: 'Experimente a Calculadora',
    blogTitle: 'Blog e Insights',
    blogDesc: 'Dicas, guias e análises das mecânicas e meta do Genshin Impact',
    readBlog: 'Ler o Blog',
    readChangelog: 'Ver Registo de Alterações',
    settingsTitle: 'Definições',
    settingsDesc: 'Personalize a sua experiência com preferências de tema e idioma',
    openSettings: 'Abrir Definições',
    aboutHarry: 'Sobre o Harry',
    harryBio: 'Jogador apaixonado de Genshin Impact e desenvolvedor com amor pela matemática e teoria da probabilidade. Criei esta calculadora para ajudar outros Viajantes a tomar decisões informadas sobre as suas estratégias de puxadas. Quando não estou a programar, podem encontrar-me a explorar Teyvat e a teorizar sobre composições de equipa ideais.',
    recentPosts: 'Publicações Recentes',
    appearance: 'Aparência',
    themeLabel: 'Tema:',
    language: 'Idioma',
    selectLanguage: 'Selecionar Idioma:',
    dataManagement: 'Gestão de Dados',
    clearAllData: 'Limpar Todos os Dados',
    clearDataDesc: 'Remover todas as configurações e preferências guardadas',
    exportData: 'Exportar Todos os Dados',
    exportDataDesc: 'Descarregar todos os seus dados como um ficheiro de backup',
    about: 'Sobre',
    appDescription: 'O Hub Genshin de Harry é uma calculadora de probabilidade avançada para as mecânicas de puxadas do Genshin Impact, com suporte de Radiance Pity, simulações de Monte Carlo e ferramentas de análise abrangentes.',
    version: 'Versão:',
    developer: 'Desenvolvedor:'
  }
};

let currentLanguage = 'en';

// Navigation functions
function showPage(pageName) {
  console.log("Switching to page:", pageName);
  
  // Hide all pages
  document.querySelectorAll('.page-content').forEach(page => {
    page.classList.remove('active');
    console.log("Hiding page:", page.id);
  });
  
  // Show selected page
  const targetPage = document.getElementById(pageName + 'Page');
  if (targetPage) {
    targetPage.classList.add('active');
    console.log("Showing page:", targetPage.id, "Classes:", targetPage.className);
    
    // Initialize blog posts when showing the changelog/blog page
    if (pageName === 'changelog') {
      loadBlogPosts();
    }
  } else {
    console.error("Page not found:", pageName + 'Page');
  }
  
  // Update navigation
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  const activeLink = document.querySelector(`[data-page="${pageName}"]`);
  if (activeLink) {
    activeLink.classList.add('active');
  }
  
  // Close sidebar on mobile after navigation
  if (window.innerWidth <= 768) {
    document.querySelector('.sidebar').classList.remove('active');
  }
}

// Navigation click listeners will be set up in the main DOMContentLoaded listener

// Sidebar toggle function
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('active');
}

// Language functions
function changeLanguage(lang) {
  currentLanguage = lang;
  localStorage.setItem('selectedLanguage', lang);
  
  // Update all translation elements
  document.querySelectorAll('.i18n').forEach(element => {
    const key = element.getAttribute('data-key');
    if (translations[lang] && translations[lang][key]) {
      if (element.tagName === 'INPUT' && element.type === 'button') {
        element.value = translations[lang][key];
      } else {
        element.textContent = translations[lang][key];
      }
    }
  });
  
  // Update language selector
  document.getElementById('languageSelector').value = lang;
  // Only update settings language selector if it exists
  const settingsLanguage = document.getElementById('settingsLanguage');
  if (settingsLanguage) {
    settingsLanguage.value = lang;
  }
}

// Settings page functions
function clearAllData() {
  if (confirm('Are you sure you want to clear all saved data? This action cannot be undone.')) {
    localStorage.clear();
    alert('All data has been cleared. The page will now reload.');
    location.reload();
  }
}

function exportAllData() {
  const allData = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    allData[key] = localStorage.getItem(key);
  }
  
  const dataStr = JSON.stringify(allData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `genshin-hub-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Additional CSS for blog and settings
const additionalStyles = `
  .setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 15px 0;
    padding: 15px 0;
    border-bottom: 1px solid var(--border-color);
  }
  
  .setting-description {
    font-size: 0.9em;
    color: var(--label-color);
    margin: 5px 0 0 0;
  }
  
  .danger-btn {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
  }
  
  .danger-btn:hover {
    background: linear-gradient(45deg, #ff5252, #d63031) !important;
  }
  
`;

// Inject additional styles
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);

class GenshinCalculator {
  constructor() {
    this.baseRates = {
      character: { fiveStar: 0.006, fourStar: 0.051 },
      weapon: { fiveStar: 0.007, fourStar: 0.06 }
    };
    this.hardPity = { character: 90, weapon: 80 };
    this.softPityStart = { character: 74, weapon: 63 };
  }

  getPullProbability(pity, banner) {
    const baseRate = this.baseRates[banner].fiveStar;
    const softStart = this.softPityStart[banner];
    const hardLimit = this.hardPity[banner];
    if (pity >= hardLimit - 1) return 1.0;
    if (pity < softStart) return baseRate;
    const softPityProgress = (pity - softStart + 1) / (hardLimit - softStart);
    return Math.min(baseRate + (1 - baseRate) * Math.pow(softPityProgress, 2), 1.0);
  }

  // Get the effective win rate based on Radiance Pity
  getRadianceWinRate(radiancePityCount) {
    switch (radiancePityCount) {
      case 0: return 0.50; // 50% base chance
      case 1: return 0.55; // ~55% after 1 loss
      case 2: return 0.75; // ~75% after 2 losses
      case 3: return 1.00; // 100% guaranteed after 3 losses
      default: return 0.50;
    }
  }

  simulateSession(banner, goal, currentPity, isGuaranteed, fatePoints, availablePulls, radiancePity = 0) {
    let pity = currentPity, guaranteed = isGuaranteed, weaponPoints = fatePoints;
    let currentRadiancePity = radiancePity;
    let pullsUsed = 0, fiveStarsObtained = 0, targetObtained = 0;
    
    while (targetObtained < goal && pullsUsed < availablePulls) {
      pullsUsed++;
      pity++;
      const pullProb = this.getPullProbability(pity - 1, banner);
      const gotFiveStar = Math.random() < pullProb;
      
      if (gotFiveStar) {
        fiveStarsObtained++;
        pity = 0;
        
        if (banner === 'character') {
          if (guaranteed) {
            // Already guaranteed, definitely get featured character
            targetObtained++; 
            guaranteed = false;
            currentRadiancePity = 0; // Reset on guarantee
          } else {
            // Apply Radiance Pity modified chances
            const effectiveWinRate = this.getRadianceWinRate(currentRadiancePity);
            const wonFiftyFifty = Math.random() < effectiveWinRate;
            
            if (wonFiftyFifty) {
              // Won the modified 50/50, got featured character
              targetObtained++; 
              guaranteed = false;
              currentRadiancePity = 0; // Reset on win
            } else {
              // Lost the modified 50/50, got standard character
              // Standard loss, next is guaranteed and increment Radiance Pity
              guaranteed = true;
              currentRadiancePity = Math.min(3, currentRadiancePity + 1);
            }
          }
        } else {
          // Weapon banner logic (unchanged)
          if (weaponPoints >= 1 || Math.random() < 1/3) {
            targetObtained++; weaponPoints = 0;
          } else weaponPoints++;
        }
      }
    }
    
    return {
      success: targetObtained >= goal,
      pullsUsed,
      fiveStarsObtained,
      finalPity: pity,
      finalGuaranteed: guaranteed,
      finalWeaponPoints: weaponPoints,
      finalRadiancePity: currentRadiancePity
    };
  }

  simulateCombinedSession(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls, radiancePity = 0) {
    let totalPullsUsed = 0, charObtained = 0, weapObtained = 0;
    let charSuccess = false, weapSuccess = false;
    
    if (charGoal > 0) {
      const charResult = this.simulateSession('character', charGoal, charPity, charGuaranteed, 0, availablePulls, radiancePity);
      charObtained = charResult.fiveStarsObtained;
      totalPullsUsed += charResult.pullsUsed;
      charSuccess = charResult.success;
    } else {
      charSuccess = true; // No character goal means automatic success
    }
    
    if (weapGoal > 0 && totalPullsUsed < availablePulls) {
      const weapResult = this.simulateSession('weapon', weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls - totalPullsUsed, 0);
      weapObtained = weapResult.fiveStarsObtained;
      totalPullsUsed += weapResult.pullsUsed;
      weapSuccess = weapResult.success;
    } else if (weapGoal === 0) {
      weapSuccess = true; // No weapon goal means automatic success
    }
    
    return {
      success: charSuccess && weapSuccess,
      totalPullsUsed,
      charObtained,
      weapObtained,
      charSuccess,
      weapSuccess
    };
  }

  runCombinedSimulation(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls, numSims, radiancePity = 0) {
    const results = [];
    let fullSuccess = 0, charSuccess = 0, weapSuccess = 0;
    for (let i = 0; i < numSims; i++) {
      const res = this.simulateCombinedSession(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls, radiancePity);
      results.push(res);
      if (res.success) fullSuccess++;
      if (res.charSuccess || charGoal === 0) charSuccess++;
      if (res.weapSuccess || weapGoal === 0) weapSuccess++;
    }
    const successful = results.filter(r => r.success).map(r => r.totalPullsUsed);
    return {
      fullSuccessRate: fullSuccess / numSims,
      charSuccessRate: charSuccess / numSims,
      weapSuccessRate: weapSuccess / numSims,
      averagePulls: successful.length ? successful.reduce((a,b)=>a+b)/successful.length : 0,
      medianPulls: successful.length ? this.median(successful) : 0,
      percentile90: successful.length ? this.percentile(successful, 0.9) : 0,
      percentile10: successful.length ? this.percentile(successful, 0.1) : 0,
      results
    };
  }

  calculateExpectedPulls(banner, goal, pity, guaranteed, points) {
    const expected = banner === 'character'
      ? (guaranteed ? 75 : 112.5)
      : points >= 2 ? 65 : points === 1 ? 85 : 105;
    return Math.ceil((expected * goal) - pity);
  }

  calculateScenario(banner, goal, pity, guaranteed, points, mode) {
    let total = 0, current = pity, guaranteedFlag = guaranteed, fate = points, obtained = 0;
    while (obtained < goal) {
      if (mode === 'win_all') {
        total += this.getExpectedPullsToNext(banner, current);
        current = 0; guaranteedFlag = false; fate = 0; obtained++;
      } else if (mode === 'lose_all') {
        if (!guaranteedFlag && banner === 'character') {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; guaranteedFlag = true;
        } else if (banner === 'weapon' && fate < 1) {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; fate++;
        } else {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; guaranteedFlag = false; fate = 0; obtained++;
        }
      }
    }
    return Math.ceil(total);
  }

  calculateCombinedScenarios(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, fatePoints) {
    const s = {};
    s.charBest = charGoal ? this.calculateScenario('character', charGoal, charPity, true, 0, 'win_all') : 0;
    s.charWorst = charGoal ? this.calculateScenario('character', charGoal, charPity, charGuaranteed, 0, 'lose_all') : 0;
    s.charExpected = charGoal ? this.calculateExpectedPulls('character', charGoal, charPity, charGuaranteed, 0) : 0;
    s.weapBest = weapGoal ? this.calculateScenario('weapon', weapGoal, weapPity, true, fatePoints, 'win_all') : 0;
    s.weapWorst = weapGoal ? this.calculateScenario('weapon', weapGoal, weapPity, weapGuaranteed, fatePoints, 'lose_all') : 0;
    s.weapExpected = weapGoal ? this.calculateExpectedPulls('weapon', weapGoal, weapPity, weapGuaranteed, fatePoints) : 0;
    s.combinedBest = s.charBest + s.weapBest;
    s.combinedWorst = s.charWorst + s.weapWorst;
    s.combinedExpected = s.charExpected + s.weapExpected;
    return s;
  }

  getExpectedPullsToNext(banner, pity) {
    return pity >= this.softPityStart[banner]
      ? Math.min(5, this.hardPity[banner] - pity)
      : banner === 'character' ? 75 : 65;
  }

  median(arr) {
    const s = arr.slice().sort((a, b) => a - b);
    const m = Math.floor(s.length / 2);
    return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
  }

  percentile(arr, p) {
    const s = arr.slice().sort((a, b) => a - b);
    const i = p * (s.length - 1), l = Math.floor(i), u = Math.ceil(i);
    return s[l] * (u - i) + s[u] * (i - l);
  }
}

const calculator = new GenshinCalculator();

function updateResourceSummary() {
  const p = +document.getElementById('primos').value || 0;
  const f = +document.getElementById('fates').value || 0;
  const g = +document.getElementById('genesis').value || 0;
  const s = +document.getElementById('stardust').value || 0;
  const sg = +document.getElementById('starglitter').value || 0;
  const pp = Math.floor(p / 160), fp = f, gp = Math.floor(g / 160), sp = Math.floor(s / 75), sgp = Math.floor(sg / 5);
  const total = pp + fp + gp + sp + sgp;
  document.getElementById('primoPulls').textContent = pp;
  document.getElementById('fatePulls').textContent = fp;
  document.getElementById('genesisPulls').textContent = gp;
  document.getElementById('stardustPulls').textContent = sp;
  document.getElementById('starglitterPulls').textContent = sgp;
  document.getElementById('totalPulls').textContent = total;
  updatePityProgress();
}

function updatePityProgress() {
  const char = Math.max(0, Math.min(89, +document.getElementById('charPity').value || 0));
  const weap = Math.max(0, Math.min(79, +document.getElementById('weapPity').value || 0));
  
  // Update the input values to match the clamped values
  document.getElementById('charPity').value = char;
  document.getElementById('weapPity').value = weap;
  
  document.getElementById('charPityProgress').style.width = (char / 90 * 100) + '%';
  document.getElementById('weapPityProgress').style.width = (weap / 80 * 100) + '%';
}

function toggleCharacterInputs() {
  const checked = document.getElementById('wantCharacter').checked;
  document.getElementById('characterInputs').style.display = checked ? 'block' : 'none';
}

function toggleWeaponInputs() {
  const checked = document.getElementById('wantWeapon').checked;
  document.getElementById('weaponInputs').style.display = checked ? 'block' : 'none';
}

async function calculate() {
  const calculateBtn = document.getElementById('calculateBtn');
  const totalPulls = +document.getElementById('totalPulls').textContent;
  const wantChar = document.getElementById('wantCharacter').checked;
  const wantWeap = document.getElementById('wantWeapon').checked;
  
  // Input validation
  if (!wantChar && !wantWeap) {
    alert('Please select at least one goal (character or weapon).');
    return;
  }
  
  if (totalPulls === 0) {
    alert('Please enter your available resources (primogems, fates, etc.).');
    return;
  }
  
  // Show loading state
  calculateBtn.classList.add('calculating');
  calculateBtn.disabled = true;
  
  const charGoal = wantChar ? +document.getElementById('constellations').value + 1 : 0;
  const weapGoal = wantWeap ? +document.getElementById('refinements').value + 1 : 0;
  const charPity = Math.max(0, Math.min(89, +document.getElementById('charPity').value || 0));
  const weapPity = Math.max(0, Math.min(79, +document.getElementById('weapPity').value || 0));
  const charGuaranteed = document.getElementById('charGuaranteed').value === 'true';
  const weapGuaranteed = document.getElementById('weapGuaranteed').value === 'true';
  const fatePoints = +document.getElementById('fatepoints').value;
  const radiancePity = wantChar ? +document.getElementById('radiancePity').value : 0;
  const numSims = +document.getElementById('simulations').value;
  const mode = document.getElementById('luckMode').value;

  let output = '<div class="results">';
  
  if (mode === 'simulation' || mode === 'both') {
    const simResults = calculator.runCombinedSimulation(
      charGoal, charPity, charGuaranteed,
      weapGoal, weapPity, weapGuaranteed,
      fatePoints, totalPulls, numSims, radiancePity
    );

    output += '<h3>Monte Carlo Simulation Results</h3>';
    if (wantChar) {
      output += `<p>Character Success Rate: ${(simResults.charSuccessRate * 100).toFixed(1)}%</p>`;
    }
    if (wantWeap) {
      output += `<p>Weapon Success Rate: ${(simResults.weapSuccessRate * 100).toFixed(1)}%</p>`;
    }
    if (wantChar && wantWeap) {
      output += `<p>Overall Success Rate: ${(simResults.fullSuccessRate * 100).toFixed(1)}%</p>`;
    }
    
    if (simResults.averagePulls > 0) {
      output += `<p>For successful attempts:</p>`;
      output += `<ul>`;
      output += `<li>Average pulls needed: ${Math.round(simResults.averagePulls)}</li>`;
      output += `<li>Median pulls needed: ${Math.round(simResults.medianPulls)}</li>`;
      output += `<li>10th percentile (Lucky): ${Math.round(simResults.percentile10)}</li>`;
      output += `<li>90th percentile (Unlucky): ${Math.round(simResults.percentile90)}</li>`;
      output += `</ul>`;
    }
    
    // Create chart for simulation results
    createChart(simResults);
  }

  if (mode === 'scenarios' || mode === 'both') {
    const scenarios = calculator.calculateCombinedScenarios(
      charGoal, charPity, charGuaranteed,
      weapGoal, weapPity, weapGuaranteed,
      fatePoints
    );

    output += '<h3>Luck Scenarios</h3>';
    if (wantChar) {
      output += '<h4>Character Banner</h4>';
      output += `<ul>`;
      output += `<li>Best case (win all 50/50): ${scenarios.charBest} pulls</li>`;
      output += `<li>Expected case: ${scenarios.charExpected} pulls</li>`;
      output += `<li>Worst case (lose all 50/50): ${scenarios.charWorst} pulls</li>`;
      output += `</ul>`;
      
      // Add personalized progress messages for character banner
      output += '<div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid #667eea;">';
      output += '<h5 style="margin: 0 0 10px 0; color: #667eea;">📊 Your Progress Analysis</h5>';
      
      if (totalPulls >= scenarios.charBest) {
        output += `<p style="color: #28a745; font-weight: bold;">🎉 For best case: You have ${totalPulls} pulls - that's ${totalPulls - scenarios.charBest} more than needed! Great job saving up!</p>`;
      } else {
        output += `<p style="color: #dc3545;">😔 For best case: You need ${scenarios.charBest - totalPulls} more pulls to reach the best case scenario.</p>`;
      }
      
      if (totalPulls >= scenarios.charExpected) {
        output += `<p style="color: #28a745; font-weight: bold;">✨ For expected case: You have ${totalPulls} pulls - you're ${totalPulls - scenarios.charExpected} pulls ahead! Excellent preparation!</p>`;
      } else {
        output += `<p style="color: #ffc107;">⚠️ For expected case: You need about ${scenarios.charExpected - totalPulls} more pulls to reach the expected scenario.</p>`;
      }
      
      if (totalPulls >= scenarios.charWorst) {
        output += `<p style="color: #28a745; font-weight: bold;">💪 For worst case: You have ${totalPulls} pulls - you're covered even for bad luck! Amazing planning!</p>`;
      } else {
        output += `<p style="color: #dc3545;">💔 For worst case: You need ${scenarios.charWorst - totalPulls} more pulls to guarantee success even with bad luck.</p>`;
      }
      output += '</div>';
    }
    if (wantWeap) {
      output += '<h4>Weapon Banner</h4>';
      output += `<ul>`;
      output += `<li>Best case: ${scenarios.weapBest} pulls</li>`;
      output += `<li>Expected case: ${scenarios.weapExpected} pulls</li>`;
      output += `<li>Worst case: ${scenarios.weapWorst} pulls</li>`;
      output += `</ul>`;
      
      // Add personalized progress messages for weapon banner
      output += '<div style="margin-top: 15px; padding: 15px; background: rgba(118, 75, 162, 0.1); border-radius: 8px; border-left: 3px solid #764ba2;">';
      output += '<h5 style="margin: 0 0 10px 0; color: #764ba2;">⚔️ Your Weapon Progress Analysis</h5>';
      
      if (totalPulls >= scenarios.weapBest) {
        output += `<p style="color: #28a745; font-weight: bold;">🎉 For best case: You have ${totalPulls} pulls - that's ${totalPulls - scenarios.weapBest} more than needed! Great job saving up!</p>`;
      } else {
        output += `<p style="color: #dc3545;">😔 For best case: You need ${scenarios.weapBest - totalPulls} more pulls to reach the best case scenario.</p>`;
      }
      
      if (totalPulls >= scenarios.weapExpected) {
        output += `<p style="color: #28a745; font-weight: bold;">✨ For expected case: You have ${totalPulls} pulls - you're ${totalPulls - scenarios.weapExpected} pulls ahead! Excellent preparation!</p>`;
      } else {
        output += `<p style="color: #ffc107;">⚠️ For expected case: You need about ${scenarios.weapExpected - totalPulls} more pulls to reach the expected scenario.</p>`;
      }
      
      if (totalPulls >= scenarios.weapWorst) {
        output += `<p style="color: #28a745; font-weight: bold;">💪 For worst case: You have ${totalPulls} pulls - you're covered even for bad luck! Amazing planning!</p>`;
      } else {
        output += `<p style="color: #dc3545;">💔 For worst case: You need ${scenarios.weapWorst - totalPulls} more pulls to guarantee success even with bad luck.</p>`;
      }
      output += '</div>';
    }
    if (wantChar && wantWeap) {
      output += '<h4>Combined Total</h4>';
      output += `<ul>`;
      output += `<li>Best case: ${scenarios.combinedBest} pulls</li>`;
      output += `<li>Expected case: ${scenarios.combinedExpected} pulls</li>`;
      output += `<li>Worst case: ${scenarios.combinedWorst} pulls</li>`;
      output += `</ul>`;
      
      // Add personalized progress messages for combined goals
      output += '<div style="margin-top: 15px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border-left: 3px solid #a855f7;">';
      output += '<h5 style="margin: 0 0 10px 0; color: #a855f7;">🎯 Combined Goals Progress Analysis</h5>';
      
      if (totalPulls >= scenarios.combinedBest) {
        output += `<p style="color: #28a745; font-weight: bold;">🎉 For best case: You have ${totalPulls} pulls - that's ${totalPulls - scenarios.combinedBest} more than needed for both goals! Incredible planning!</p>`;
      } else {
        output += `<p style="color: #dc3545;">😔 For best case: You need ${scenarios.combinedBest - totalPulls} more pulls to get both character and weapon in the best case.</p>`;
      }
      
      if (totalPulls >= scenarios.combinedExpected) {
        output += `<p style="color: #28a745; font-weight: bold;">✨ For expected case: You have ${totalPulls} pulls - you're ${totalPulls - scenarios.combinedExpected} pulls ahead for both goals! Masterful preparation!</p>`;
      } else {
        output += `<p style="color: #ffc107;">⚠️ For expected case: You need about ${scenarios.combinedExpected - totalPulls} more pulls to reach both goals in the expected scenario.</p>`;
      }
      
      if (totalPulls >= scenarios.combinedWorst) {
        output += `<p style="color: #28a745; font-weight: bold;">💪 For worst case: You have ${totalPulls} pulls - you're completely safe even with terrible luck on both banners! Legendary planning!</p>`;
      } else {
        output += `<p style="color: #dc3545;">💔 For worst case: You need ${scenarios.combinedWorst - totalPulls} more pulls to guarantee both goals even with the worst luck.</p>`;
      }
      output += '</div>';
    }
  }

  output += '</div>';
  document.getElementById('results').innerHTML = output;
  
  // Hide loading state
  calculateBtn.classList.remove('calculating');
  calculateBtn.disabled = false;
}
// This function is replaced by the enhanced version above

function saveConfiguration() {
  const config = {
    primos: document.getElementById('primos').value,
    fates: document.getElementById('fates').value,
    genesis: document.getElementById('genesis').value,
    stardust: document.getElementById('stardust').value,
    starglitter: document.getElementById('starglitter').value,
    wantCharacter: document.getElementById('wantCharacter').checked,
    constellations: document.getElementById('constellations').value,
    charPity: document.getElementById('charPity').value,
    charGuaranteed: document.getElementById('charGuaranteed').value,
    radiancePity: document.getElementById('radiancePity').value,
    wantWeapon: document.getElementById('wantWeapon').checked,
    refinements: document.getElementById('refinements').value,
    weapPity: document.getElementById('weapPity').value,
    weapGuaranteed: document.getElementById('weapGuaranteed').value,
    fatepoints: document.getElementById('fatepoints').value,
    simulations: document.getElementById('simulations').value,
    luckMode: document.getElementById('luckMode').value
  };
  
  localStorage.setItem('genshinWishConfig', JSON.stringify(config));
  alert('Configuration saved successfully!');
}

function loadConfiguration() {
  const savedConfig = localStorage.getItem('genshinWishConfig');
  
  if (!savedConfig) {
    alert('No saved configuration found.');
    return;
  }
  
  const config = JSON.parse(savedConfig);
  
  // Load values into form
  document.getElementById('primos').value = config.primos || 0;
  document.getElementById('fates').value = config.fates || 0;
  document.getElementById('genesis').value = config.genesis || 0;
  document.getElementById('stardust').value = config.stardust || 0;
  document.getElementById('starglitter').value = config.starglitter || 0;
  
  document.getElementById('wantCharacter').checked = config.wantCharacter;
  document.getElementById('constellations').value = config.constellations || 0;
  document.getElementById('charPity').value = config.charPity || 0;
  document.getElementById('charGuaranteed').value = config.charGuaranteed || 'false';
  document.getElementById('radiancePity').value = config.radiancePity || 0;
  
  document.getElementById('wantWeapon').checked = config.wantWeapon;
  document.getElementById('refinements').value = config.refinements || 0;
  document.getElementById('weapPity').value = config.weapPity || 0;
  document.getElementById('weapGuaranteed').value = config.weapGuaranteed || 'false';
  document.getElementById('fatepoints').value = config.fatepoints || 0;
  
  document.getElementById('simulations').value = config.simulations || 10000;
  document.getElementById('luckMode').value = config.luckMode || 'both';
  
  // Update UI based on loaded values
  toggleCharacterInputs();
  toggleWeaponInputs();
  updateResourceSummary();
  updateRadiancePityDisplay();
  
  alert('Configuration loaded successfully!');
}

// Theme switcher function
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDarkMode = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDarkMode);
  
  // Update chart if it exists
  if (window.resultsChartInstance) {
    updateChartTheme(isDarkMode);
  }
}

function updateChartTheme(isDarkMode) {
  if (!window.resultsChartInstance) return;
  
  const textColor = isDarkMode ? '#e1e1e1' : '#333';
  
  window.resultsChartInstance.options.scales.x.ticks.color = textColor;
  window.resultsChartInstance.options.scales.y.ticks.color = textColor;
  window.resultsChartInstance.options.scales.x.title.color = textColor;
  window.resultsChartInstance.options.scales.y.title.color = textColor;
  window.resultsChartInstance.options.plugins.title.color = textColor;
  
  window.resultsChartInstance.update();
}


// Enhanced input validation and utilities
function validateAndUpdateResources(input) {
  let value = parseFloat(input.value) || 0;
  const min = parseFloat(input.min) || 0;
  const max = parseFloat(input.max) || Infinity;
  
  // Clamp value to min/max
  value = Math.max(min, Math.min(max, Math.floor(value)));
  input.value = value;
  
  updateResourceSummary();
}

function handleEnterKey(event, callback) {
  if (event.key === 'Enter') {
    event.preventDefault();
    callback();
  }
}

function formatNumber(num) {
  return num.toLocaleString();
}

// Export/Import functionality
function exportConfiguration() {
  const config = {
    primos: document.getElementById('primos').value,
    fates: document.getElementById('fates').value,
    genesis: document.getElementById('genesis').value,
    stardust: document.getElementById('stardust').value,
    starglitter: document.getElementById('starglitter').value,
    wantCharacter: document.getElementById('wantCharacter').checked,
    constellations: document.getElementById('constellations').value,
    charPity: document.getElementById('charPity').value,
    charGuaranteed: document.getElementById('charGuaranteed').value,
    radiancePity: document.getElementById('radiancePity').value,
    wantWeapon: document.getElementById('wantWeapon').checked,
    refinements: document.getElementById('refinements').value,
    weapPity: document.getElementById('weapPity').value,
    weapGuaranteed: document.getElementById('weapGuaranteed').value,
    fatepoints: document.getElementById('fatepoints').value,
    simulations: document.getElementById('simulations').value,
    luckMode: document.getElementById('luckMode').value,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `genshin-calculator-config-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importConfiguration(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const config = JSON.parse(e.target.result);
      
      // Load values into form (same as loadConfiguration)
      document.getElementById('primos').value = config.primos || 0;
      document.getElementById('fates').value = config.fates || 0;
      document.getElementById('genesis').value = config.genesis || 0;
      document.getElementById('stardust').value = config.stardust || 0;
      document.getElementById('starglitter').value = config.starglitter || 0;
      
      document.getElementById('wantCharacter').checked = config.wantCharacter;
      document.getElementById('constellations').value = config.constellations || 0;
      document.getElementById('charPity').value = config.charPity || 0;
      document.getElementById('charGuaranteed').value = config.charGuaranteed || 'false';
      document.getElementById('radiancePity').value = config.radiancePity || 0;
      
      document.getElementById('wantWeapon').checked = config.wantWeapon;
      document.getElementById('refinements').value = config.refinements || 0;
      document.getElementById('weapPity').value = config.weapPity || 0;
      document.getElementById('weapGuaranteed').value = config.weapGuaranteed || 'false';
      document.getElementById('fatepoints').value = config.fatepoints || 0;
      
      document.getElementById('simulations').value = config.simulations || 10000;
      document.getElementById('luckMode').value = config.luckMode || 'both';
      
      // Update UI based on loaded values
      toggleCharacterInputs();
      toggleWeaponInputs();
      updateResourceSummary();
      updateRadiancePityDisplay();
      
      alert('Configuration imported successfully!');
    } catch (error) {
      alert('Error importing configuration: Invalid file format.');
    }
  };
  reader.readAsText(file);
}

let lastSimulationResults = null;

function exportResults() {
  if (!lastSimulationResults) {
    alert('No simulation results to export. Please run a calculation first.');
    return;
  }
  
  const csvContent = generateCSV(lastSimulationResults);
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `genshin-simulation-results-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function generateCSV(results) {
  const headers = ['Simulation', 'Success', 'Total_Pulls', 'Character_Success', 'Weapon_Success', 'Characters_Obtained', 'Weapons_Obtained'];
  let csv = headers.join(',') + '\n';
  
  results.results.forEach((result, index) => {
    const row = [
      index + 1,
      result.success ? 'Yes' : 'No',
      result.totalPullsUsed,
      result.charSuccess ? 'Yes' : 'No',
      result.weapSuccess ? 'Yes' : 'No',
      result.charObtained,
      result.weapObtained
    ];
    csv += row.join(',') + '\n';
  });
  
  return csv;
}

// Enhanced chart creation with error handling
function createChart(simResults) {
  try {
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not loaded');
      return;
    }
    
    const canvas = document.getElementById('resultsChart');
    if (!canvas) {
      console.error('Chart canvas not found');
      return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error('Canvas context not available');
      return;
    }
    
    // Store results for export
    lastSimulationResults = simResults;
    document.getElementById('exportResultsBtn').disabled = false;
    
    // Destroy existing chart if it exists
    if (window.resultsChartInstance) {
      window.resultsChartInstance.destroy();
    }
    
    // Create histogram data from simulation results
    const pullsData = simResults.results.filter(r => r.success).map(r => r.totalPullsUsed);
    
    if (pullsData.length === 0) {
      console.log('No successful pulls to chart');
      return;
    }
    
    if (pullsData.length < 2) {
      console.log('Insufficient data for histogram');
      return;
    }
    
    // Find min and max for binning
    const min = Math.min(...pullsData);
    const max = Math.max(...pullsData);
    
    if (min === max) {
      console.log('All data points are identical, cannot create histogram');
      return;
    }
    
    // Create bins (10 bins between min and max)
    const binSize = Math.ceil((max - min) / 10) || 1;
    const bins = Array.from({length: 10}, (_, i) => min + i * binSize);
    
    // Count pulls in each bin
    const counts = Array(bins.length).fill(0);
    pullsData.forEach(pulls => {
      const binIndex = Math.min(Math.floor((pulls - min) / binSize), bins.length - 1);
      counts[binIndex]++;
    });
    
    // Convert counts to percentages
    const percentages = counts.map(count => (count / pullsData.length) * 100);
    
    // Create labels for x-axis
    const labels = bins.map((bin, i) => 
      i < bins.length - 1 ? 
      `${bin}-${bin + binSize - 1}` : 
      `${bin}+`
    );
    
    // Check if dark mode is active
    const isDarkMode = document.body.classList.contains('dark-mode');
    const textColor = isDarkMode ? '#e1e1e1' : '#333';
    
    // Create the chart
    window.resultsChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Distribution of Pulls Needed',
          data: percentages,
          backgroundColor: 'rgba(102, 126, 234, 0.6)',
          borderColor: 'rgba(102, 126, 234, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Distribution of Pulls Needed for Success',
            color: textColor,
            font: {
              size: 16
            }
          },
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.raw.toFixed(1)}% of successful attempts`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: textColor },
            title: {
              display: true,
              text: 'Percentage of Successful Attempts',
              color: textColor
            }
          },
          x: {
            ticks: { color: textColor },
            title: {
              display: true,
              text: 'Number of Pulls',
              color: textColor
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error creating chart:', error);
  }
}

// Modal functions
function openChangelogModal() {
  const modal = document.getElementById('changelogModal');
  if (modal) {
    modal.style.display = 'block';
    // Force repaint to ensure modal is visible
    setTimeout(function() {
      modal.style.opacity = '1';
    }, 10);
  } else {
    console.error('Changelog modal not found');
  }
}

function closeChangelogModal() {
  const modal = document.getElementById('changelogModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(function() {
      modal.style.display = 'none';
    }, 300); // Match the transition duration
  }
}

// Close modal when clicking outside of it
window.addEventListener('click', function(event) {
  const modal = document.getElementById('changelogModal');
  if (event.target === modal) {
    closeChangelogModal();
  }
});

// Ensure the modal can be opened and closed properly
document.addEventListener('DOMContentLoaded', function() {
  const versionLink = document.querySelector('.version-link');
  if (versionLink) {
    versionLink.addEventListener('click', function(e) {
      e.preventDefault();
      openChangelogModal();
    });
  }
});

// Update Radiance Pity display
function updateRadiancePityDisplay() {
  const radiancePity = document.getElementById('radiancePity').value;
  document.getElementById('radiancePityDisplay').textContent = `${radiancePity} / 3`;
}

// Auto-save inputs to localStorage
function autoSaveInputs() {
  const inputs = [
    'primos', 'fates', 'genesis', 'stardust', 'starglitter',
    'constellations', 'charPity', 'charGuaranteed', 'radiancePity',
    'refinements', 'weapPity', 'weapGuaranteed', 'fatepoints',
    'simulations', 'luckMode'
  ];
  
  const checkboxes = ['wantCharacter', 'wantWeapon'];
  
  const config = {};
  
  inputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      config[id] = element.value;
    }
  });
  
  checkboxes.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      config[id] = element.checked;
    }
  });
  
  localStorage.setItem('genshinAutoSave', JSON.stringify(config));
}

// Auto-load inputs from localStorage
function autoLoadInputs() {
  const savedData = localStorage.getItem('genshinAutoSave');
  
  if (!savedData) return;
  
  try {
    const config = JSON.parse(savedData);
    
    // Load regular inputs
    Object.keys(config).forEach(id => {
      const element = document.getElementById(id);
      if (element && typeof config[id] !== 'boolean') {
        element.value = config[id] || (element.type === 'number' ? '0' : '');
      }
    });
    
    // Load checkboxes
    if (typeof config.wantCharacter === 'boolean') {
      document.getElementById('wantCharacter').checked = config.wantCharacter;
    }
    if (typeof config.wantWeapon === 'boolean') {
      document.getElementById('wantWeapon').checked = config.wantWeapon;
    }
    
    // Update UI based on loaded values
    toggleCharacterInputs();
    toggleWeaponInputs();
    updateResourceSummary();
    updateRadiancePityDisplay();
  } catch (error) {
    console.log('Could not load auto-saved inputs:', error);
  }
}

// Add auto-save listeners to all inputs
function addAutoSaveListeners() {
  const inputs = document.querySelectorAll('input, select');
  inputs.forEach(input => {
    input.addEventListener('input', autoSaveInputs);
    input.addEventListener('change', autoSaveInputs);
  });
}

// Blog system functions
function loadBlogPosts() {
  if (!window.blogManager) {
    console.error('Blog manager not loaded');
    return;
  }
  
  populateTagFilter();
  filterPosts();
}

function populateTagFilter() {
  const tagSelect = document.getElementById('tagFilter');
  if (!tagSelect) return;
  
  // Clear existing options except "All Tags"
  const allTagsOption = tagSelect.querySelector('[value="all"]');
  tagSelect.innerHTML = '';
  tagSelect.appendChild(allTagsOption);
  
  // Get all unique tags from posts
  const allTags = [...new Set(window.blogManager.posts.flatMap(post => post.tags))];
  allTags.sort();
  
  allTags.forEach(tag => {
    const option = document.createElement('option');
    option.value = tag;
    option.textContent = tag;
    tagSelect.appendChild(option);
  });
}

function filterPosts() {
  if (!window.blogManager) return;
  
  const categoryFilter = document.getElementById('categoryFilter')?.value || 'all';
  const tagFilter = document.getElementById('tagFilter')?.value || 'all';
  const searchFilter = document.getElementById('searchPosts')?.value || '';
  
  const filteredPosts = window.blogManager.getPosts({
    category: categoryFilter,
    tag: tagFilter,
    search: searchFilter
  });
  
  renderBlogPosts(filteredPosts);
}

function renderBlogPosts(posts) {
  const container = document.getElementById('blogPostsContainer');
  const noResults = document.getElementById('noResultsMessage');
  
  if (!container) return;
  
  if (posts.length === 0) {
    container.style.display = 'none';
    if (noResults) noResults.style.display = 'block';
    return;
  }
  
  container.style.display = 'flex';
  if (noResults) noResults.style.display = 'none';
  
  container.innerHTML = '';
  
  posts.forEach(post => {
    const article = document.createElement('article');
    article.className = 'blog-article';
    
    const featuredBadge = post.featured ? '<div class="featured-badge">Featured</div>' : '';
    
    article.innerHTML = `
      ${featuredBadge}
      <h4>${escapeHtml(post.title)}</h4>
      
      <div class="article-meta">
        <div class="article-date">
          <i class="fas fa-calendar"></i>
          ${window.blogManager.formatDate(post.date)}
        </div>
        <div class="article-author">
          <i class="fas fa-user"></i>
          ${escapeHtml(post.author)}
        </div>
        <div class="article-date">
          <i class="fas fa-clock"></i>
          ${window.blogManager.getReadingTime(post.content)}
        </div>
      </div>
      
      <div class="article-summary">
        ${escapeHtml(post.summary)}
      </div>
      
      <div class="article-tags">
        ${post.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
      </div>
      
      <button class="read-more" onclick="openArticleModal('${post.id}')">
        Read Full Article
        <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
      </button>
    `;
    
    container.appendChild(article);
  });
}

function openArticleModal(postId) {
  const post = window.blogManager.getPost(postId);
  if (!post) {
    console.error('Post not found:', postId);
    return;
  }
  
  // Create modal if it doesn't exist
  let modal = document.getElementById('articleModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'articleModal';
    modal.className = 'modal';
    document.body.appendChild(modal);
  }
  
  const featuredBadge = post.featured ? '<div class="featured-badge" style="position: relative; top: 0; right: 0; margin-bottom: 10px; width: fit-content;">Featured Article</div>' : '';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <span class="close" onclick="closeArticleModal()">&times;</span>
      ${featuredBadge}
      <h2 style="color: var(--text-color); margin-top: ${post.featured ? '0' : '0'}; line-height: 1.3;">${escapeHtml(post.title)}</h2>
      
      <div class="article-meta" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
        <div class="article-date">
          <i class="fas fa-calendar"></i>
          ${window.blogManager.formatDate(post.date)}
        </div>
        <div class="article-author">
          <i class="fas fa-user"></i>
          ${escapeHtml(post.author)}
        </div>
        <div class="article-date">
          <i class="fas fa-clock"></i>
          ${window.blogManager.getReadingTime(post.content)}
        </div>
      </div>
      
      <div class="article-tags" style="margin-bottom: 20px;">
        ${post.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
      </div>
      
      <div class="article-content" style="line-height: 1.6; color: var(--text-color);">
        ${post.content}
      </div>
    </div>
  `;
  
  modal.style.display = 'block';
  setTimeout(() => {
    modal.style.opacity = '1';
  }, 10);
  
  // Close modal when clicking outside
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeArticleModal();
    }
  });
}

function closeArticleModal() {
  const modal = document.getElementById('articleModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Load saved language preference
  const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
  changeLanguage(savedLanguage);
  
  // Auto-load saved inputs first
  autoLoadInputs();
  
  // Then update resource summary and displays
  updateResourceSummary();
  updateRadiancePityDisplay();
  
  // Check for saved theme preference
  const savedDarkMode = localStorage.getItem('darkMode') === 'true';
  if (savedDarkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeSwitch').checked = true;
    // Only update settings theme switch if it exists
    const settingsThemeSwitch = document.getElementById('settingsThemeSwitch');
    if (settingsThemeSwitch) {
      settingsThemeSwitch.checked = true;
    }
  }
  
  // Add auto-save listeners
  addAutoSaveListeners();
  
  // Add keyboard shortcuts
  document.addEventListener('keydown', function(event) {
    // Ctrl+Enter to calculate
    if (event.ctrlKey && event.key === 'Enter') {
      event.preventDefault();
      calculate();
    }
    
    // Escape to close modal
    if (event.key === 'Escape') {
      closeChangelogModal();
    }
  });
  
  // Set up navigation click listeners at the end to ensure showPage() is defined
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const page = this.getAttribute('data-page');
      showPage(page);
    });
  });
});
</script>
</body>
</html>
