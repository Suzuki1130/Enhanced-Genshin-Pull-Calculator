<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Genshin Pull Calculator</title>
  <link rel="icon" href="Enhanced_Genshin_Pull_Calculator.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // Initialize Chart.js
    document.addEventListener('DOMContentLoaded', function() {
      // Chart will be initialized when needed in the createChart function
      console.log('Chart.js loaded and ready');
    });
  </script>
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --container-bg: rgba(255, 255, 255, 0.95);
      --section-bg: rgba(255, 255, 255, 0.8);
      --text-color: #333;
      --label-color: #555;
      --border-color: #e1e5e9;
      --progress-bg: #e1e5e9;
      --results-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --results-text: white;
      --chart-bg: white;
      --credits-color: #666;
    }
    
    body.dark-mode {
      --bg-gradient: linear-gradient(135deg, #1a1c2c 0%, #4a2c5d 100%);
      --container-bg: rgba(30, 32, 44, 0.95);
      --section-bg: rgba(40, 42, 54, 0.8);
      --text-color: #e1e1e1;
      --label-color: #bbb;
      --border-color: #444;
      --progress-bg: #444;
      --results-gradient: linear-gradient(135deg, #8052ec 0%, #d161ff 100%);
      --results-text: #e1e1e1;
      --chart-bg: #2a2c3a;
      --credits-color: #aaa;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
      background: var(--bg-gradient);
      min-height: 100vh;
      transition: all 0.3s ease;
    }

    .container {
      background: var(--container-bg);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 30px;
      font-size: 2.5em;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    input, select {
      padding: 12px;
      margin: 8px 0;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s;
      background-color: var(--container-bg);
      color: var(--text-color);
    }

    input:focus, select:focus {
      border-color: #667eea;
      outline: none;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: var(--section-bg);
      border-radius: 12px;
      border-left: 4px solid #667eea;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: background 0.3s ease;
    }

    .section h3 {
      margin-top: 0;
      color: var(--text-color);
      font-size: 1.4em;
      transition: color 0.3s ease;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
      color: var(--label-color);
      transition: color 0.3s ease;
    }

    .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      width: 100%;
      margin-top: 20px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .results {
      background: var(--results-gradient);
      color: var(--results-text);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
      background: var(--chart-bg);
      border-radius: 12px;
      padding: 15px;
      transition: background 0.3s ease;
    }

    .progress-bar {
      background: var(--progress-bg);
      border-radius: 10px;
      height: 20px;
      margin: 10px 0;
      overflow: hidden;
      transition: background 0.3s ease;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    /* Theme switcher styles */
    .theme-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .theme-switch-toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .theme-switch-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #667eea;
    }
    
    input:checked + .slider:before {
      transform: translateX(30px);
    }
    
    .theme-icon {
      margin: 0 8px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="loginContainer" style="display: none;" class="container">
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Enhanced Genshin Pull Calculator Logo" style="height: 80px; margin-right: 15px;">
      <h1 style="margin: 0;">Enhanced Genshin Pull Calculator</h1>
    </div>
    <div class="section">
      <h3>Login</h3>
      <div class="input-group">
        <div>
          <label for="username">Username:</label>
          <input type="text" id="username" placeholder="Enter your username">
        </div>
        <div>
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Enter your password">
        </div>
      </div>
      <button onclick="login()" style="margin-top: 20px;">Login</button>
      <p style="text-align: center; margin-top: 15px;">Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
      <div style="margin-top: 20px; padding: 10px; background-color: rgba(255, 255, 255, 0.2); border-radius: 8px; font-size: 0.9em;">
        <p style="margin: 0;"><strong>Note:</strong> This login system uses your browser's local storage. Your account and saved configurations are only available on this device and browser.</p>
      </div>
    </div>
  </div>
  
  <div id="registerContainer" style="display: none;" class="container">
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Enhanced Genshin Pull Calculator Logo" style="height: 80px; margin-right: 15px;">
      <h1 style="margin: 0;">Enhanced Genshin Pull Calculator</h1>
    </div>
    <div class="section">
      <h3>Register</h3>
      <div class="input-group">
        <div>
          <label for="newUsername">Username:</label>
          <input type="text" id="newUsername" placeholder="Choose a username">
        </div>
        <div>
          <label for="newPassword">Password:</label>
          <input type="password" id="newPassword" placeholder="Choose a password">
        </div>
        <div>
          <label for="confirmPassword">Confirm Password:</label>
          <input type="password" id="confirmPassword" placeholder="Confirm your password">
        </div>
      </div>
      <button onclick="register()" style="margin-top: 20px;">Register</button>
      <p style="text-align: center; margin-top: 15px;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
      <div style="margin-top: 20px; padding: 10px; background-color: rgba(255, 255, 255, 0.2); border-radius: 8px; font-size: 0.9em;">
        <p style="margin: 0;"><strong>Note:</strong> This login system uses your browser's local storage. Your account and saved configurations are only available on this device and browser.</p>
      </div>
    </div>
  </div>
  
  <div id="mainContainer" style="display: none;" class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div class="theme-switch">
        <span class="theme-icon">‚òÄÔ∏è</span>
        <label class="theme-switch-toggle">
          <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
          <span class="slider"></span>
        </label>
        <span class="theme-icon">üåô</span>
      </div>
      
      <div id="accountSection" style="display: flex; align-items: center;">
        <span style="margin-right: 10px; color: var(--text-color);">Logged in as: <span id="userDisplay"></span></span>
        <button onclick="logout()" style="margin: 0; width: auto; padding: 8px 15px;">Logout</button>
      </div>
    </div>
    

    
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
      <img src="Enhanced_Genshin_Pull_Calculator.png" alt="Enhanced Genshin Pull Calculator Logo" style="height: 80px; margin-right: 15px;">
      <h1 style="margin: 0;">Enhanced Genshin Pull Calculator</h1>
    </div>
      <div class="credits" style="text-align: center; font-size: 0.9em; margin-bottom: 20px; color: var(--credits-color);">
        Credits to Harry | Improvements by Trae AI
      </div>

    <div class="section">
      <h3>Resources</h3>
      <div class="input-group">
        <div>
          <label for="primos">Primogems:</label>
          <input type="number" id="primos" value="0" min="0" oninput="updateResourceSummary()">
        </div>
        <div>
          <label for="fates">Intertwined Fates:</label>
          <input type="number" id="fates" value="0" min="0" oninput="updateResourceSummary()">
        </div>
        <div>
          <label for="genesis">Genesis Crystals:</label>
          <input type="number" id="genesis" value="0" min="0" oninput="updateResourceSummary()">
        </div>
        <div>
          <label for="stardust">Masterless Stardust:</label>
          <input type="number" id="stardust" value="0" min="0" oninput="updateResourceSummary()">
        </div>
      </div>
      <div id="resourceSummary" class="cost-breakdown">
        <h4>Total Available Pulls: <span id="totalPulls">0</span></h4>
        <div class="primogem-breakdown">
          <div>Primos: <span id="primoPulls">0</span> pulls</div>
          <div>Fates: <span id="fatePulls">0</span> pulls</div>
          <div>Genesis: <span id="genesisPulls">0</span> pulls</div>
          <div>Stardust: <span id="stardustPulls">0</span> pulls</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Character Banner Goals</h3>
      <div class="checkbox-wrapper">
        <input type="checkbox" id="wantCharacter" onchange="toggleCharacterInputs()" checked>
        <label for="wantCharacter">I want to pull for a character</label>
      </div>
      <div id="characterInputs">
        <div class="input-group">
          <div>
            <label for="constellations">Constellation Goal:</label>
            <select id="constellations">
              <option value="0">C0 (Base Character)</option>
              <option value="1">C1</option>
              <option value="2">C2</option>
              <option value="3">C3</option>
              <option value="4">C4</option>
              <option value="5">C5</option>
              <option value="6">C6</option>
            </select>
          </div>
          <div>
            <label for="charPity">Character Pity:</label>
            <input type="number" id="charPity" min="0" max="89" value="0">
            <div class="progress-bar">
              <div id="charPityProgress" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <label for="charGuaranteed">Next Character Guaranteed?</label>
            <select id="charGuaranteed">
              <option value="false">No (50/50)</option>
              <option value="true">Yes (Guaranteed)</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="section">
      <h3>Weapon Banner Goals</h3>
      <div class="checkbox-wrapper">
        <input type="checkbox" id="wantWeapon" onchange="toggleWeaponInputs()">
        <label for="wantWeapon">I want to pull for a weapon</label>
      </div>
      <div id="weaponInputs" style="display: none;">
        <div class="input-group">
          <div>
            <label for="refinements">Refinement Goal:</label>
            <select id="refinements">
              <option value="0">R1 (Base Weapon)</option>
              <option value="1">R2</option>
              <option value="2">R3</option>
              <option value="3">R4</option>
              <option value="4">R5</option>
            </select>
          </div>
          <div>
            <label for="weapPity">Weapon Pity:</label>
            <input type="number" id="weapPity" min="0" max="79" value="0">
            <div class="progress-bar">
              <div id="weapPityProgress" class="progress-fill" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <label for="weapGuaranteed">Next Weapon Guaranteed?</label>
            <select id="weapGuaranteed">
              <option value="false">No (66.7% chance)</option>
              <option value="true">Yes (Guaranteed)</option>
            </select>
          </div>
          <div>
            <label for="fatepoints">Fate Points:</label>
            <select id="fatepoints">
              <option value="0">0 Points</option>
              <option value="1">1 Point (Next Guaranteed)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Simulation Settings</h3>
      <div class="input-group">
        <div>
          <label for="simulations">Number of Simulations:</label>
          <select id="simulations">
            <option value="1000">1,000 (Fast)</option>
            <option value="10000" selected>10,000 (Recommended)</option>
            <option value="100000">100,000 (Precise)</option>
          </select>
        </div>
        <div>
          <label for="luckMode">Analysis Mode:</label>
          <select id="luckMode">
            <option value="simulation">Monte Carlo Simulation</option>
            <option value="scenarios">Luck Scenarios</option>
            <option value="both" selected>Both</option>
          </select>
        </div>
      </div>

      <div style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 14px; line-height: 1.5;">
        <h4 style="margin: 0 0 10px 0; color: #333;">Analysis Mode Explanations:</h4>
        <p><strong>Monte Carlo Simulation:</strong> Runs thousands of random pull sessions to calculate realistic probability distributions. This method accounts for the randomness of gacha mechanics and provides statistical confidence intervals.</p>
        <p><strong>Luck Scenarios:</strong> Shows deterministic calculations for best-case (win all 50/50s), worst-case (lose all 50/50s), and expected outcomes. Useful for planning and budgeting.</p>
        <p><strong>Both:</strong> Combines simulation results with scenario analysis for comprehensive insights into your pulling strategy.</p>
      </div>
    </div>

    <button onclick="calculate()">Calculate Probabilities</button>

    <div id="results"></div>

    <div class="section">
      <div class="chart-container">
        <canvas id="resultsChart"></canvas>
      </div>
    </div>
    
    <div class="section">
      <h3>Save/Load Configuration</h3>
      <div class="input-group">
        <div>
          <button onclick="saveConfiguration()" style="margin-top: 0;">Save Current Configuration</button>
        </div>
        <div>
          <button onclick="loadConfiguration()" style="margin-top: 0;">Load Saved Configuration</button>
        </div>
      </div>
    </div>
    

  </div>
<script>
// Display username in account section
function updateUserDisplay() {
  const currentUser = localStorage.getItem('currentUser');
  if (currentUser) {
    document.getElementById('userDisplay').textContent = currentUser;
  }
}
class GenshinCalculator {
  constructor() {
    this.baseRates = {
      character: { fiveStar: 0.006, fourStar: 0.051 },
      weapon: { fiveStar: 0.007, fourStar: 0.06 }
    };
    this.hardPity = { character: 90, weapon: 80 };
    this.softPityStart = { character: 74, weapon: 63 };
  }

  getPullProbability(pity, banner) {
    const baseRate = this.baseRates[banner].fiveStar;
    const softStart = this.softPityStart[banner];
    const hardLimit = this.hardPity[banner];
    if (pity >= hardLimit - 1) return 1.0;
    if (pity < softStart) return baseRate;
    const softPityProgress = (pity - softStart + 1) / (hardLimit - softStart);
    return Math.min(baseRate + (1 - baseRate) * Math.pow(softPityProgress, 2), 1.0);
  }

  simulateSession(banner, goal, currentPity, isGuaranteed, fatePoints, availablePulls) {
    let pity = currentPity, guaranteed = isGuaranteed, weaponPoints = fatePoints;
    let pullsUsed = 0, fiveStarsObtained = 0, targetObtained = 0;
    while (targetObtained < goal && pullsUsed < availablePulls) {
      pullsUsed++;
      pity++;
      const pullProb = this.getPullProbability(pity - 1, banner);
      const gotFiveStar = Math.random() < pullProb;
      if (gotFiveStar) {
        fiveStarsObtained++;
        pity = 0;
        if (banner === 'character') {
          if (guaranteed || Math.random() < 0.5) {
            targetObtained++; guaranteed = false;
          } else guaranteed = true;
        } else {
          if (weaponPoints >= 1 || Math.random() < 1/3) {
            targetObtained++; weaponPoints = 0;
          } else weaponPoints++;
        }
      }
    }
    return {
      success: targetObtained >= goal,
      pullsUsed,
      fiveStarsObtained,
      finalPity: pity,
      finalGuaranteed: guaranteed,
      finalWeaponPoints: weaponPoints
    };
  }

  simulateCombinedSession(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls) {
    let totalPullsUsed = 0, charObtained = 0, weapObtained = 0;
    if (charGoal > 0) {
      const charResult = this.simulateSession('character', charGoal, charPity, charGuaranteed, 0, availablePulls);
      charObtained = Math.min(charGoal, charResult.fiveStarsObtained);
      totalPullsUsed += charResult.pullsUsed;
    }
    if (weapGoal > 0 && totalPullsUsed < availablePulls) {
      const weapResult = this.simulateSession('weapon', weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls - totalPullsUsed);
      weapObtained = Math.min(weapGoal, weapResult.fiveStarsObtained);
      totalPullsUsed += weapResult.pullsUsed;
    }
    return {
      success: charObtained >= charGoal && weapObtained >= weapGoal,
      totalPullsUsed,
      charObtained,
      weapObtained,
      charSuccess: charObtained >= charGoal,
      weapSuccess: weapObtained >= weapGoal
    };
  }

  runCombinedSimulation(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls, numSims) {
    const results = [];
    let fullSuccess = 0, charSuccess = 0, weapSuccess = 0;
    for (let i = 0; i < numSims; i++) {
      const res = this.simulateCombinedSession(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, weaponPoints, availablePulls);
      results.push(res);
      if (res.success) fullSuccess++;
      if (res.charSuccess || charGoal === 0) charSuccess++;
      if (res.weapSuccess || weapGoal === 0) weapSuccess++;
    }
    const successful = results.filter(r => r.success).map(r => r.totalPullsUsed);
    return {
      fullSuccessRate: fullSuccess / numSims,
      charSuccessRate: charSuccess / numSims,
      weapSuccessRate: weapSuccess / numSims,
      averagePulls: successful.length ? successful.reduce((a,b)=>a+b)/successful.length : 0,
      medianPulls: successful.length ? this.median(successful) : 0,
      percentile90: successful.length ? this.percentile(successful, 0.9) : 0,
      percentile10: successful.length ? this.percentile(successful, 0.1) : 0,
      results
    };
  }

  calculateExpectedPulls(banner, goal, pity, guaranteed, points) {
    const expected = banner === 'character'
      ? (guaranteed ? 75 : 112.5)
      : points >= 2 ? 65 : points === 1 ? 85 : 105;
    return Math.ceil((expected * goal) - pity);
  }

  calculateScenario(banner, goal, pity, guaranteed, points, mode) {
    let total = 0, current = pity, guaranteedFlag = guaranteed, fate = points, obtained = 0;
    while (obtained < goal) {
      if (mode === 'win_all') {
        total += this.getExpectedPullsToNext(banner, current);
        current = 0; guaranteedFlag = false; fate = 0; obtained++;
      } else if (mode === 'lose_all') {
        if (!guaranteedFlag && banner === 'character') {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; guaranteedFlag = true;
        } else if (banner === 'weapon' && fate < 1) {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; fate++;
        } else {
          total += this.getExpectedPullsToNext(banner, current);
          current = 0; guaranteedFlag = false; fate = 0; obtained++;
        }
      }
    }
    return Math.ceil(total);
  }

  calculateCombinedScenarios(charGoal, charPity, charGuaranteed, weapGoal, weapPity, weapGuaranteed, fatePoints) {
    const s = {};
    s.charBest = charGoal ? this.calculateScenario('character', charGoal, charPity, true, 0, 'win_all') : 0;
    s.charWorst = charGoal ? this.calculateScenario('character', charGoal, charPity, charGuaranteed, 0, 'lose_all') : 0;
    s.charExpected = charGoal ? this.calculateExpectedPulls('character', charGoal, charPity, charGuaranteed, 0) : 0;
    s.weapBest = weapGoal ? this.calculateScenario('weapon', weapGoal, weapPity, true, fatePoints, 'win_all') : 0;
    s.weapWorst = weapGoal ? this.calculateScenario('weapon', weapGoal, weapPity, weapGuaranteed, fatePoints, 'lose_all') : 0;
    s.weapExpected = weapGoal ? this.calculateExpectedPulls('weapon', weapGoal, weapPity, weapGuaranteed, fatePoints) : 0;
    s.combinedBest = s.charBest + s.weapBest;
    s.combinedWorst = s.charWorst + s.weapWorst;
    s.combinedExpected = s.charExpected + s.weapExpected;
    return s;
  }

  getExpectedPullsToNext(banner, pity) {
    return pity >= this.softPityStart[banner]
      ? Math.min(5, this.hardPity[banner] - pity)
      : banner === 'character' ? 75 : 65;
  }

  median(arr) {
    const s = arr.slice().sort((a, b) => a - b);
    const m = Math.floor(s.length / 2);
    return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
  }

  percentile(arr, p) {
    const s = arr.slice().sort((a, b) => a - b);
    const i = p * (s.length - 1), l = Math.floor(i), u = Math.ceil(i);
    return s[l] * (u - i) + s[u] * (i - l);
  }
}

const calculator = new GenshinCalculator();

function updateResourceSummary() {
  const p = +document.getElementById('primos').value || 0;
  const f = +document.getElementById('fates').value || 0;
  const g = +document.getElementById('genesis').value || 0;
  const s = +document.getElementById('stardust').value || 0;
  const pp = Math.floor(p / 160), fp = f, gp = Math.floor(g / 160), sp = Math.floor(s / 75);
  const total = pp + fp + gp + sp;
  document.getElementById('primoPulls').textContent = pp;
  document.getElementById('fatePulls').textContent = fp;
  document.getElementById('genesisPulls').textContent = gp;
  document.getElementById('stardustPulls').textContent = sp;
  document.getElementById('totalPulls').textContent = total;
  updatePityProgress();
}

function updatePityProgress() {
  const char = +document.getElementById('charPity').value || 0;
  const weap = +document.getElementById('weapPity').value || 0;
  document.getElementById('charPityProgress').style.width = (char / 90 * 100) + '%';
  document.getElementById('weapPityProgress').style.width = (weap / 80 * 100) + '%';
}

function toggleCharacterInputs() {
  const checked = document.getElementById('wantCharacter').checked;
  document.getElementById('characterInputs').style.display = checked ? 'block' : 'none';
}

function toggleWeaponInputs() {
  const checked = document.getElementById('wantWeapon').checked;
  document.getElementById('weaponInputs').style.display = checked ? 'block' : 'none';
}

function calculate() {
  const totalPulls = +document.getElementById('totalPulls').textContent;
  const wantChar = document.getElementById('wantCharacter').checked;
  const wantWeap = document.getElementById('wantWeapon').checked;
  const charGoal = wantChar ? +document.getElementById('constellations').value + 1 : 0;
  const weapGoal = wantWeap ? +document.getElementById('refinements').value + 1 : 0;
  const charPity = +document.getElementById('charPity').value || 0;
  const weapPity = +document.getElementById('weapPity').value || 0;
  const charGuaranteed = document.getElementById('charGuaranteed').value === 'true';
  const weapGuaranteed = document.getElementById('weapGuaranteed').value === 'true';
  const fatePoints = +document.getElementById('fatepoints').value;
  const numSims = +document.getElementById('simulations').value;
  const mode = document.getElementById('luckMode').value;

  let output = '<div class="results">';
  
  if (mode === 'simulation' || mode === 'both') {
    const simResults = calculator.runCombinedSimulation(
      charGoal, charPity, charGuaranteed,
      weapGoal, weapPity, weapGuaranteed,
      fatePoints, totalPulls, numSims
    );

    output += '<h3>Monte Carlo Simulation Results</h3>';
    if (wantChar) {
      output += `<p>Character Success Rate: ${(simResults.charSuccessRate * 100).toFixed(1)}%</p>`;
    }
    if (wantWeap) {
      output += `<p>Weapon Success Rate: ${(simResults.weapSuccessRate * 100).toFixed(1)}%</p>`;
    }
    if (wantChar && wantWeap) {
      output += `<p>Overall Success Rate: ${(simResults.fullSuccessRate * 100).toFixed(1)}%</p>`;
    }
    
    if (simResults.averagePulls > 0) {
      output += `<p>For successful attempts:</p>`;
      output += `<ul>`;
      output += `<li>Average pulls needed: ${Math.round(simResults.averagePulls)}</li>`;
      output += `<li>Median pulls needed: ${Math.round(simResults.medianPulls)}</li>`;
      output += `<li>10th percentile (Lucky): ${Math.round(simResults.percentile10)}</li>`;
      output += `<li>90th percentile (Unlucky): ${Math.round(simResults.percentile90)}</li>`;
      output += `</ul>`;
    }
    
    // Create chart for simulation results
    createChart(simResults);
  }

  if (mode === 'scenarios' || mode === 'both') {
    const scenarios = calculator.calculateCombinedScenarios(
      charGoal, charPity, charGuaranteed,
      weapGoal, weapPity, weapGuaranteed,
      fatePoints
    );

    output += '<h3>Luck Scenarios</h3>';
    if (wantChar) {
      output += '<h4>Character Banner</h4>';
      output += `<ul>`;
      output += `<li>Best case (win all 50/50): ${scenarios.charBest} pulls</li>`;
      output += `<li>Expected case: ${scenarios.charExpected} pulls</li>`;
      output += `<li>Worst case (lose all 50/50): ${scenarios.charWorst} pulls</li>`;
      output += `</ul>`;
    }
    if (wantWeap) {
      output += '<h4>Weapon Banner</h4>';
      output += `<ul>`;
      output += `<li>Best case: ${scenarios.weapBest} pulls</li>`;
      output += `<li>Expected case: ${scenarios.weapExpected} pulls</li>`;
      output += `<li>Worst case: ${scenarios.weapWorst} pulls</li>`;
      output += `</ul>`;
    }
    if (wantChar && wantWeap) {
      output += '<h4>Combined Total</h4>';
      output += `<ul>`;
      output += `<li>Best case: ${scenarios.combinedBest} pulls</li>`;
      output += `<li>Expected case: ${scenarios.combinedExpected} pulls</li>`;
      output += `<li>Worst case: ${scenarios.combinedWorst} pulls</li>`;
      output += `</ul>`;
    }
  }

  output += '</div>';
  document.getElementById('results').innerHTML = output;
}
function createChart(simResults) {
  // Get the canvas element
  const ctx = document.getElementById('resultsChart').getContext('2d');
  
  // Destroy existing chart if it exists
  if (window.resultsChartInstance) {
    window.resultsChartInstance.destroy();
  }
  
  // Create histogram data from simulation results
  const pullsData = simResults.results.filter(r => r.success).map(r => r.totalPullsUsed);
  
  if (pullsData.length === 0) {
    return; // No successful pulls to chart
  }
  
  // Find min and max for binning
  const min = Math.min(...pullsData);
  const max = Math.max(...pullsData);
  
  // Create bins (10 bins between min and max)
  const binSize = Math.ceil((max - min) / 10);
  const bins = Array.from({length: 10}, (_, i) => min + i * binSize);
  
  // Count pulls in each bin
  const counts = Array(bins.length).fill(0);
  pullsData.forEach(pulls => {
    const binIndex = Math.min(Math.floor((pulls - min) / binSize), bins.length - 1);
    counts[binIndex]++;
  });
  
  // Convert counts to percentages
  const percentages = counts.map(count => (count / pullsData.length) * 100);
  
  // Create labels for x-axis
  const labels = bins.map((bin, i) => 
    i < bins.length - 1 ? 
    `${bin}-${bin + binSize - 1}` : 
    `${bin}+`
  );
  
  // Check if dark mode is active
  const isDarkMode = document.body.classList.contains('dark-mode');
  const textColor = isDarkMode ? '#e1e1e1' : '#333';
  
  // Create the chart
  window.resultsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Distribution of Pulls Needed',
        data: percentages,
        backgroundColor: 'rgba(102, 126, 234, 0.6)',
        borderColor: 'rgba(102, 126, 234, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Distribution of Pulls Needed for Success',
          color: textColor,
          font: {
            size: 16
          }
        },
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.raw.toFixed(1)}% of successful attempts`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: textColor },
          title: {
            display: true,
            text: 'Percentage of Successful Attempts',
            color: textColor
          }
        },
        x: {
          ticks: { color: textColor },
          title: {
            display: true,
            text: 'Number of Pulls',
            color: textColor
          }
        }
      }
    }
  });
}

function saveConfiguration() {
  const config = {
    primos: document.getElementById('primos').value,
    fates: document.getElementById('fates').value,
    genesis: document.getElementById('genesis').value,
    stardust: document.getElementById('stardust').value,
    wantCharacter: document.getElementById('wantCharacter').checked,
    constellations: document.getElementById('constellations').value,
    charPity: document.getElementById('charPity').value,
    charGuaranteed: document.getElementById('charGuaranteed').value,
    wantWeapon: document.getElementById('wantWeapon').checked,
    refinements: document.getElementById('refinements').value,
    weapPity: document.getElementById('weapPity').value,
    weapGuaranteed: document.getElementById('weapGuaranteed').value,
    fatepoints: document.getElementById('fatepoints').value,
    simulations: document.getElementById('simulations').value,
    luckMode: document.getElementById('luckMode').value
  };
  
  localStorage.setItem('genshinWishConfig', JSON.stringify(config));
  alert('Configuration saved successfully!');
}

function loadConfiguration() {
  const savedConfig = localStorage.getItem('genshinWishConfig');
  
  if (!savedConfig) {
    alert('No saved configuration found.');
    return;
  }
  
  const config = JSON.parse(savedConfig);
  
  // Load values into form
  document.getElementById('primos').value = config.primos || 0;
  document.getElementById('fates').value = config.fates || 0;
  document.getElementById('genesis').value = config.genesis || 0;
  document.getElementById('stardust').value = config.stardust || 0;
  
  document.getElementById('wantCharacter').checked = config.wantCharacter;
  document.getElementById('constellations').value = config.constellations || 0;
  document.getElementById('charPity').value = config.charPity || 0;
  document.getElementById('charGuaranteed').value = config.charGuaranteed || 'false';
  
  document.getElementById('wantWeapon').checked = config.wantWeapon;
  document.getElementById('refinements').value = config.refinements || 0;
  document.getElementById('weapPity').value = config.weapPity || 0;
  document.getElementById('weapGuaranteed').value = config.weapGuaranteed || 'false';
  document.getElementById('fatepoints').value = config.fatepoints || 0;
  
  document.getElementById('simulations').value = config.simulations || 10000;
  document.getElementById('luckMode').value = config.luckMode || 'both';
  
  // Update UI based on loaded values
  toggleCharacterInputs();
  toggleWeaponInputs();
  updateResourceSummary();
  
  alert('Configuration loaded successfully!');
}

// Theme switcher function
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDarkMode = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', isDarkMode);
  
  // Update chart if it exists
  if (window.resultsChartInstance) {
    updateChartTheme(isDarkMode);
  }
}

function updateChartTheme(isDarkMode) {
  if (!window.resultsChartInstance) return;
  
  const textColor = isDarkMode ? '#e1e1e1' : '#333';
  
  window.resultsChartInstance.options.scales.x.ticks.color = textColor;
  window.resultsChartInstance.options.scales.y.ticks.color = textColor;
  window.resultsChartInstance.options.scales.x.title.color = textColor;
  window.resultsChartInstance.options.scales.y.title.color = textColor;
  window.resultsChartInstance.options.plugins.title.color = textColor;
  
  window.resultsChartInstance.update();
}

// User authentication functions
function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  if (!username || !password) {
    alert('Please enter both username and password');
    return;
  }
  
  const users = JSON.parse(localStorage.getItem('genshinUsers') || '{}');
  
  if (users[username] && users[username].password === password) {
    // Login successful
    localStorage.setItem('currentUser', username);
    showMainApp();
    
    // Load user-specific configuration if available
    const userConfig = users[username].config;
    if (userConfig) {
      loadUserConfiguration(userConfig);
    }
  } else {
    alert('Invalid username or password');
  }
}

function register() {
  const username = document.getElementById('newUsername').value;
  const password = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (!username || !password || !confirmPassword) {
    alert('Please fill in all fields');
    return;
  }
  
  if (password !== confirmPassword) {
    alert('Passwords do not match');
    return;
  }
  
  const users = JSON.parse(localStorage.getItem('genshinUsers') || '{}');
  
  if (users[username]) {
    alert('Username already exists');
    return;
  }
  
  // Create new user
  users[username] = {
    password: password,
    config: null
  };
  
  localStorage.setItem('genshinUsers', JSON.stringify(users));
  localStorage.setItem('currentUser', username);
  
  alert('Registration successful!');
  showMainApp();
}

function logout() {
  localStorage.removeItem('currentUser');
  showLogin();
}

function showLogin() {
  document.getElementById('loginContainer').style.display = 'block';
  document.getElementById('registerContainer').style.display = 'none';
  document.getElementById('mainContainer').style.display = 'none';
}

function showRegister() {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('registerContainer').style.display = 'block';
  document.getElementById('mainContainer').style.display = 'none';
}

function showMainApp() {
  document.getElementById('loginContainer').style.display = 'none';
  document.getElementById('registerContainer').style.display = 'none';
  document.getElementById('mainContainer').style.display = 'block';
  updateUserDisplay();
}

// Modified save/load configuration to be user-specific
function saveConfiguration() {
  const config = {
    primos: document.getElementById('primos').value,
    fates: document.getElementById('fates').value,
    genesis: document.getElementById('genesis').value,
    stardust: document.getElementById('stardust').value,
    wantCharacter: document.getElementById('wantCharacter').checked,
    constellations: document.getElementById('constellations').value,
    charPity: document.getElementById('charPity').value,
    charGuaranteed: document.getElementById('charGuaranteed').value,
    wantWeapon: document.getElementById('wantWeapon').checked,
    refinements: document.getElementById('refinements').value,
    weapPity: document.getElementById('weapPity').value,
    weapGuaranteed: document.getElementById('weapGuaranteed').value,
    fatepoints: document.getElementById('fatepoints').value,
    simulations: document.getElementById('simulations').value,
    luckMode: document.getElementById('luckMode').value
  };
  
  // Save to general storage for backward compatibility
  localStorage.setItem('genshinWishConfig', JSON.stringify(config));
  
  // Save to user-specific storage
  const currentUser = localStorage.getItem('currentUser');
  if (currentUser) {
    const users = JSON.parse(localStorage.getItem('genshinUsers') || '{}');
    if (users[currentUser]) {
      users[currentUser].config = config;
      localStorage.setItem('genshinUsers', JSON.stringify(users));
    }
  }
  
  alert('Configuration saved successfully!');
}

function loadConfiguration() {
  const currentUser = localStorage.getItem('currentUser');
  let config;
  
  if (currentUser) {
    const users = JSON.parse(localStorage.getItem('genshinUsers') || '{}');
    if (users[currentUser] && users[currentUser].config) {
      config = users[currentUser].config;
    }
  }
  
  // Fall back to general storage if no user-specific config
  if (!config) {
    const savedConfig = localStorage.getItem('genshinWishConfig');
    if (!savedConfig) {
      alert('No saved configuration found.');
      return;
    }
    config = JSON.parse(savedConfig);
  }
  
  loadUserConfiguration(config);
  alert('Configuration loaded successfully!');
}

function loadUserConfiguration(config) {
  // Load values into form
  document.getElementById('primos').value = config.primos || 0;
  document.getElementById('fates').value = config.fates || 0;
  document.getElementById('genesis').value = config.genesis || 0;
  document.getElementById('stardust').value = config.stardust || 0;
  
  document.getElementById('wantCharacter').checked = config.wantCharacter;
  document.getElementById('constellations').value = config.constellations || 0;
  document.getElementById('charPity').value = config.charPity || 0;
  document.getElementById('charGuaranteed').value = config.charGuaranteed || 'false';
  
  document.getElementById('wantWeapon').checked = config.wantWeapon;
  document.getElementById('refinements').value = config.refinements || 0;
  document.getElementById('weapPity').value = config.weapPity || 0;
  document.getElementById('weapGuaranteed').value = config.weapGuaranteed || 'false';
  document.getElementById('fatepoints').value = config.fatepoints || 0;
  
  document.getElementById('simulations').value = config.simulations || 10000;
  document.getElementById('luckMode').value = config.luckMode || 'both';
  
  // Update UI based on loaded values
  toggleCharacterInputs();
  toggleWeaponInputs();
  updateResourceSummary();
}

// Initialize the app when the page loads
document.addEventListener('DOMContentLoaded', function() {
  updateResourceSummary();
  
  // Check for saved theme preference
  const savedDarkMode = localStorage.getItem('darkMode') === 'true';
  if (savedDarkMode) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeSwitch').checked = true;
  }
  
  // Check if user is logged in
  const currentUser = localStorage.getItem('currentUser');
  if (currentUser) {
    showMainApp();
  } else {
    showLogin();
  }
});
</script>
</body>
</html>
